<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TabApp Pro v3.78</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root{
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text); overflow-x: hidden;}
    
    header{ background:var(--card); border-bottom:1px solid var(--line); padding: 15px 0; width: 100%; }
    h1{ font-size: 20px; margin: 0; text-align: center; color: var(--text); }

    .wrap{ padding: 10px; max-width: 1200px; margin: 0 auto; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 768px){ .grid{grid-template-columns: 1fr 1fr;} }

    .card{ background:rgba(255,255,255,.02); border:1px solid var(--line); border-radius:var(--radius); margin-bottom:10px; overflow: hidden;}
    .card .hd{ padding:12px; border-bottom:1px solid var(--line); font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 14px;}
    .card .bd{ padding:10px; }

    .btn{ appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text); padding:10px; border-radius:10px; cursor:pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; min-width: 44px;}
    .btn:active{ transform: scale(0.94); }
    .btn.accent{ border-color: var(--accent); color: var(--accent); background: rgba(255,213,74,0.05); }
    .btn.danger{ border-color: var(--danger); color: var(--danger); min-width: 32px; padding: 5px; }

    .input{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:rgba(0,0,0,.3); color:white; outline:none; font-size: 16px; }
    
    .item{ border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center; margin-bottom: 6px; cursor: grab; font-size: 14px;}
    
    /* Herramientas Optimizadas para MÃ³vil */
    .viewer-tools { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
    .tool-group { display: flex; gap: 6px; justify-content: center; align-items: center; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 12px; border: 1px solid var(--line); }
    
    #viewContent { background: rgba(0,0,0,.4); padding: 20px 10px; border-radius: 12px; white-space: pre-wrap; font-family: var(--mono); line-height: 1.6; border: 1px solid var(--line); }
    .chord{ color:var(--accent); font-weight:bold; }
  </style>
</head>
<body>

<header>
  <div class="wrap">
      <h1>ðŸŽ¸ TabApp Pro v3.78</h1>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd">Buscador</div>
      <div class="bd">
        <input class="input" id="searchDrive" placeholder="Buscar canciÃ³n..." autocomplete="off" />
        <div id="driveResults" style="margin-top:10px; display:none; flex-direction:column; gap:8px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">Setlist <button class="btn accent" style="min-width:auto; padding: 4px 8px; font-size: 11px;" onclick="clearSetlist()">Vaciar</button></div>
      <div class="bd" id="setList"></div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <div class="hd" id="viewTitle" style="color:var(--accent); justify-content: center;">Selecciona una canciÃ³n</div>
      <div class="bd">
        <div class="viewer-tools">
          <div class="tool-group">
            <button class="btn" onclick="prevSong()">âŸµ</button>
            <button class="btn" onclick="nextSong()">âŸ¶</button>
          </div>
          <div class="tool-group">
            <button class="btn accent" onclick="transpose(-1)">â™­</button>
            <button class="btn accent" onclick="transpose(1)">â™¯</button>
          </div>
          <div class="tool-group">
            <button class="btn" onclick="changeFontSize(-2)">A-</button>
            <button class="btn" onclick="changeFontSize(2)">A+</button>
          </div>
          <div class="tool-group">
            <button class="btn" onclick="adjScroll(-0.1)">S-</button>
            <button class="btn accent" id="scrollBtn" onclick="toggleScroll()">â–¶</button>
            <button class="btn" onclick="adjScroll(0.1)">S+</button>
          </div>
        </div>
        <div id="speedLabel" style="text-align:center; font-size:10px; color:var(--muted); margin-bottom:10px;">Velocidad: 0.5x</div>
        <pre id="viewContent"></pre>
      </div>
    </section>
  </div>
</main>

<script>
  // Tu API KEY y FOLDER ID originales
  const API_KEY = 'AIzaSyC74SgLN0OFD8zytCktOTCyVdRZZmdL-S0';
  const FOLDER_ID = '1x6zy_Bor6i9qBhUIl27ZIG0E1qdf5Ye6';
  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_setlist') || '[]'),
    allSongs: [], currentIndex: -1, currentFontSize: 16,
    scrollInt: null, scrollSpeed: 0.5
  };

  const normalizar = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  function startApp() {
    gapi.load('client', async () => {
      try {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
        await cargarBiblioteca();
        renderAll();
        initSortable();
      } catch (e) { console.error("Error Drive"); }
    });
  }

  async function cargarBiblioteca() {
    const res = await gapi.client.drive.files.list({
      q: `'${FOLDER_ID}' in parents and trashed = false`,
      fields: 'files(id, name)', orderBy: 'name', pageSize: 1000
    });
    state.allSongs = res.result.files || [];
  }

  document.getElementById('searchDrive').oninput = (e) => {
    const val = normalizar(e.target.value);
    const resDiv = document.getElementById('driveResults');
    if (!val) { resDiv.style.display = "none"; return; }
    const filtrados = state.allSongs.filter(f => normalizar(f.name).includes(val));
    resDiv.style.display = "flex"; resDiv.innerHTML = "";
    filtrados.forEach(f => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span>${f.name.replace('.txt','')}</span><button class="btn accent" style="padding:4px 8px; min-width:auto;" onclick="importar('${f.id}', '${f.name}')">Add</button>`;
      resDiv.appendChild(div);
    });
  };

  async function importar(id, name) {
    const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`);
    const text = await resp.text();
    state.setlist.push({ id: Date.now(), title: name.replace('.txt',''), body: text });
    saveLocal(); renderAll();
    document.getElementById('searchDrive').value = "";
    document.getElementById('driveResults').style.display = "none";
  }

  const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  function transpose(delta) {
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;
    curr.body = curr.body.replace(/\[([^\]]+)\]/g, (match, chord) => {
      return "[" + chord.replace(/[A-G]#?/g, (note) => {
        let idx = scale.indexOf(note);
        return idx === -1 ? note : scale[(idx + delta + 12) % 12];
      }) + "]";
    });
    renderAll();
  }

  function toggleScroll() {
    const btn = document.getElementById('scrollBtn');
    if (state.scrollInt) {
      clearInterval(state.scrollInt); state.scrollInt = null;
      btn.innerText = "â–¶";
    } else {
      btn.innerText = "â¸";
      state.scrollInt = setInterval(() => { window.scrollBy(0, 1); }, 50 / state.scrollSpeed);
    }
  }

  function adjScroll(delta) {
    state.scrollSpeed = Math.max(0.1, Math.min(3, state.scrollSpeed + delta));
    document.getElementById('speedLabel').innerText = "Velocidad: " + state.scrollSpeed.toFixed(1) + "x";
    if (state.scrollInt) { toggleScroll(); toggleScroll(); }
  }

  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      if(idx === state.currentIndex) div.style.borderColor = 'var(--accent)';
      div.innerHTML = `<div style="flex:1" onclick="seleccionar(${idx})">â˜° ${s.title}</div>
                       <button class="btn danger" onclick="removeSong(${idx}, event)">âœ•</button>`;
      sl.appendChild(div);
    });
    const curr = state.setlist[state.currentIndex];
    document.getElementById('viewTitle').innerText = curr ? curr.title : "Selecciona una canciÃ³n";
    document.getElementById('viewContent').innerHTML = curr ? curr.body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>') : "";
    document.getElementById('viewContent').style.fontSize = state.currentFontSize + 'px';
  }

  function seleccionar(idx) { state.currentIndex = idx; renderAll(); window.scrollTo({top: document.getElementById('viewTitle').offsetTop - 20, behavior: 'smooth'});}
  function removeSong(idx, e) { e.stopPropagation(); state.setlist.splice(idx, 1); state.currentIndex = -1; saveLocal(); renderAll(); }
  function clearSetlist() { if(confirm("Â¿Vaciar?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function saveLocal() { localStorage.setItem('tabs_setlist', JSON.stringify(state.setlist)); }
  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }
  function nextSong() { if(state.currentIndex < state.setlist.length-1) seleccionar(state.currentIndex+1); }
  function prevSong() { if(state.currentIndex > 0) seleccionar(state.currentIndex-1); }

  function initSortable() {
    Sortable.create(document.getElementById('setList'), {
      animation: 150, handle: '.item',
      onEnd: (evt) => {
        const item = state.setlist.splice(evt.oldIndex, 1)[0];
        state.setlist.splice(evt.newIndex, 0, item);
        state.currentIndex = evt.newIndex;
        saveLocal(); renderAll();
      }
    });
  }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="startApp()"></script>
</body>
</html>
