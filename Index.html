<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>2.28 Adoranza Pro v4.16 - Full Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --success:#4aff80; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--sans); background: var(--bg); color: var(--text); overflow-x: hidden; padding-top: 240px; }
    
    #roleSelector { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
    .role-grid { display: grid; gap: 14px; grid-template-columns: repeat(2, 1fr); width: min(95vw, 400px); }
    .role-btn { background: var(--card); border: 2px solid var(--line); padding: 15px 10px; border-radius: 20px; text-align: center; font-size: 28px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
    .role-btn:hover { border-color: var(--accent); transform: translateY(-5px); }
    .role-btn small { font-size: 10px; margin-top: 8px; color: var(--muted); font-weight: bold; line-height: 1.2; text-transform: uppercase; }
    .footer-credits { position: absolute; bottom: 20px; font-size: 12px; color: var(--muted); text-align: center; }
    .footer-credits a { color: var(--accent); text-decoration: none; font-weight: bold; }

    #fixedControlPanel { position: fixed; top: 0; left: 0; right: 0; z-index: 999; background: rgba(11, 13, 18, 0.98); backdrop-filter: blur(10px); border-bottom: 2px solid var(--line); padding: 12px 10px; }
    .viewer-tools { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
    .tool-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; justify-content: center; align-items: center; padding: 4px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.02); }
    .tool-group.triple { grid-template-columns: repeat(3, 1fr); grid-column: span 2; }
    .btn { border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px 5px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; width: 100%; max-width: 100px; margin: 0 auto; height: 40px; }
    .btn-nav { background-color: #004173 !important; }
    .btn-tone { background-color: #630b57 !important; }
    .btn-font { background-color: #2E6F40 !important; }
    .btn-scroll { background-color: #d09306 !important; }
    .btn-drums { background-color: #444 !important; border-color: var(--success); color: var(--success); }
    .btn-save { background-color: #1a1a1a; border-color: var(--success); color: var(--success); }
    .btn-wa { background-color: #075e54; border-color: #25d366; color: white; }
    .btn.danger-x { border-color: var(--danger); color: var(--danger); background: rgba(255, 92, 119, 0.1); max-width: 40px; }

    /* Swipe Logic Styles */
    .item-container { position: relative; overflow: hidden; border-radius: 12px; margin-bottom: 8px; }
    .item { 
      position: relative; z-index: 2; border: 1px solid var(--line); border-radius: 12px; padding: 12px; 
      background: #1a1f2e; display: flex; justify-content: space-between; align-items: center; 
      transition: transform 0.2s ease; touch-action: pan-y;
    }
    .item.played { opacity: 0.3; filter: grayscale(1); transform: translateX(10px); }
    .swipe-action { position: absolute; top: 0; bottom: 0; width: 100%; display: flex; align-items: center; color: white; font-weight: bold; font-size: 12px; z-index: 1; }
    .action-delete { background: var(--danger); justify-content: flex-start; padding-left: 20px; }
    .action-played { background: var(--success); justify-content: flex-end; padding-right: 20px; }

    #metro-dots { margin-top: 10px; display: flex; justify-content: center; gap: 15px; height: 45px; align-items: center; }
    .beat-dot { width: 35px; height: 35px; border-radius: 50%; background: #222; border: 2px solid #333; transition: 0.1s; }
    .beat-active-red { background: var(--danger); box-shadow: 0 0 25px var(--danger); transform: scale(1.15); border-color: #fff; }
    .beat-active-green { background: var(--success); box-shadow: 0 0 25px var(--success); transform: scale(1.15); border-color: #fff; }
    #volume-container { display:none; text-align:center; margin-top:10px; }

    #configPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10001; display: none; flex-direction: column; align-items: center; padding: 40px 20px; }
    .wrap { padding: 10px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .grid { grid-template-columns: 280px 1fr; } }
    
    .card { background: rgba(255,255,255,.02); border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 10px; }
    .card .hd { padding: 10px; border-bottom: 1px solid var(--line); font-weight: bold; font-size: 13px; }
    #viewContent { background: rgba(0,0,0,.4); padding: 25px; border-radius: 15px; white-space: pre-wrap; font-family: var(--mono); line-height: 1.6; border: 1px solid var(--line); min-height: 200px; }
    .chord { color: var(--accent); font-weight: bold; }
    #list-name-badge { font-size: 10px; color: var(--accent); margin-top: 4px; display: block; font-weight: bold; }
  </style>
</head>
<body>

<div id="roleSelector">
    <h1 style="color:var(--accent); margin:0; font-size: 24px;">ADORANZA PRO v4.16</h1>
    <div class="role-grid">
        <div class="role-btn" onclick="setRole('musico')">üé∏<small>PIANO<br>GUITARRA</small></div>
        <div class="role-btn" onclick="setRole('drums')">ü•Å<small>BATER√çA<br>VOZ</small></div>
        <div class="role-btn" onclick="verEstadisticas()" style="grid-column: span 1">üìä<small>STATS</small></div>
        <div class="role-btn" onclick="openConfig()" style="grid-column: span 1">‚öôÔ∏è<small>CONFIG</small></div>
    </div>
    <div class="footer-credits">App creada por <a href="https://www.linkedin.com/in/jeffrey-trigueros-371191123/" target="_blank">Jeffrey Trigueros</a></div>
</div>

<div id="configPanel">
    <button class="btn btn-nav" style="margin-bottom: 30px; width: 120px;" onclick="closeConfig()">üè† Home</button>
    <div class="card" style="width: 100%; max-width: 400px;">
        <div class="hd">Perfil de Usuario</div>
        <div class="bd" style="text-align: center;">
            <p style="color:var(--muted)">ID de Usuario:</p>
            <h2 id="uid-display" style="color:var(--accent); font-family:var(--mono); letter-spacing: 2px;"></h2>
        </div>
    </div>
</div>

<div id="fixedControlPanel">
    <div class="viewer-tools">
      <div class="tool-group"><button class="btn btn-nav" onclick="prevSong()">‚üµ</button><button class="btn btn-nav" onclick="nextSong()">‚ü∂</button></div>
      <div class="tool-group" id="tone-group"><button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button><button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button></div>
      <div class="tool-group" id="drums-group" style="display:none;"><button class="btn btn-drums" onclick="toggleMetroManual()" id="btnMetroState">‚ñ∂</button><button class="btn btn-drums" onclick="halfTime()">1/2</button></div>
      <div class="tool-group" style="grid-template-columns: 1fr;"><button class="btn btn-nav" onclick="showHome()">üè† Inicio</button></div>
      <div class="tool-group"><button class="btn btn-font" onclick="changeFontSize(-2)">A-</button><button class="btn btn-font" onclick="changeFontSize(2)">A+</button></div>
      <div class="tool-group triple"><button class="btn btn-scroll" onclick="adjScroll(-0.1)">S-</button><button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()">AUTO</button><button class="btn btn-scroll" onclick="adjScroll(0.1)">S+</button></div>
    </div>
    <div id="volume-container"><small style="color:var(--muted); font-size:10px;">VOL CLICK:</small> <input type="range" id="volRange" min="0" max="1" step="0.05" value="0.5" style="width: 120px; vertical-align:middle;"></div>
    <div id="info-display">
      <div id="current-song-info" style="font-weight: bold; color: var(--accent); font-size: 14px; text-align: center; margin-top: 8px;">Adoranza Cloud</div>
      <div id="metro-dots"></div>
    </div>
</div>

<main class="wrap">
  <div class="grid">
    <section class="card">
        <div class="hd">Buscador</div>
        <div class="bd"><input class="input" style="width:100%; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:8px;" id="searchBox" placeholder="Buscar..." autocomplete="off" /><div id="results"></div></div>
    </section>
    <section class="card">
        <div class="hd">
            <div style="display:flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                <div>Setlist <span id="list-name-badge"></span></div>
                <div style="display:flex; gap:4px;">
                    <button class="btn btn-save" style="width:auto; padding:0 6px; height:24px; font-size:10px;" onclick="guardarListaCloud()">Guardar</button>
                    <button class="btn" style="width:auto; padding:0 6px; height:24px; font-size:10px; background:#333;" onclick="cargarListaCloud()">Cargar ID</button>
                    <button class="btn" style="width:auto; padding:0 6px; height:24px; font-size:10px; background:#551111;" onclick="clearSetlist()">Vaciar</button>
                    <button class="btn btn-wa" style="width:auto; padding:0 6px; height:24px; font-size:10px;" onclick="compartirWhatsApp()">WhatsApp</button>
                </div>
            </div>
        </div>
        <div class="bd" id="setList"></div>
    </section>
    <section class="card" style="grid-column: 1 / -1; border:none; background:none;"><pre id="viewContent">Selecciona una canci√≥n.</pre></section>
  </div>
</main>

<script>
  // CONFIGURACION SUPABASE (Mantenida 100%)
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdGxianZqb3FwcW9rbHZqZHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NzY4NDUsImV4cCI6MjA4MzU1Mjg0NX0.AQg9BuuGlbUtuyccvrBJwRGzx4Bgzx58aqGbfMPzKfg";
  const db = supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  const state = {
    setlist: [], currentIndex: -1, currentFontSize: 18, userRole: 'musico',
    listName: "", currentListID: "", metroInt: null, metroActive: false, currentBPM: 120, half: false,
    scrollInt: null, scrollSpeed: 0.5,
    userId: localStorage.getItem('adoranza_uid') || "AD-" + Math.random().toString(36).substr(2, 4).toUpperCase()
  };

  // --- INICIO ---
  window.onload = async () => { 
    document.getElementById('uid-display').innerText = "ID: " + state.userId;
    localStorage.setItem('adoranza_uid', state.userId);
    initSortable();
  };

  function setRole(role) { 
    state.userRole = role; 
    document.getElementById('roleSelector').style.display = 'none'; 
    document.getElementById('tone-group').style.display = (role === 'musico') ? 'grid' : 'none';
    document.getElementById('drums-group').style.display = (role === 'drums') ? 'grid' : 'none';
    document.getElementById('volume-container').style.display = (role === 'drums') ? 'block' : 'none';
    renderAll(); 
  }

  function openConfig() { document.getElementById('configPanel').style.display = 'flex'; }
  function closeConfig() { document.getElementById('configPanel').style.display = 'none'; }
  function showHome() { document.getElementById('roleSelector').style.display = 'flex'; stopMetro(); }

  // --- BUSCADOR ---
  document.getElementById('searchBox').oninput = async (e) => {
    const val = e.target.value;
    const resDiv = document.getElementById('results');
    if (val.length < 2) { resDiv.innerHTML = ""; return; }
    const { data } = await db.from('canciones').select('*').or(`titulo.ilike.%${val}%,artista.ilike.%${val}%`).limit(6);
    resDiv.innerHTML = "";
    data?.forEach(s => {
      const d = document.createElement('div'); d.className = 'item';
      d.innerHTML = `<div>${s.titulo}</div><button class="btn" style="max-width:40px;" onclick='addToSetlist(${JSON.stringify(s)})'>+</button>`;
      resDiv.appendChild(d);
    });
  };

  async function addToSetlist(song) {
    try {
      const resp = await fetch(BUCKET_URL + song.path_url);
      const text = await resp.text();
      state.setlist.push({ ...song, body: text.replace(/\{(\w+):\s*([^}]+)\}/g, '').trim(), played: false });
      saveLocal(); renderAll();
    } catch(e) { console.error(e); }
  }

  // --- SWIPE LOGIC ---
  let touchStartX = 0;
  function handleTouchStart(e) { touchStartX = e.touches[0].clientX; }
  function handleTouchEnd(e, idx) {
    let diff = e.changedTouches[0].clientX - touchStartX;
    if (diff > 80) { // Derecha: Played
        state.setlist[idx].played = !state.setlist[idx].played;
        saveLocal(); renderAll();
    } else if (diff < -80) { // Izquierda: Remove
        removeSong(idx);
    }
  }

  // --- RENDER ---
  function renderAll() {
    const sl = document.getElementById('setList'); 
    if(!sl) return;
    sl.innerHTML = "";
    
    state.setlist.forEach((s, idx) => {
      const container = document.createElement('div');
      container.className = 'item-container';
      container.innerHTML = `
        <div class="swipe-action action-delete">ELIMINAR</div>
        <div class="swipe-action action-played">TOCADA</div>
        <div class="item ${s.played ? 'played' : ''}" 
             ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event, ${idx})">
          <span class="drag-handle" style="flex:0; padding:0 10px;">‚ò∞</span>
          <div style="flex:1" onclick="seleccionar(${idx})">${s.titulo}</div>
        </div>`;
      sl.appendChild(container);
    });

    const curr = state.setlist[state.currentIndex];
    const view = document.getElementById('viewContent');
    if(curr && view) {
      document.getElementById('current-song-info').innerText = curr.titulo + " | BPM: " + (state.half ? curr.bpm/2 : curr.bpm);
      let body = curr.body;
      if (state.userRole !== 'musico') {
        body = body.replace(/\[([^\]]+)\]/g, ''); 
        const lines = body.split(/\n/);
        const cleaned = [];
        for (let l of lines) { if (l.trim() !== "") cleaned.push(l); else if (cleaned.length > 0 && cleaned[cleaned.length-1] !== "") cleaned.push(""); }
        body = cleaned.join('\n');
      } else { 
        body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>'); 
      }
      view.innerHTML = body; 
      view.style.fontSize = state.currentFontSize + 'px';
      state.currentBPM = state.half ? curr.bpm/2 : curr.bpm;
      if(state.userRole === 'drums' && state.metroActive) startMetro();
    }
  }

  // --- CLOUD FUNCTIONS ACTUALIZADAS (CON NOMBRE EN EL BADGE) ---
  async function guardarListaCloud() {
    const n = prompt("Nombre del Setlist:"); 
    if(!n) return;
    const uid = generateID();
    const ids = state.setlist.map(s => s.id);
    const { error } = await db.from('setlists_guardados').insert({ id_unico: uid, nombre_lista: n, canciones_ids: ids });
    if(!error) {
        state.listName = n; 
        state.currentListID = uid;
        document.getElementById('list-name-badge').innerText = "¬ª " + n; // Refleja Nombre
        alert("Setlist Guardado!\nNombre: " + n + "\nID de carga: " + uid);
    } else {
        alert("Error al guardar en Supabase");
    }
  }

  async function cargarListaCloud() {
    const uid = prompt("Ingresa el ID de 8 caracteres:"); 
    if(!uid) return;
    const { data, error } = await db.from('setlists_guardados').select('*').eq('id_unico', uid.toUpperCase()).single();
    if (data) {
        state.listName = data.nombre_lista; 
        state.currentListID = uid;
        document.getElementById('list-name-badge').innerText = "¬ª " + data.nombre_lista; // Refleja Nombre
        const { data: cans } = await db.from('canciones').select('*').in('id', data.canciones_ids);
        state.setlist = [];
        // Ordenar canciones segun el array original de IDs
        for(let id of data.canciones_ids) { 
            const s = cans.find(x => x.id === id); 
            if(s) await addToSetlist(s); 
        }
        renderAll();
    } else { 
        alert("ID no encontrado o error de conexi√≥n."); 
    }
  }

  // --- L√ìGICA DE ICONOS (Asegura que esto no se haya borrado) ---
  function setRole(role) { 
    state.userRole = role; 
    const selector = document.getElementById('roleSelector');
    if(selector) selector.style.display = 'none'; 
    
    document.getElementById('tone-group').style.display = (role === 'musico') ? 'grid' : 'none';
    document.getElementById('drums-group').style.display = (role === 'drums') ? 'grid' : 'none';
    
    const volCont = document.getElementById('volume-container');
    if(volCont) volCont.style.display = (role === 'drums') ? 'block' : 'none';
    
    renderAll(); 
  }

  // --- ID GENERATOR & CLOUD ---
  function generateID() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Evitamos I, O, 0, 1 por confusi√≥n
    let res = '';
    for (let i = 0; i < 8; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
    return res;
  }

  async function guardarListaCloud() {
    const n = prompt("Nombre del Setlist:"); if(!n) return;
    const uid = generateID();
    const ids = state.setlist.map(s => s.id);
    const { error } = await db.from('setlists_guardados').insert({ id_unico: uid, nombre_lista: n, canciones_ids: ids });
    if(!error) {
        state.listName = n; state.currentListID = uid;
        document.getElementById('list-name-badge').innerText = = "¬ª " + data.nombre_lista;
        alert("Setlist Guardado! ID: " + uid);
    }
  }

  async function cargarListaCloud() {
    const uid = prompt("Ingresa el ID de 8 caracteres:"); if(!uid) return;
    const { data, error } = await db.from('setlists_guardados').select('*').eq('id_unico', uid.toUpperCase()).single();
    if (data) {
        state.listName = data.nombre_lista; state.currentListID = uid;
        document.getElementById('list-name-badge').innerText = = "¬ª " + data.nombre_lista;
        const { data: cans } = await db.from('canciones').select('*').in('id', data.canciones_ids);
        state.setlist = [];
        for(let id of data.canciones_ids) { const s = cans.find(x => x.id === id); if(s) await addToSetlist(s); }
        renderAll();
    } else { alert("ID no encontrado"); }
  }

  function compartirWhatsApp() {
    if(!state.currentListID) { alert("Guarda la lista primero"); return; }
    const songs = state.setlist.map((s,i) => `${i+1}. ${s.titulo}`).join('\n');
    const msg = `üé∏ *SETLIST: ${state.listName}*\nüÜî ID de Carga: *${state.currentListID}*\n\n*Canciones:*\n${songs}\n\n_Generado por Adoranza Pro_`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  }

  function initSortable() { 
    const el = document.getElementById('setList');
    if(el) Sortable.create(el, { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
        const item = state.setlist.splice(evt.oldIndex, 1)[0];
        state.setlist.splice(evt.newIndex, 0, item);
        saveLocal(); renderAll();
    }}); 
  }
</script>
</body>
</html>
