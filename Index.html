<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adoranza Pro v4.04</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --success:#4aff80; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--sans); background: var(--bg); color: var(--text); padding-top: 180px; }
    
    /* SELECTOR DE ROL */
    #roleSelector {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: var(--bg); z-index: 10000; display: flex; 
      flex-direction: column; align-items: center; justify-content: center; gap: 30px;
    }
    .role-grid { display: flex; gap: 15px; }
    .role-btn {
      background: var(--card); border: 2px solid var(--line); padding: 20px;
      border-radius: 20px; text-align: center; font-size: 32px; cursor: pointer;
      transition: 0.3s; width: 110px; color: white;
    }
    .role-btn:hover { border-color: var(--accent); transform: translateY(-5px); }
    .role-btn small { display: block; font-size: 12px; margin-top: 8px; color: var(--muted); font-weight: bold; }

    /* PANEL FIJO */
    #fixedControlPanel { 
      position: fixed; top: 0; left: 0; right: 0; z-index: 999;
      background: rgba(11, 13, 18, 0.98); backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--line); padding: 8px 10px;
    }
    .nav-icons { position: absolute; top: 12px; right: 15px; display: flex; gap: 10px; }
    .icon-btn { background: none; border: 1px solid var(--line); color: var(--muted); padding: 8px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: 0.2s; }
    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }

    .viewer-tools { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; max-width: 500px; margin: 0 auto; }
    .tool-group { display: flex; gap: 6px; justify-content: center; align-items: center; padding: 6px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.02); }

    .btn { appearance:none; border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 14px; font-weight: 600; }
    .btn-nav { background-color: #004173 !important; }
    .btn-tone { background-color: #630b57 !important; }
    .btn-font { background-color: #2E6F40 !important; }
    .btn-scroll { background-color: #d09306 !important; }
    .btn-save { background-color: #1a1a1a; border-color: var(--success); color: var(--success); }

    #viewContent { background: rgba(0,0,0,.4); padding: 25px; border-radius: 15px; white-space: pre-wrap; font-family: var(--mono); line-height: 1.8; border: 1px solid var(--line); }
    .chord { color: var(--accent); font-weight: bold; }
    .item { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; cursor: pointer; }
    .card { background: rgba(255,255,255,.02); border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 10px; }
    .card .hd { padding: 10px; border-bottom: 1px solid var(--line); font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; align-items: center; }
  </style>
</head>
<body>

<div id="roleSelector">
    <h1 style="color:var(--accent); margin:0;">ADORANZA PRO v4.04</h1>
    <p style="color:var(--muted)">Selecciona tu funci√≥n:</p>
    <div class="role-grid">
        <div class="role-btn" onclick="setRole('vocal')">üé§<small>VOCAL</small></div>
        <div class="role-btn" onclick="setRole('musico')">üé∏üéπ<small>M√öSICO</small></div>
        <div class="role-btn" onclick="setRole('drums')">ü•Å<small>BATER√çA</small></div>
    </div>
</div>

<div id="fixedControlPanel">
    <div class="nav-icons">
        <button class="icon-btn" onclick="verEstadisticas()" title="Estad√≠sticas">üìä</button>
        <button class="icon-btn" onclick="showRoles()" title="Inicio/Roles">üè†</button>
    </div>
    <div class="viewer-tools">
      <div class="tool-group"><button class="btn btn-nav" onclick="prevSong()">‚üµ</button><button class="btn btn-nav" onclick="nextSong()">‚ü∂</button></div>
      <div class="tool-group"><button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button><button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button></div>
      <div class="tool-group"><button class="btn btn-font" onclick="changeFontSize(-2)">A-</button><button class="btn btn-font" onclick="changeFontSize(2)">A+</button></div>
      <div class="tool-group"><button class="btn btn-scroll" onclick="adjScroll(-0.1)">S-</button><button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()">‚ñ∂</button><button class="btn btn-scroll" onclick="adjScroll(0.1)">S+</button></div>
    </div>
    <div id="info-display" style="text-align:center; margin-top:8px;">
      <div id="current-song-info" style="font-weight:bold; color:var(--accent); font-size:14px;">Selecciona una canci√≥n</div>
      <div id="metro-dots" style="display:flex; justify-content:center; gap:8px; margin-top:5px;"></div>
    </div>
</div>

<main class="wrap" style="padding:10px; max-width:1200px; margin:0 auto;">
  <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:10px;">
    
    <section class="card">
      <div class="hd">Buscador Cloud</div>
      <div class="bd" style="padding:10px;">
        <input class="input" style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--line); color:white; border-radius:10px;" id="searchBox" placeholder="Buscar..." autocomplete="off" />
        <div id="results" style="margin-top:10px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        Setlist Actual 
        <div style="display:flex; gap:5px;">
            <button class="btn btn-save" style="padding:4px 8px; font-size:10px" onclick="guardarLista()">Guardar</button>
            <button class="btn" style="padding:4px 8px; font-size:10px; background:#333;" onclick="cargarListaMenu()">Cargar</button>
        </div>
      </div>
      <div class="bd" id="setList" style="padding:10px;"></div>
    </section>

    <section class="card" style="grid-column: 1 / -1; border:none; background:none;">
      <pre id="viewContent">Contenido...</pre>
    </section>
  </div>
</main>

<script>
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "TU_ANON_KEY"; // Reemplaza con tu key real
  const db = supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  const state = {
    setlist: JSON.parse(localStorage.getItem('adoranza_v4_setlist') || '[]'),
    currentIndex: -1, currentFontSize: 18, scrollInt: null, scrollSpeed: 0.5, userRole: 'musico', metroInt: null
  };

  function showRoles() { document.getElementById('roleSelector').style.display = 'flex'; clearInterval(state.metroInt); }
  function setRole(role) { state.userRole = role; localStorage.setItem('adoranza_role', role); document.getElementById('roleSelector').style.display = 'none'; renderAll(); }

  // BUSCADOR CON CONTADOR
  document.getElementById('searchBox').oninput = async (e) => {
    const val = e.target.value;
    if (val.length < 2) return;
    const { data } = await db.from('canciones').select('*').or(`titulo.ilike.%${val}%,artista.ilike.%${val}%`).limit(8);
    const resDiv = document.getElementById('results');
    resDiv.innerHTML = "";
    data?.forEach(song => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><b>${song.titulo}</b><br><small>${song.artista}</small></div><button class="btn" onclick='addToSetlist(${JSON.stringify(song)})'>+</button>`;
        resDiv.appendChild(div);
    });
  };

  async function addToSetlist(song) {
    const resp = await fetch(BUCKET_URL + song.path_url);
    const text = await resp.text();
    state.setlist.push({ ...song, body: text.replace(/\{(\w+):\s*([^}]+)\}/g, '').trim() });
    // Incrementar contador en Supabase silenciosamente
    await db.rpc('incrementar_veces_tocada', { row_id: song.id }).catch(()=>{});
    saveLocal(); renderAll();
  }

  // GESTI√ìN DE LISTAS POR NOMBRE
  async function guardarLista() {
    const nombre = prompt("Nombre para este setlist (ej: Domingos):");
    if (!nombre) return;
    const ids = state.setlist.map(s => s.id);
    const { error } = await db.from('setlists_guardados').insert({ nombre_lista: nombre, canciones_ids: ids });
    if (!error) alert("¬°Lista guardada!");
  }

  async function cargarListaMenu() {
    const { data } = await db.from('setlists_guardados').select('*').order('created_at', { ascending: false });
    if (!data.length) return alert("No hay listas guardadas.");
    const nombres = data.map((l, i) => `${i+1}. ${l.nombre_lista}`).join("\n");
    const op = prompt("Elige el n√∫mero de la lista:\n" + nombres);
    if (op && data[op-1]) {
        const list = data[op-1];
        const { data: songs } = await db.from('canciones').select('*').in('id', list.canciones_ids);
        state.setlist = [];
        for(let s of songs) await addToSetlist(s);
    }
  }

  async function verEstadisticas() {
    const { data } = await db.from('canciones').select('titulo, veces_tocada').order('veces_tocada', { ascending: false }).limit(5);
    let msg = "üèÜ Top 5 m√°s tocadas:\n";
    data.forEach(s => msg += `‚Ä¢ ${s.titulo}: ${s.veces_tocada} veces\n`);
    alert(msg);
  }

  // LOGICA BASE (Igual que v4.03 pero pulida)
  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        if(idx === state.currentIndex) div.style.borderColor = 'var(--accent)';
        div.innerHTML = `<div style="flex:1" onclick="seleccionar(${idx})">‚ò∞ ${s.titulo}</div><button class="btn danger" onclick="removeSong(${idx}, event)">‚úï</button>`;
        sl.appendChild(div);
    });
    const curr = state.setlist[state.currentIndex];
    if(curr) {
        document.getElementById('current-song-info').innerText = `${curr.titulo} | BPM: ${curr.bpm}`;
        let body = curr.body;
        if (state.userRole !== 'musico') body = body.replace(/\[([^\]]+)\]/g, '');
        else body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
        document.getElementById('viewContent').innerHTML = body;
        if (state.userRole === 'drums') iniciarMetronomo(curr.bpm, curr.time_signature);
    }
  }

  function iniciarMetronomo(bpm, ts) {
    clearInterval(state.metroInt);
    const dots = document.getElementById('metro-dots'); dots.innerHTML = "";
    const b = parseInt(ts) || 4;
    for(let i=0; i<b; i++) dots.innerHTML += `<div class="beat-dot" id="dot-${i}" style="width:10px; height:10px; border-radius:50%; background:#333;"></div>`;
    let s = 0;
    state.metroInt = setInterval(() => {
        document.querySelectorAll('.beat-dot').forEach(d => d.style.background = '#333');
        const d = document.getElementById(`dot-${s}`);
        if(d) d.style.background = s === 0 ? 'var(--danger)' : 'var(--success)';
        s = (s + 1) % b;
    }, (60/bpm)*1000);
  }

  function seleccionar(i) { state.currentIndex = i; renderAll(); window.scrollTo({top:0, behavior:'smooth'}); }
  function removeSong(i, e) { e.stopPropagation(); state.setlist.splice(i, 1); renderAll(); saveLocal(); }
  function clearSetlist() { if(confirm("¬øVaciar?")) { state.setlist = []; renderAll(); saveLocal(); } }
  function saveLocal() { localStorage.setItem('adoranza_v4_setlist', JSON.stringify(state.setlist)); }
  function changeFontSize(d) { state.currentFontSize += d; document.getElementById('viewContent').style.fontSize = state.currentFontSize+'px'; }
  function nextSong() { if(state.currentIndex < state.setlist.length-1) seleccionar(state.currentIndex+1); }
  function prevSong() { if(state.currentIndex > 0) seleccionar(state.currentIndex-1); }
  function toggleScroll() { 
    if(state.scrollInt) { clearInterval(state.scrollInt); state.scrollInt = null; }
    else state.scrollInt = setInterval(() => window.scrollBy(0,1), 50/state.scrollSpeed);
  }
  function adjScroll(d) { state.scrollSpeed = Math.max(0.1, state.scrollSpeed + d); }

  const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  function transpose(d) {
    const c = state.setlist[state.currentIndex];
    if (!c) return;
    c.body = c.body.replace(/\[([^\]]+)\]/g, (m, ch) => "[" + ch.replace(/[A-G]#?/g, n => {
        let i = scale.indexOf(n);
        return i === -1 ? n : scale[(i + d + 12) % 12];
    }) + "]");
    renderAll();
  }

  const savedRole = localStorage.getItem('adoranza_role');
  if(savedRole) { state.userRole = savedRole; document.getElementById('roleSelector').style.display = 'none'; }
</script>
</body>
</html>
