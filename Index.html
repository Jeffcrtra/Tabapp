@@ -3,107 +3,106 @@
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TabApp Pro v3.71</title>
  <title>9.55 TabApp Pro v3.54 - Multi-Source</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root{
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --ok:#33d17a; --danger:#ff5c77;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:radial-gradient(1200px 700px at 20% 0%, #1b2240 0%, var(--bg) 55%); color:var(--text);}
    body{margin:0; font-family:var(--sans); background:radial-gradient(1200px 700px at 20% 0%, #1b2240 0%, var(--bg) 55%); color:var(--text); overflow-x: hidden;}
    header{position:sticky; top:0; backdrop-filter: blur(10px); background:rgba(11,13,18,.65); border-bottom:1px solid var(--line); z-index:10;}
    
    .wrap{max-width: 100%; margin: 0; padding: 10px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;} /* Optimizado para m√≥vil */
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media (min-width: 980px){ .grid{grid-template-columns: 1.1fr .9fr;} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:14px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--radius); margin-bottom:14px;}
    .card .hd{padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
    .card .bd{padding:12px;}

    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:650; display:inline-flex; align-items:center; justify-content:center; transition: 0.2s; user-select: none; font-size: 16px;}
    .btn:active{transform: scale(0.92); background:rgba(255,255,255,0.1);}
    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:650; display:inline-flex; align-items:center; justify-content:center; transition: 0.2s; font-size: 15px;}
    .btn:active{transform: scale(0.92);}
    .btn.accent{background:rgba(255,213,74,.15); border-color:rgba(255,213,74,.45); color:var(--accent);}
    .btn.danger{background:rgba(255,92,119,.1); border-color:rgba(255,92,119,0.3); color:var(--danger);}
    .btn.small{padding: 8px 12px; font-size: 14px;}
    .btn.small{padding: 8px 12px; font-size: 13px;}

    /* Contenedor del buscador con X */
    .search-box { position: relative; width: 100%; }
    .input{width:100%; padding:14px; padding-right:45px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--text); outline:none; font-size: 16px;}
    .clear-search { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); cursor: pointer; font-size: 20px; font-weight: bold; display: none; }

    .list{display:flex; flex-direction:column; gap:10px;}
    .input{width:100%; padding:14px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--text); outline:none; font-size: 16px;}
    
    .item{border:1px solid var(--line); border-radius:16px; padding:14px; background:rgba(255,255,255,.03); display:flex; justify-content:space-between; align-items:center;}

    /* Visor Expandido */
    /* Panel de Servidores Externos */
    .external-box { margin-top: 15px; padding: 15px; background: rgba(255,213,74,0.05); border: 1px dashed var(--accent); border-radius: 16px; display: none; }
    .external-box h4 { margin: 0 0 10px 0; font-size: 14px; color: var(--accent); }
    .external-grid { display: flex; flex-direction: column; gap: 8px; }

    /* Modal / Popup */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; z-index: 100; padding: 20px; }
    .modal-content { width: 100%; height: 100%; background: white; border-radius: 12px; position: relative; overflow: hidden; }
    .modal-close { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; padding: 10px 15px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 101; }
    iframe { width: 100%; height: 100%; border: none; }

    /* Visor */
    .viewer { min-height: 85vh; display: flex; flex-direction: column; }
    .viewer-tools { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
    .tool-group { display: flex; gap: 12px; justify-content: center; align-items: center; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 16px; border: 1px solid var(--line); }
    
    #viewContent { 
        flex-grow: 1; background: rgba(0,0,0,0.35); padding: 25px 15px; border-radius: 16px; border: 1px solid var(--line); 
        overflow-y: auto; white-space: pre-wrap; font-family: var(--mono); line-height: 1.6; width: 100%;
    }
    .chord{color:var(--accent); font-weight:bold; background: rgba(255,213,74,0.05); padding: 0 2px; border-radius: 4px;}
    #viewContent { flex-grow: 1; background: rgba(0,0,0,0.35); padding: 25px 15px; border-radius: 16px; border: 1px solid var(--line); overflow-y: auto; white-space: pre-wrap; font-family: var(--mono); line-height: 1.6; }
    .chord{color:var(--accent); font-weight:bold;}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>üé∏ TabApp Pro v3.53</h1>
      <span id="status" style="font-size:12px; color:var(--muted);">Conectando...</span>
<div class="modal-overlay" id="extModal">
    <button class="modal-close" onclick="closeExternal()">‚úï</button>
    <div class="modal-content">
        <iframe id="extFrame"></iframe>
    </div>
  </div>
</div>

<header>
  <div class="wrap"><div class="row" style="justify-content:space-between;"><h1>üé∏ TabApp Pro v3.54</h1><span id="status" style="font-size:12px; color:var(--muted);">Cargando...</span></div></div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd"><b>Biblioteca Drive</b></div>
      <div class="hd"><b>Buscador Inteligente</b></div>
      <div class="bd">
        <div class="search-box">
            <input class="input" id="searchDrive" placeholder="Buscar canci√≥n..." autocomplete="off" />
            <span class="clear-search" id="btnSearchClear" onclick="clearSearchInput()">‚úï</span>
        </div>
        <div class="list" id="driveResults" style="margin-top:14px; display:none;"></div>
        
        <div id="driveResults" style="margin-top:14px; display:none; flex-direction:column; gap:10px;"></div>

        <div class="external-box" id="externalBox">
            <h4>No est√° en Drive. Buscar en:</h4>
            <div class="external-grid">
                <button class="btn small accent" onclick="openExternal('canzion')">Instituto CanZion</button>
                <button class="btn small" onclick="openExternal('lacuerda_ch')">LaCuerda (Chords)</button>
                <button class="btn small" onclick="openExternal('lacuerda_ac')">LaCuerda (Acordes)</button>
                <button class="btn small" onclick="openExternal('cifraclub')">CifraClub</button>
                <button class="btn small" onclick="openExternal('google')">Buscar en Google</button>
            </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <b>Setlist Actual</b>
        <button class="btn small danger" onclick="clearSetlist()">Vaciar Todo</button>
      </div>
      <div class="hd"><b>Setlist</b> <button class="btn small danger" onclick="clearSetlist()">Vaciar</button></div>
      <div class="bd">
        <div class="list" id="setList"></div>
        <div id="setList" style="display:flex; flex-direction:column; gap:10px;"></div>
        <hr style="border:0; border-top:1px solid var(--line); margin:25px 0;">
        <div class="viewer">
          <h2 id="viewTitle" style="margin: 0 0 15px 0; text-align: center;">Selecciona una canci√≥n</h2>
          
          <h2 id="viewTitle" style="text-align: center;">Selecciona una canci√≥n</h2>
          <div class="viewer-tools">
            <div class="tool-group">
                <button class="btn" onclick="prevSong()">‚üµ</button>
                <button class="btn" onclick="nextSong()">‚ü∂</button>
            </div>
            <div class="tool-group">
                <button class="btn accent" onclick="transpose(-1)">‚ô≠</button>
                <span style="font-weight: bold; font-size: 12px;">TONO</span>
                <button class="btn accent" onclick="transpose(1)">‚ôØ</button>
            </div>
            <div class="tool-group" style="grid-column: span 2;">
                <button class="btn" onclick="changeFontSize(-2)">A-</button>
                <span style="font-weight: bold; font-size: 12px;">LETRA</span>
                <button class="btn" onclick="changeFontSize(2)">A+</button>
            </div>
            <div class="tool-group"><button class="btn" onclick="prevSong()">‚üµ</button><button class="btn" onclick="nextSong()">‚ü∂</button></div>
            <div class="tool-group"><button class="btn accent" onclick="transpose(-1)">‚ô≠</button><button class="btn accent" onclick="transpose(1)">‚ôØ</button></div>
            <div class="tool-group" style="grid-column: span 2;"><button class="btn" onclick="changeFontSize(-2)">A-</button>Letra<button class="btn" onclick="changeFontSize(2)">A+</button></div>
          </div>

          <pre id="viewContent"></pre>
        </div>
      </div>
@@ -118,24 +117,20 @@ <h2 id="viewTitle" style="margin: 0 0 15px 0; text-align: center;">Selecciona un

  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_setlist') || '[]'),
    allSongs: [], 
    currentIndex: -1,
    currentFontSize: parseInt(localStorage.getItem('pref_font_size') || '18'),
    currentTranspose: 0
    allSongs: [], currentIndex: -1, currentFontSize: 18, currentTranspose: 0
  };

  const normalizar = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

  // --- GOOGLE DRIVE LOGIC ---
  function startApp() {
    gapi.load('client', async () => {
      try {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
        document.getElementById('status').innerText = "Online ‚úÖ";
        document.getElementById('status').innerText = "Drive Online ‚úÖ";
        await cargarBiblioteca();
        renderAll();
        initSortable();
      } catch (e) { document.getElementById('status').innerText = "Error API ‚ùå"; }
      } catch (e) { document.getElementById('status').innerText = "Error API"; }
    });
  }

@@ -147,31 +142,30 @@ <h2 id="viewTitle" style="margin: 0 0 15px 0; text-align: center;">Selecciona un
    state.allSongs = response.result.files || [];
  }

  // --- SEARCH LOGIC (Only show when typing) ---
  document.getElementById('searchDrive').oninput = (e) => {
    const val = e.target.value;
    const resDiv = document.getElementById('driveResults');
    const clearBtn = document.getElementById('btnSearchClear');
    const extBox = document.getElementById('externalBox');

    if (val.trim() === "") {
        resDiv.style.display = "none";
        clearBtn.style.display = "none";
    } else {
        extBox.style.display = "none";
        return;
    }

    const q = normalizar(val);
    const filtrados = state.allSongs.filter(f => normalizar(f.name).includes(q));

    if (filtrados.length > 0) {
        resDiv.style.display = "flex";
        clearBtn.style.display = "block";
        const q = normalizar(val);
        const filtrados = state.allSongs.filter(f => normalizar(f.name).includes(q));
        extBox.style.display = "none";
        mostrarResultados(filtrados);
    } else {
        resDiv.style.display = "none";
        extBox.style.display = "block";
    }
  };

  function clearSearchInput() {
    const input = document.getElementById('searchDrive');
    input.value = "";
    document.getElementById('driveResults').style.display = "none";
    document.getElementById('btnSearchClear').style.display = "none";
  }

  function mostrarResultados(lista) {
    const resDiv = document.getElementById('driveResults');
    resDiv.innerHTML = "";
@@ -183,69 +177,65 @@ <h2 id="viewTitle" style="margin: 0 0 15px 0; text-align: center;">Selecciona un
    });
  }

  // --- LOGICA EXTERNA ---
  function openExternal(source) {
    const query = document.getElementById('searchDrive').value;
    let url = "";
    switch(source) {
        case 'canzion': url = `https://www.institutocanzion.com/musica-y-acordes/buscar?q=${query}`; break;
        case 'lacuerda_ch': url = `https://chords.lacuerda.net/busca.php?ter=${query}`; break;
        case 'lacuerda_ac': url = `https://acordes.lacuerda.net/busca.php?ter=${query}`; break;
        case 'cifraclub': url = `https://www.cifraclub.com/?q=${query}`; break;
        case 'google': url = `https://www.google.com/search?q=${query}+acordes`; break;
    }
    document.getElementById('extFrame').src = url;
    document.getElementById('extModal').style.display = "block";
  }

  function closeExternal() {
    document.getElementById('extModal').style.display = "none";
    document.getElementById('extFrame').src = "";
  }

  async function importar(id, name) {
    const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`;
    const resp = await fetch(url);
    const text = await resp.text();
    state.setlist.push({ id: Date.now(), title: name.replace('.txt',''), body: text, originalBody: text });
    state.currentIndex = state.setlist.length - 1;
    state.currentTranspose = 0;
    saveLocal();
    renderAll();
    clearSearchInput();
    saveLocal(); renderAll();
    document.getElementById('searchDrive').value = "";
    document.getElementById('driveResults').style.display = "none";
  }

  // --- TRANSPOSITOR LOGIC ---
  // --- TRANSPOSTIOR Y RENDER ---
  const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  function transpose(delta) {
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;
    
    state.currentTranspose += delta;
    const transposed = curr.originalBody.replace(/\[([^\]]+)\]/g, (match, chord) => {
    curr.body = curr.body.replace(/\[([^\]]+)\]/g, (match, chord) => {
        return "[" + chord.replace(/[A-G]#?/g, (note) => {
            let idx = scale.indexOf(note);
            if (idx === -1) return note;
            let newIdx = (idx + delta) % scale.length;
            if (newIdx < 0) newIdx += scale.length;
            return scale[newIdx];
            return idx === -1 ? note : scale[(idx + delta + 12) % 12];
        }) + "]";
    });
    
    curr.body = transposed;
    renderAll();
  }

  // --- UI RENDER ---
  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const item = document.createElement('div');
      item.className = 'item';
      if(idx === state.currentIndex) item.style.borderColor = 'var(--accent)';
      item.innerHTML = `
        <div style="flex:1; display:flex; align-items:center;" onclick="seleccionar(${idx})">
            <span style="color:var(--muted); margin-right:12px; cursor:grab;">‚ò∞</span>
            <span style="font-weight:bold;">${s.title}</span>
        </div>
        <button class="btn small danger" onclick="removeSong(${idx}, event)">‚úï</button>
      `;
      item.innerHTML = `<div style="flex:1" onclick="seleccionar(${idx})">‚ò∞ ${s.title}</div><button class="btn small danger" onclick="removeSong(${idx}, event)">‚úï</button>`;
      sl.appendChild(item);
    });
    
    const curr = state.setlist[state.currentIndex];
    document.getElementById('viewTitle').innerText = curr ? curr.title : "Selecciona una canci√≥n";
    const viewer = document.getElementById('viewContent');
    viewer.innerHTML = curr ? curr.body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>') : "";
    viewer.style.fontSize = state.currentFontSize + 'px';
  }

  function removeSong(idx, event) {
    event.stopPropagation();
    state.setlist.splice(idx, 1);
    state.currentIndex = state.setlist.length > 0 ? 0 : -1;
    saveLocal(); renderAll();
    document.getElementById('viewTitle').innerText = curr ? curr.title : "Selecciona canci√≥n";
    document.getElementById('viewContent').innerHTML = curr ? curr.body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>') : "";
    document.getElementById('viewContent').style.fontSize = state.currentFontSize + 'px';
  }

  function initSortable() {
@@ -260,13 +250,13 @@ <h2 id="viewTitle" style="margin: 0 0 15px 0; text-align: center;">Selecciona un
    });
  }

  function seleccionar(idx) { state.currentIndex = idx; state.currentTranspose = 0; renderAll(); }
  function seleccionar(idx) { state.currentIndex = idx; renderAll(); }
  function saveLocal() { localStorage.setItem('tabs_setlist', JSON.stringify(state.setlist)); }
  function clearSetlist() { if(confirm("¬øVaciar setlist completo?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function clearSetlist() { if(confirm("¬øVaciar?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function removeSong(idx, e) { e.stopPropagation(); state.setlist.splice(idx, 1); state.currentIndex = -1; saveLocal(); renderAll(); }
  function nextSong() { if(state.currentIndex < state.setlist.length-1) seleccionar(state.currentIndex+1); }
  function prevSong() { if(state.currentIndex > 0) seleccionar(state.currentIndex-1); }
  function changeFontSize(d) { state.currentFontSize += d; localStorage.setItem('pref_font_size', state.currentFontSize); renderAll(); }

  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="startApp()"></script>
</body>
