<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adoranza Pro v4.10</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --success:#4aff80; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--sans); background: var(--bg); color: var(--text); padding-top: 160px; transition: 0.3s; }
    
    /* PANEL SUPERIOR FIJO */
    #fixedControlPanel { 
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      background: rgba(11, 13, 18, 0.95); backdrop-filter: blur(15px);
      border-bottom: 2px solid var(--line); padding: 10px;
    }

    .main-tabs { display: flex; justify-content: space-around; max-width: 600px; margin: 0 auto 10px; }
    .tab-btn { background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer; padding: 10px; transition: 0.2s; border-radius: 12px; }
    .tab-btn.active { color: var(--accent); background: rgba(255,213,74,0.1); }

    .tool-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; max-width: 600px; margin: 0 auto; }
    .btn-tool { background: var(--line); border: none; color: white; padding: 8px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }

    /* SECCIONES */
    .view-section { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ESTILOS DE COMPONENTES */
    .card { background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 15px; overflow: hidden; }
    .card-hd { padding: 12px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--line); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    .card-bd { padding: 15px; }

    .input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--line); background: #000; color: white; font-size: 16px; margin-bottom: 10px; }
    .item { border: 1px solid var(--line); border-radius: 10px; padding: 12px; background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    
    #viewContent { background: #000; padding: 25px; border-radius: 15px; white-space: pre-wrap; font-family: var(--mono); line-height: 1.7; border: 1px solid var(--line); min-height: 50vh; overflow-x: auto; }
    .chord { color: var(--accent); font-weight: bold; }
    
    .id-badge { background: var(--line); padding: 8px 15px; border-radius: 20px; font-family: var(--mono); color: var(--accent); font-weight: bold; display: inline-block; margin-top: 5px; }
    
    #metro-dots { display: flex; justify-content: center; gap: 8px; margin-top: 10px; height: 10px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #333; }
    .active-r { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    .active-g { background: var(--success); box-shadow: 0 0 8px var(--success); }
  </style>
</head>
<body>

<div id="fixedControlPanel">
    <div class="main-tabs">
        <button class="tab-btn active" onclick="switchTab('search')">üîç</button>
        <button class="tab-btn" onclick="switchTab('list')">üìú</button>
        <button class="tab-btn" onclick="switchTab('viewer')">üéµ</button>
        <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è</button>
    </div>
    
    <div id="song-meta" style="text-align: center; font-size: 13px; font-weight: bold; color: var(--accent); height: 18px;"></div>
    
    <div class="tool-bar">
        <button class="btn-tool" onclick="transpose(-1)">‚ô≠ TONO</button>
        <button class="btn-tool" onclick="transpose(1)">‚ôØ TONO</button>
        <button class="btn-tool" onclick="changeFontSize(-2)">A-</button>
        <button class="btn-tool" onclick="changeFontSize(2)">A+</button>
    </div>
    <div id="metro-dots"></div>
</div>

<section id="tab-search" class="view-section active">
    <div class="card">
        <div class="card-hd">Buscador Cloud</div>
        <div class="card-bd">
            <input class="input" id="searchBox" placeholder="T√≠tulo o artista..." autocomplete="off">
            <div id="results"></div>
        </div>
    </div>
</section>

<section id="tab-list" class="view-section">
    <div class="card">
        <div class="card-hd">
            Mi Setlist
            <button class="btn-tool" style="background:var(--danger)" onclick="clearSetlist()">Vaciar</button>
        </div>
        <div class="card-bd" id="setList"></div>
    </div>
</section>

<section id="tab-viewer" class="view-section">
    <div id="viewContent">Selecciona una canci√≥n en el Setlist.</div>
</section>

<section id="tab-config" class="view-section">
    <div class="card">
        <div class="card-hd">Perfil de Usuario</div>
        <div class="card-bd">
            <label style="color:var(--muted); font-size: 12px;">MI USER ID √öNICO:</label><br>
            <div class="id-badge" id="userIdDisplay">AD-0000</div>
            <p style="font-size: 12px; color: var(--muted); margin-top: 10px;">Este ID permitir√° que otros m√∫sicos importen tus setlists.</p>
        </div>
    </div>

    <div class="card">
        <div class="card-hd">Modo de Visualizaci√≥n (Rol)</div>
        <div class="card-bd">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-tool" id="role-vocal" onclick="setRole('vocal')">Vocal (Sin acordes)</button>
                <button class="btn-tool" id="role-musico" onclick="setRole('musico')">M√∫sico (Acordes)</button>
                <button class="btn-tool" id="role-drums" onclick="setRole('drums')">Bater√≠a (Metr√≥nomo)</button>
                <button class="btn-tool" onclick="verEstadisticas()">üìä Estad√≠sticas</button>
            </div>
        </div>
    </div>
</section>

<script>
  // CONFIG SUPABASE
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdGxianZqb3FwcW9rbHZqZHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NzY4NDUsImV4cCI6MjA4MzU1Mjg0NX0.AQg9BuuGlbUtuyccvrBJwRGzx4Bgzx58aqGbfMPzKfg";
  const db = supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  const state = {
    setlist: JSON.parse(localStorage.getItem('adoranza_v4_setlist') || '[]'),
    currentIndex: -1,
    currentFontSize: 18,
    userRole: localStorage.getItem('adoranza_role') || 'musico',
    userId: localStorage.getItem('adoranza_userid') || generateUserId(),
    metroInt: null
  };

  function generateUserId() {
      const id = "AD-" + Math.random().toString(36).substr(2, 4).toUpperCase();
      localStorage.setItem('adoranza_userid', id);
      return id;
  }

  window.onload = () => {
    document.getElementById('userIdDisplay').innerText = state.userId;
    updateRoleUI();
    renderAll();
    initSortable();
  };

  function switchTab(tabId) {
      document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      event.currentTarget.classList.add('active');
      window.scrollTo(0,0);
  }

  function setRole(role) {
      state.userRole = role;
      localStorage.setItem('adoranza_role', role);
      updateRoleUI();
      renderAll();
  }

  function updateRoleUI() {
      document.querySelectorAll('[ id^="role-" ]').forEach(b => b.style.borderColor = 'transparent');
      const active = document.getElementById('role-' + state.userRole);
      if(active) active.style.borderColor = 'var(--accent)';
  }

  // BUSCADOR
  document.getElementById('searchBox').oninput = async (e) => {
    const val = e.target.value;
    const resDiv = document.getElementById('results');
    if (val.length < 2) { resDiv.innerHTML = ""; return; }

    const { data } = await db.from('canciones').select('*').or(`titulo.ilike.%${val}%,artista.ilike.%${val}%`).limit(5);
    resDiv.innerHTML = "";
    data?.forEach(song => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><b>${song.titulo}</b><br><small>${song.artista}</small></div>
                         <button class="btn-tool" style="background:var(--success)" onclick='addToSetlist(${JSON.stringify(song)})'>+</button>`;
        resDiv.appendChild(div);
    });
  };

  async function addToSetlist(song) {
    const resp = await fetch(BUCKET_URL + song.path_url);
    const text = await resp.text();
    const body = text.replace(/\{(\w+):\s*([^}]+)\}/g, '').trim();
    state.setlist.push({ ...song, body });
    saveLocal(); renderAll();
    switchTab('list');
  }

  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      if(idx === state.currentIndex) div.style.borderLeft = '4px solid var(--accent)';
      div.innerHTML = `<div style="flex:1" onclick="seleccionar(${idx})">${s.titulo}</div>
                       <button class="btn-tool" style="background:none; color:var(--danger)" onclick="removeSong(${idx}, event)">‚úï</button>`;
      sl.appendChild(div);
    });

    const curr = state.setlist[state.currentIndex];
    if(curr) {
        document.getElementById('song-meta').innerText = `${curr.titulo} | BPM: ${curr.bpm}`;
        let body = curr.body;
        if(state.userRole === 'vocal') body = body.replace(/\[([^\]]+)\]/g, '');
        else body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
        
        const viewer = document.getElementById('viewContent');
        viewer.innerHTML = body;
        viewer.style.fontSize = state.currentFontSize + 'px';

        if(state.userRole === 'drums') startMetro(curr.bpm);
        else stopMetro();
    }
  }

  function seleccionar(idx) { state.currentIndex = idx; renderAll(); switchTab('viewer'); }
  function removeSong(idx, e) { e.stopPropagation(); state.setlist.splice(idx, 1); saveLocal(); renderAll(); }
  function clearSetlist() { if(confirm("¬øVaciar?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function saveLocal() { localStorage.setItem('adoranza_v4_setlist', JSON.stringify(state.setlist)); }
  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }

  function transpose(delta) {
    const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const curr = state.setlist[state.currentIndex];
    if(!curr) return;
    curr.body = curr.body.replace(/\[([^\]]+)\]/g, (m, chord) => {
      return "[" + chord.replace(/[A-G]#?/g, (note) => {
        let idx = scale.indexOf(note);
        return idx === -1 ? note : scale[(idx + delta + 12) % 12];
      }) + "]";
    });
    renderAll();
  }

  function startMetro(bpm) {
      stopMetro();
      const dots = document.getElementById('metro-dots');
      dots.innerHTML = '<div class="dot" id="d0"></div><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div>';
      let beat = 0;
      state.metroInt = setInterval(() => {
          document.querySelectorAll('.dot').forEach(d => d.className = 'dot');
          document.getElementById('d' + beat).classList.add(beat === 0 ? 'active-r' : 'active-g');
          beat = (beat + 1) % 4;
      }, (60/bpm)*1000);
  }
  function stopMetro() { clearInterval(state.metroInt); document.getElementById('metro-dots').innerHTML = ""; }

  function initSortable() {
    Sortable.create(document.getElementById('setList'), { animation: 150, onEnd: (evt) => {
        const item = state.setlist.splice(evt.oldIndex, 1)[0];
        state.setlist.splice(evt.newIndex, 0, item);
        saveLocal();
    }});
  }

  async function verEstadisticas() {
    const { data } = await db.from('canciones').select('titulo, veces_tocada').order('veces_tocada', { ascending: false }).limit(5);
    alert("Top 5 Canciones:\n" + data.map(s => `- ${s.titulo} (${s.veces_tocada})`).join('\n'));
  }
</script>
</body>
</html>
