<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TabApp Pro v3.76</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root{
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text); overflow-x: hidden;}
    
    /* HEADER NO FLOTANTE: Sube con la p√°gina */
    header{ background:var(--card); border-bottom:1px solid var(--line); padding: 15px 0; width: 100%; }
    header .wrap { display: flex; justify-content: space-between; align-items: center; }
    h1{ font-size: 22px; margin: 0; color: var(--text); display: flex; align-items: center; gap: 10px; }

    .wrap{ padding: 10px; max-width: 1000px; margin: 0 auto; }
    .card{ background:rgba(255,255,255,.02); border:1px solid var(--line); border-radius:var(--radius); margin-bottom:14px; overflow: hidden;}
    .card .hd{ padding:14px; border-bottom:1px solid var(--line); font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
    .card .bd{ padding:12px; }

    /* BOTONES */
    .btn{ appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text); padding:10px 15px; border-radius:12px; cursor:pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px;}
    .btn:active{ transform: scale(0.95); }
    .btn.accent{ border-color: var(--accent); color: var(--accent); }
    .btn.small{ padding: 6px 10px; font-size: 12px; border-radius: 8px; }

    .input{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:rgba(0,0,0,.2); color:white; outline:none; }
    
    /* VISOR */
    #viewContent { 
      background: rgba(0,0,0,.3); padding: 20px; border-radius: 12px; 
      white-space: pre-wrap; font-family: var(--mono); line-height: 1.7; 
      font-size: 18px; border: 1px solid var(--line); min-height: 300px;
    }
    .chord{ color:var(--accent); font-weight:bold; }
    
    .viewer-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .tool-group { display: flex; gap: 8px; justify-content: center; align-items: center; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 12px; border: 1px solid var(--line); }
  </style>
</head>
<body>

<header>
  <div class="wrap">
      <h1>üé∏ TabApp Pro v3.76</h1>
      <span id="status" style="font-size:12px; color:var(--muted);">Cargando...</span>
  </div>
</header>

<main class="wrap">
    <section class="card">
      <div class="hd">Buscador Inteligente</div>
      <div class="bd">
        <input class="input" id="searchDrive" placeholder="Buscar en Drive..." autocomplete="off" />
        <div id="driveResults" style="margin-top:10px; display:none; flex-direction:column; gap:8px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">Setlist <button class="btn small" onclick="clearSetlist()">Vaciar</button></div>
      <div class="bd" id="setList"></div>
    </section>

    <section class="card">
      <div class="hd" id="viewTitle" style="color:var(--accent)">Selecciona una canci√≥n</div>
      <div class="bd">
        <div class="viewer-tools">
          <div class="tool-group">
            <button class="btn small" onclick="changeFontSize(-2)">A-</button>
            <button class="btn small" onclick="changeFontSize(2)">A+</button>
          </div>
          <div class="tool-group">
            <button class="btn small accent" id="scrollBtn" onclick="toggleScroll()">‚ñ∂ Play</button>
            <button class="btn small" onclick="adjScroll(-0.1)">S-</button>
            <span id="speedInd" style="font-size:11px;">0.5x</span>
            <button class="btn small" onclick="adjScroll(0.1)">S+</button>
          </div>
        </div>
        <pre id="viewContent"></pre>
      </div>
    </section>
</main>

<script>
  // Tu API KEY y FOLDER ID (Mantenlos igual)
  const API_KEY = 'AIzaSyC74SgLN0OFD8zytCktOTCyVdRZZmdL-S0';
  const FOLDER_ID = '1x6zy_Bor6i9qBhUIl27ZIG0E1qdf5Ye6';

  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_setlist') || '[]'),
    allSongs: [], currentIndex: -1, currentFontSize: 18,
    scrollInt: null, scrollSpeed: 0.5 
  };

  // FIX SCROLL: Ahora mueve la ventana global para que el efecto sea visible
  function toggleScroll() {
    const btn = document.getElementById('scrollBtn');
    if (state.scrollInt) {
      clearInterval(state.scrollInt);
      state.scrollInt = null;
      btn.innerText = "‚ñ∂ Play";
    } else {
      btn.innerText = "‚è∏ Stop";
      // La p√°gina baja 1 pixel cada X milisegundos basado en la velocidad
      state.scrollInt = setInterval(() => {
        window.scrollBy(0, 1);
        // Si llegamos al final, detener
        if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
            toggleScroll();
        }
      }, 50 / state.scrollSpeed);
    }
  }

  function adjScroll(delta) {
    state.scrollSpeed = Math.max(0.1, Math.min(3, state.scrollSpeed + delta));
    document.getElementById('speedInd').innerText = state.scrollSpeed.toFixed(1) + "x";
    if (state.scrollInt) { toggleScroll(); toggleScroll(); }
  }

  function changeFontSize(d) {
    state.currentFontSize += d;
    document.getElementById('viewContent').style.fontSize = state.currentFontSize + 'px';
  }

  // --- L√≥gica de Drive y Render (Simplificada para el ejemplo) ---
  function startApp() {
    gapi.load('client', async () => {
      try {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
        document.getElementById('status').innerText = "Online ‚úÖ";
        renderAll();
      } catch (e) { document.getElementById('status').innerText = "Error API"; }
    });
  }

  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'btn';
      div.style.width = "100%"; div.style.marginBottom = "5px";
      div.innerText = s.title;
      div.onclick = () => cargarCancion(idx);
      sl.appendChild(div);
    });
  }

  async function cargarCancion(idx) {
    state.currentIndex = idx;
    const song = state.setlist[idx];
    document.getElementById('viewTitle').innerText = song.title;
    document.getElementById('viewContent').innerHTML = song.body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
    // Al cargar canci√≥n, subir al visor para empezar de cero
    document.getElementById('viewTitle').scrollIntoView({ behavior: 'smooth' });
  }

  function clearSetlist() { state.setlist = []; localStorage.removeItem('tabs_setlist'); renderAll(); }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="startApp()"></script>
</body>
</html>
