<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5.01 TabApp â€“ Pro Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root{
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --ok:#33d17a; --danger:#ff5c77;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:radial-gradient(1200px 700px at 20% 0%, #1b2240 0%, var(--bg) 55%); color:var(--text);}
    header{position:sticky; top:0; backdrop-filter: blur(10px); background:rgba(11,13,18,.65); border-bottom:1px solid var(--line); z-index:10;}
    .wrap{max-width:1180px; margin:0 auto; padding:16px;}
    .row{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    h1{font-size:18px; margin:0; letter-spacing:.3px;}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; padding:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }
    
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:14px;}
    .card .hd{padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
    .card .bd{padding:14px;}
    
    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer; font-weight:650; display:inline-flex; align-items:center; justify-content:center; transition: 0.2s; user-select: none;}
    .btn:active{transform: scale(0.95);}
    .btn.accent{background:rgba(255,213,74,.15); border-color:rgba(255,213,74,.45);}
    .btn.small{padding: 6px 10px; font-size: 12px;}
    
    .input{width:100%; padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--text); outline:none;}
    
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(255,255,255,.03); display:flex; justify-content:space-between; align-items:center; cursor: grab;}
    .item:active { cursor: grabbing; }
    
    /* Indicador visual de que se puede arrastrar */
    .sortable-ghost { opacity: 0.3; background: var(--accent); }

    .viewer { min-height: 80vh; display: flex; flex-direction: column; }
    .viewer-tools { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
    .font-controls { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 12px; border: 1px solid var(--line); }
    #viewContent { flex-grow: 1; background: rgba(0,0,0,0.25); padding: 20px; border-radius: 14px; border: 1px solid var(--line); overflow-y: auto; white-space: pre-wrap; font-family: var(--mono); font-size: 18px; line-height: 1.55; }
    .chord{color:var(--accent); font-weight:bold;}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>ðŸŽ¸ TabApp Pro</h1>
      <span id="status" style="font-size:12px; color:var(--muted);">Cargando API...</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd"><b>Buscador en Drive</b></div>
      <div class="bd">
        <input class="input" id="searchDrive" placeholder="Buscar canciÃ³n..." />
        <div class="list" id="driveResults" style="margin-top:14px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <b>Setlist (Arrastra para reordenar)</b>
        <button class="btn small" onclick="clearSetlist()">Vaciar</button>
      </div>
      <div class="bd">
        <div class="list" id="setList"></div>
        <hr style="border:0; border-top:1px solid var(--line); margin:20px 0;">
        <div class="viewer">
          <h2 id="viewTitle">Selecciona una canciÃ³n</h2>
          <div class="viewer-tools">
            <button class="btn" onclick="prevSong()">âŸµ</button>
            <button class="btn" onclick="nextSong()">âŸ¶</button>
            <div class="font-controls">
              <button class="btn small" onclick="changeFontSize(-2)">A-</button>
              <button class="btn small" onclick="changeFontSize(2)">A+</button>
            </div>
          </div>
          <pre id="viewContent"></pre>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
  // --- CONFIGURACIÃ“N ---
  const API_KEY = 'AIzaSyC74SgLN0OFD8zytCktOTCyVdRZZmdL-S0';
  const FOLDER_ID = '1x6zy_Bor6i9qBhUIl27ZIG0E1qdf5Ye6'; 
  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_setlist') || '[]'),
    currentIndex: -1,
    currentFontSize: parseInt(localStorage.getItem('pref_font_size') || '18')
  };

  const normalizar = (str) => {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  }
  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_setlist') || '[]'),
    currentIndex: -1,
    currentFontSize: parseInt(localStorage.getItem('pref_font_size') || '18'),
    allSongsInDrive: [] // <--- Nueva lista para el buscador flexible
  };

  // --- INICIALIZACIÃ“N ---
  function startApp() {
    gapi.load('client', async () => {
      await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
      document.getElementById('status').innerText = "Drive Online âœ…";
      buscarEnDrive("");
      renderAll();
      initSortable(); // Activar arrastre
    });
  }

  // --- ARRASTRAR Y REORDENAR (Long Press) ---
  function initSortable() {
    const el = document.getElementById('setList');
    Sortable.create(el, {
      animation: 150,
      delay: 500, // 500ms de pulsaciÃ³n para empezar a mover (evita errores al hacer scroll)
      delayOnTouchOnly: true,
      ghostClass: 'sortable-ghost',
      onEnd: (evt) => {
        // Reordenar el array interno basado en el movimiento visual
        const movedItem = state.setlist.splice(evt.oldIndex, 1)[0];
        state.setlist.splice(evt.newIndex, 0, movedItem);
        state.currentIndex = evt.newIndex; // Actualizar Ã­ndice para que no se pierda la vista
        saveLocal();
        renderAll();
      }
    });
  }

 async function buscarEnDrive(nameQ = "") {
    const resDiv = document.getElementById('driveResults');
    
    // Si es la primera vez, descargamos todos los nombres de la carpeta
    if (state.allSongsInDrive.length === 0) {
        resDiv.innerHTML = "Cargando biblioteca...";
        try {
            let q = `'${FOLDER_ID}' in parents and mimeType = 'text/plain' and trashed = false`;
            const response = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)', orderBy: 'name' });
            state.allSongsInDrive = response.result.files || [];
        } catch (e) {
            resDiv.innerHTML = "Error de conexiÃ³n.";
            return;
        }
    }

    // Filtrado inteligente (sin acentos)
    const queryLimpia = normalizar(nameQ);
    const filtrados = state.allSongsInDrive.filter(f => {
        return normalizar(f.name).includes(queryLimpia);
    });

    resDiv.innerHTML = "";
    filtrados.forEach(f => {
        const item = document.createElement('div');
        item.className = 'item';
        item.style.cursor = 'default';
        item.innerHTML = `<span>${f.name.replace('.txt','')}</span><button class="btn accent small" onclick="importar('${f.id}', '${f.name}')">AÃ±adir</button>`;
        resDiv.appendChild(item);
    });

    if (filtrados.length === 0) resDiv.innerHTML = "<div class='sub'>No se encontrÃ³ nada...</div>";
}

  async function importar(id, name) {
    const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`;
    const resp = await fetch(url);
    const text = await resp.text();
    state.setlist.push({ id: Date.now(), title: name.replace('.txt',''), body: text });
    state.currentIndex = state.setlist.length - 1;
    saveLocal();
    renderAll();
  }

  // --- UI Y RENDER ---
  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const item = document.createElement('div');
      item.className = 'item';
      if(idx === state.currentIndex) item.style.borderColor = 'var(--accent)';
      item.innerHTML = `
        <div style="flex:1" onclick="seleccionar(${idx})">
          <span style="color:var(--muted); font-size:12px; margin-right:8px;">â˜°</span>
          <span>${s.title}</span>
        </div>
        <button class="btn small" onclick="seleccionar(${idx})">Ver</button>
      `;
      sl.appendChild(item);
    });

    const curr = state.setlist[state.currentIndex];
    if (curr) {
      document.getElementById('viewTitle').innerText = curr.title;
      document.getElementById('viewContent').innerHTML = curr.body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
      document.getElementById('viewContent').style.fontSize = state.currentFontSize + 'px';
    } else {
      document.getElementById('viewTitle').innerText = "Selecciona una canciÃ³n";
      document.getElementById('viewContent').innerText = "";
    }
  }

  function changeFontSize(delta) {
    state.currentFontSize = Math.min(Math.max(state.currentFontSize + delta, 10), 45);
    localStorage.setItem('pref_font_size', state.currentFontSize);
    renderAll();
  }

  function seleccionar(idx) { state.currentIndex = idx; renderAll(); }
  function saveLocal() { localStorage.setItem('tabs_setlist', JSON.stringify(state.setlist)); }
  function clearSetlist() { if(confirm("Â¿Vaciar setlist?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function nextSong() { if(state.currentIndex < state.setlist.length - 1) seleccionar(state.currentIndex + 1); }
  function prevSong() { if(state.currentIndex > 0) seleccionar(state.currentIndex - 1); }

  document.getElementById('searchDrive').oninput = (e) => buscarEnDrive(e.target.value);
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="startApp()"></script>
</body>
</html>
