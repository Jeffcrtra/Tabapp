<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="./manifest.json" />

  <title>12.41 Adoranza Pro v5.4</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>


  <style>
    :root{
      --bg:#0b0d12;
      --card:#121622;
      --card2:#0f1320;
      --muted:#98a2b3;
      --text:#e6e9ef;
      --line:#23283a;
      --accent:#ffd54a;
      --danger:#ff5c77;
      --success:#4aff80;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 6px 16px rgba(0,0,0,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 10% -10%, rgba(255,213,74,.09), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(74,255,128,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
      padding-top:188px; /* antes 210px: compactamos un toque */
    }

    /* ===== Pantalla inicial ===== */
    #roleSelector{
      position:fixed; inset:0;
      background: radial-gradient(900px 600px at 10% 10%, rgba(255,213,74,.12), transparent 55%),
                  radial-gradient(900px 600px at 100% 10%, rgba(90,140,255,.10), transparent 55%),
                  var(--bg);
      z-index:10000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
      padding:20px;
    }
    .role-grid{
      display:grid;
      gap:14px;
      grid-template-columns:repeat(2,1fr);
      width:min(95vw,520px);
    }
    .role-btn{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      padding:16px 10px;
      border-radius:22px;
      text-align:center;
      font-size:28px;
      cursor:pointer;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:transform .15s ease, border-color .15s ease, filter .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .role-btn:hover{ border-color:rgba(255,213,74,.6); transform:translateY(-2px); }
    .role-btn:active{ transform:translateY(0px) scale(.99); filter:brightness(1.08); }
    .role-btn small{
      font-size:10px;
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      line-height:1.2;
      text-transform:uppercase;
    }
    .footer-credits{
      position:absolute; bottom:18px;
      font-size:12px; color:var(--muted);
      text-align:center;
      opacity:.95;
    }
    .footer-credits a{ color:var(--accent); text-decoration:none; font-weight:800; }

    /* ===== Panel fijo ===== */
    #fixedControlPanel{
      position:fixed; top:0; left:0; right:0; z-index:999;
      background: rgba(11,13,18,.72);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 12px 8px 12px;
    }
    .viewer-tools{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      max-width:540px;
      margin:0 auto;
    }
    .tool-group{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:6px;
      justify-content:center;
      align-items:center;
      padding:6px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
    }
    .tool-group.triple{ grid-template-columns:repeat(3,1fr); grid-column:span 2; }
    .tool-group.single{ grid-template-columns:1fr; }

    .btn{
      border:1px solid rgba(255,255,255,.18);
      color:white;
      padding:10px 6px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease, background .12s ease;
      width:100%;
      max-width:110px;
      margin:0 auto;
      height:36px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter:brightness(1.08); }
    .btn-nav{ background: linear-gradient(180deg, rgba(0,65,115,.95), rgba(0,65,115,.78)); }
    .btn-tone{ background: linear-gradient(180deg, rgba(99,11,87,.95), rgba(99,11,87,.72)); }
    .btn-font{ background: linear-gradient(180deg, rgba(46,111,64,.95), rgba(46,111,64,.72)); }
    .btn-scroll{ background: linear-gradient(180deg, rgba(208,147,6,.95), rgba(208,147,6,.72)); color:#0b0d12; border-color: rgba(255,213,74,.55); }
    .btn-drums{ background: rgba(255,255,255,.02); border-color: rgba(74,255,128,.65); color: var(--success); }
    .btn-save{ background: rgba(255,255,255,.02); border-color: rgba(74,255,128,.65); color: var(--success); }
    .btn-wa{ background: linear-gradient(180deg, rgba(7,94,84,.95), rgba(7,94,84,.74)); border-color: rgba(37,211,102,.65); }

    .btn-add{
      background: var(--accent);
      color:#0b0d12;
      border-color: rgba(255,213,74,.9);
      font-weight:900;
      font-size:10px;
      height:28px;
      padding:0 10px;
      border-radius:12px;
      max-width:56px;
      box-shadow: 0 10px 18px rgba(255,213,74,.10);
    }
    .btn-add:hover{ filter:brightness(1.05); }

    #volume-container{ display:none; text-align:center; margin-top:8px; }

    #info-display{ padding-bottom:0; }

    .now-next-row{
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-start;
      margin-top:8px;
    }
    
    #current-song-info{
      font-weight:900;
      color: rgba(255,255,255,.92);
      font-size:14px;
      text-align:center;
      flex:1;
      text-align:left;
      margin-top:0px;
      line-height:1.15;
      letter-spacing:.01em;
    }
    #current-song-info .sub{
      display:block;
      margin-top:2px;
      font-weight:700;
      font-size:11px;
      color: rgba(255,213,74,.85);
    }

    #next-song-info{
      flex:1;
      text-align:right;
      font-weight:900;
      font-size:12px;
      color:#7dd3fc; /* celeste */
      opacity:.95;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    #next-song-info .sub2{
      display:block;
      margin-top:2px;
      font-weight:700;
      font-size:11px;
      color:#7dd3fc;
      opacity:.85;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #metro-dots{
      margin-top:8px;
      display:flex;
      justify-content:center;
      gap:14px;
      height:42px;
      align-items:center;
    }
    #metro-dots.is-hidden{ display:none; height:0; margin-top:0; }

    .beat-dot{ width:32px; height:32px; border-radius:50%; background:#141824; border:2px solid rgba(255,255,255,.10); transition:.12s; }
    .beat-active-red{ background:var(--danger); box-shadow:0 0 22px rgba(255,92,119,.55); transform:scale(1.12); border-color:#fff; }
    .beat-active-green{ background:var(--success); box-shadow:0 0 22px rgba(74,255,128,.45); transform:scale(1.12); border-color:#fff; }

    /* ===== Config panel ===== */
    #configPanel{
      position:fixed; inset:0;
      background: radial-gradient(900px 600px at 10% 10%, rgba(255,213,74,.10), transparent 55%),
                  var(--bg);
      z-index:10001;
      display:none;
      flex-direction:column;
      align-items:center;
      padding:40px 20px;
      overflow:auto;
    }

    /* ===== Layout ===== */
    .wrap{ padding:12px; max-width:1200px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width:768px){ .grid{ grid-template-columns:320px 1fr; } }

    #setlist-container{ width:92%; margin:0 auto; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      margin-bottom:10px;
      box-shadow: var(--shadow2);
    }
    .card .hd{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      color: rgba(255,255,255,.88);
      text-transform:uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .bd{ padding:12px; }

    .input{
      width:100%;
      background: rgba(0,0,0,.35);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      border-radius:14px;
      outline:none;
      transition: border-color .12s ease, filter .12s ease;
    }
    .input:focus{
      border-color: rgba(255,213,74,.55);
      filter: brightness(1.05);
    }

    /* ===== Setlist item: swipe ===== */
    .set-item-wrap{
      position:relative;
      margin-bottom:10px;
      border-radius:16px;
      overflow:hidden;
    }

    .swipe-actions{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      background: transparent;
    
      /* clave */
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease;
    }
    .set-item-wrap.is-swiping .swipe-actions{
      opacity:1;
    }
    
    .swipe-action{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      letter-spacing:.02em;
      font-size:12px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
    }
    .swipe-action.left{
      background: rgba(255,92,119,.14);
      color: rgba(255,255,255,.92);
      border-color: rgba(255,92,119,.35);
    }
    .swipe-action.right{
      background: rgba(74,255,128,.12);
      color: rgba(255,255,255,.92);
      border-color: rgba(74,255,128,.35);
    }

  .set-item{
    display:flex;
    align-items:center;
    gap:10px;
    border-radius:999px;
    padding:10px 12px;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.10);
  }

  /* Activa (seleccionada) = protagonista */
  .set-item.is-active{
    border-color: rgba(255,213,74,.75);
    box-shadow:
      0 0 0 1px rgba(255,213,74,.20),
      0 14px 34px rgba(0,0,0,.35);
  }
      
  /* Cantada = NO glow, solo m√°s discreta */
  .set-item.is-sung{
    border-color: rgba(255,255,255,.10);
    box-shadow: none;
    opacity: .78;
  }

    /* Offline (favorito) = borde dorado suave (sin glow exagerado) */
    .set-item.is-fav{
      border-color: rgba(255,213,74,.45);
      box-shadow:
        0 0 0 1px rgba(255,213,74,.12);
    }
    
    /* Si es activa + favorita, le damos un toque extra sin volverse discoteca */
    .set-item.is-active.is-fav{
      border-color: rgba(255,213,74,.85);
      box-shadow:
        0 0 0 1px rgba(255,213,74,.22),
        0 18px 44px rgba(0,0,0,.40);
    }
    
    /* Heart pill */
    .pill.heart{
      border-radius: 999px;
      padding: 10px 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      transition: transform .12s ease, background .18s ease, border-color .18s ease;
      user-select: none;
    }
    .pill.heart:active{ transform: scale(.96); }
    
    /* Favorito ON: coraz√≥n lleno, borde dorado */
    .pill.heart.on{
      border-color: rgba(255,213,74,.55);
      background: rgba(255,213,74,.10);
    }
    
    /* Texto */
    .songtitle{
      font-size: 22px;
      letter-spacing: .2px;
    }
    .songmeta{
      color: var(--muted);
      margin-top: 6px;
      font-size: 15px;
    }
    
    .drag-handle{
      width:34px;
      height:34px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:0;
      flex:0 0 auto;
      font-size:18px;
    }
    
    .titlebox{
        flex:1 1 auto;
        min-width:0;
        display:flex;
        flex-direction:column;
        gap:2px;
      }

    .songtitle{
      font-weight:900;
      font-size:14px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    .songmeta{
      font-size:11px;
      color: rgba(152,162,179,.95);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    
    .pill:active{ transform: translateY(1px) scale(.99); filter:brightness(1.06); }

    .pill.heart{
      width:40px;
      height:36px;
      min-width:40px;
      border-radius:999px;
      padding:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
    }
    
    .pill.heart.on{
      border-color: rgba(255,213,74,.55);
      background: rgba(255,213,74,.10);
    }

    #viewContent{
      background: rgba(0,0,0,.35);
      padding:22px;
      border-radius:18px;
      white-space:pre-wrap;
      font-family:var(--mono);
      line-height:1.6;
      border:1px solid rgba(255,255,255,.10);
      min-height:200px;
      box-shadow: var(--shadow2);
    }
    .chord{ color:var(--accent); font-weight:900; }

    #list-name-badge{ font-size:10px; color: rgba(255,213,74,.85); margin-top:4px; display:block; font-weight:700; }

    /* ===== Toast (Undo) ===== */
    #toastUndo{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      z-index:20000;
      min-width:min(92vw, 520px);
      background: rgba(15,19,32,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(12px);
    }
    #toastUndo .msg{
      font-size:12px;
      color: rgba(255,255,255,.92);
      font-weight:800;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    #toastUndo .undoBtn{
      background: rgba(255,213,74,.14);
      border:1px solid rgba(255,213,74,.35);
      color: rgba(255,255,255,.95);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    #toastUndo .undoBtn:active{ transform:translateY(1px) scale(.99); filter:brightness(1.06); }

    /* ===== Mobile tightening for setlist cards ===== */
    @media (max-width: 520px){
      #setlist-container{ width: 96%; }
    
      .set-item{
        padding: 12px 12px;          /* antes 16px 18px */
        border-radius: 16px;         /* antes 22px */
      }
    
      .drag-handle{
        padding: 0 8px;
        font-size: 16px;
      }
    
      .songtitle{
        font-size: 13px;             /* m√°s compacto */
      }
    
      .songmeta{
        font-size: 10px;
        margin-top: 2px;
      }
    
      /* heart pill m√°s peque√±o en mobile */
      .pill.heart{
        min-width: 36px;
        padding: 8px 12px;
      }
    }
    
    .set-item{ touch-action: pan-y; }
        
  </style>
</head>

<body>

<div id="roleSelector">
  <h1 style="color:var(--accent); margin:0; font-size:24px; letter-spacing:.02em;">ADORANZA PRO v5.0</h1>
  <div style="color:rgba(255,255,255,.70); font-size:12px; text-align:center; max-width:520px; line-height:1.4;">
    Setlists, tabs y letras. Swipe para marcar <b>cantada</b> o quitar de la vista. ‚ù§Ô∏è para guardar offline.
  </div>
  <div class="role-grid">
    <div class="role-btn" onclick="setRole('musico')">üé∏<small>PIANO<br>GUITARRA</small></div>
    <div class="role-btn" onclick="setRole('drums')">ü•Å<small>VOZ +<br>BATER√çA</small></div>
    <div class="role-btn" onclick="Estadisticas()">üìä<small>STATS</small></div>
    <div class="role-btn" onclick="openConfig()">‚öôÔ∏è<small>CONFIG</small></div>
  </div>
  <div class="footer-credits">App creada por <a href="https://www.linkedin.com/in/jeffrey-trigueros-371191123/" target="_blank">Jeffrey Trigueros</a></div>
</div>

<div id="configPanel">
  <button class="btn btn-nav" style="margin-bottom:24px; width:140px; max-width:none;" onclick="closeConfig()">üè† Home</button>

  <div class="card" style="width:100%; max-width:520px;">
    <div class="hd">Perfil de Usuario</div>
    <div class="bd" style="text-align:center;">
      <p style="color:var(--muted); margin:0;">Usuario:</p>
      <h2 id="uname-display" style="color:var(--accent); margin:8px 0 0 0;"></h2>

      <p style="color:var(--muted); margin:12px 0 0 0;">ID √∫nico:</p>
      <div id="uid-display" style="color:var(--accent); font-family:var(--mono); letter-spacing:2px; font-size:16px; margin-top:6px;"></div>
    </div>
  </div>

  <div class="card" style="width:100%; max-width:520px; margin-top:14px;">
    <div class="hd">Mis Setlists</div>
    <div class="bd">
      <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
        <button class="btn btn-nav" style="max-width:180px; height:34px;" onclick="listarMisSetlists()">üîÑ Actualizar</button>
        <button class="btn" style="max-width:220px; height:34px; background:rgba(44,82,130,.9); color:white; border-color:rgba(255,255,255,.12);" onclick="copiarMiSetlistActual()">üìã Copiar ID actual</button>
      </div>
      <div id="mySetlists" style="display:grid; gap:10px;"></div>
      <div style="margin-top:10px; font-size:11px; color:var(--muted);">
        Tip: toc√° un setlist para copiar su ID (sirve para Cargar o para compartir).
      </div>
    </div>
  </div>

  <div class="card" style="width:100%; max-width:520px; margin-top:14px;">
    <div class="hd">Favoritos (Offline) <span id="favCount" style="color:var(--muted); font-weight:600;"></span></div>
    <div class="bd">
      <div id="favList" style="display:grid; gap:10px;"></div>
      <div style="margin-top:10px; font-size:11px; color:var(--muted);">
        Estos favoritos viven en tu dispositivo (localStorage). Si borr√°s el navegador o datos, se pierden.
      </div>
    </div>
  </div>

</div>

<div id="fixedControlPanel">
  <div class="viewer-tools">
    <div class="tool-group">
      <button class="btn btn-nav" onclick="prevSong()">‚üµ</button>
      <button class="btn btn-nav" onclick="nextSong()">‚ü∂</button>
    </div>

    <div class="tool-group" id="tone-group">
      <button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button>
      <button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button>
    </div>

    <div class="tool-group" id="drums-group" style="display:none;">
      <button class="btn btn-drums" onclick="toggleMetroManual()" id="btnMetroState">‚ñ∂</button>
      <button class="btn btn-drums" onclick="halfTime()">1/2</button>
    </div>

    <div class="tool-group single">
      <button class="btn btn-nav" onclick="showHome()">üè† Inicio</button>
    </div>

    <div class="tool-group">
      <button class="btn btn-font" onclick="changeFontSize(-2)">A-</button>
      <button class="btn btn-font" onclick="changeFontSize(2)">A+</button>
    </div>

    <div class="tool-group triple">
      <button class="btn btn-scroll" onclick="adjScroll(-0.1)">S-</button>
      <button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()">AUTO</button>
      <button class="btn btn-scroll" onclick="adjScroll(0.1)">S+</button>
    </div>
  </div>

  <div id="volume-container">
    <small style="color:var(--muted); font-size:10px; font-weight:800; letter-spacing:.08em;">VOL CLICK:</small>
    <input type="range" id="volRange" min="0" max="1" step="0.05" value="0.5" style="width:140px; vertical-align:middle;">
  </div>

  <div id="info-display">
    <div class="now-next-row">
      <div id="current-song-info">Adoranza Cloud</div>
      <div id="next-song-info"></div>
    </div>
    <div id="metro-dots"></div>
  </div>
</div>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd">Buscador</div>
      <div class="bd">
        <input class="input" id="searchBox" type="search" placeholder="Buscar..." autocomplete="off" />
        <div id="results" style="margin-top:10px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%; gap:10px;">
          <div style="min-width:0;">
            Setlist <span id="list-name-badge"></span>
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn btn-save" style="width:auto; padding:0 10px; height:30px; font-size:11px; max-width:none;" onclick="guardarListaCloud()">Guardar</button>
            <button class="btn" style="width:auto; padding:0 10px; height:30px; font-size:11px; background:rgba(44,82,130,.9); color:white; border-color:rgba(255,255,255,.12); max-width:none;" onclick="cargarListaCloud()">Cargar</button>
            <button class="btn" id="btnClearOrClose"
              style="width:auto; padding:0 6px; height:24px; font-size:10px; background:#551111;"
              onclick="clearOrCloseSetlist()">
              Vaciar
            </button>
            <button class="btn btn-wa" style="width:auto; padding:0 10px; height:30px; font-size:11px; max-width:none;" onclick="compartirWhatsApp()">Env√≠a</button>
          </div>
        </div>
      </div>
      <div class="bd" id="setlist-container">
        <div id="setList"></div>
        <div style="margin-top:8px; color:rgba(152,162,179,.9); font-size:11px;">
          Swipe ‚ûú <span style="color:rgba(74,255,128,.9); font-weight:900;">cantada</span> ¬∑ Swipe ‚á¶ <span style="color:rgba(255,92,119,.9); font-weight:900;">quitar</span> ¬∑ ‚ù§Ô∏è guarda offline
        </div>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1; border:none; background:none; box-shadow:none;">
      <pre id="viewContent">Selecciona una canci√≥n.</pre>
    </section>
  </div>
</main>

<!-- Toast undo -->
<div id="toastUndo">
  <div class="msg" id="toastMsg">Eliminada</div>
  <div class="undoBtn" onclick="undoLastRemove()">DESHACER</div>
</div>

<script>
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdGxianZqb3FwcW9rbHZqZHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NzY4NDUsImV4cCI6MjA4MzU1Mjg0NX0.AQg9BuuGlbUtuyccvrBJwRGzx4Bgzx58aqGbfMPzKfg";
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  window.onerror = function (msg, src, line, col, err) {
    appAlert("No se pudo cargar el archivo:\n" + (song?.path_url || ""));
    console.error(err);
  };

  let db = null;

  // ===== Local Storage Keys =====
  const LS_FAV = "adoranza_favorites_v1";
  const LS_SUNG = "adoranza_sung_v1";
  const LS_HIDDEN = "adoranza_hidden_v1";

  // ===== Helpers =====
  function genSetlistId8(prefix="") {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let out = "";
    try {
      if (window.crypto && crypto.getRandomValues) {
        const arr = new Uint8Array(8);
        crypto.getRandomValues(arr);
        for (let i = 0; i < 8; i++) out += chars[arr[i] % chars.length];
        return prefix + out;
      }
    } catch(e) {}
    for (let i = 0; i < 8; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return prefix + out;
  }

  function normalizeSongIds(v) {
    if (v == null) return [];
    if (Array.isArray(v)) return v.map(x => String(x).trim()).filter(Boolean);
    if (typeof v === "string") {
      const s = v.trim();
      if (!s) return [];
      try {
        const j = JSON.parse(s);
        if (Array.isArray(j)) return j.map(x => String(x).trim()).filter(Boolean);
      } catch (e) {}
      const uuids = s.match(/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/g);
      if (uuids && uuids.length) return uuids.map(x => x.trim());
      const cleaned = s.replace(/[\{\}\[\]\s"]/g, "");
      if (!cleaned) return [];
      return cleaned.split(",").map(x => x.trim()).filter(Boolean);
    }
    return [String(v).trim()].filter(Boolean);
  }

  function normalizeSetlistSongs(canciones_json) {
    const arr = Array.isArray(canciones_json) ? canciones_json : [];
    return arr
      .filter(x => x && x.id)
      .map((x, idx) => ({
        id: x.id,
        orden: Number.isFinite(x.orden) ? x.orden : idx,
        // Compatibilidad vieja:
        bpm_override: Number.isFinite(x.bpm_override) ? x.bpm_override
                    : (Number.isFinite(x.bpm) ? x.bpm : null),
        tono_override: typeof x.tono_override === "string" ? x.tono_override : null,
      }))
      .sort((a, b) => a.orden - b.orden);
  }

  async function resolveSetlistSongs(setlist, supabase) {
    const ids = Array.isArray(setlist.canciones_ids) ? setlist.canciones_ids : [];
    const overridesById = normalizeOverrides(setlist.canciones_json);
  
    if (!ids.length) return [];
  
    // 1) Traer metadata de canciones
    const { data: metas, error } = await supabase
      .from("canciones")
      .select("id, titulo, artista, album, bpm, time_signature, tono_original, path_url")
      .in("id", ids);
  
    if (error) throw error;
  
    const byId = new Map(metas.map(m => [m.id, m]));
  
    // 2) Mantener el orden del array canciones_ids
    const ordered = ids.map(id => byId.get(id)).filter(Boolean);
  
    // 3) Fetch del texto actualizado desde path_url + aplicar overrides
    const resolved = [];
      for (const meta of ordered) {
        const ov = overridesById.get(meta.id) || {};
      
        // ‚úÖ SIEMPRE usa el bucket si path_url es relativo
        const body = await fetchSongBodyFromBucket(meta);
      
        resolved.push({
          ...meta,
          body, // ‚úÖ SIEMPRE √∫ltima versi√≥n
          bpm_effective: ov.bpm_override ?? meta.bpm ?? null,
          tono_effective: ov.tono_override ?? meta.tono_original ?? null,
          tono_override: ov.tono_override ?? null,
          bpm_override: ov.bpm_override ?? null,
        });
      }
    return resolved;
  }

  function buildSetlistOverridesJson(songsInOrder) {
    return songsInOrder.map(s => ({
      id: s.id,
      tono_override: s.tono_override ?? null,
      bpm_override: Number.isFinite(s.bpm_override) ? s.bpm_override : null
    }));
  }
  
  async function saveSetlist(code, songsInOrder, supabase) {
    const canciones_ids = songsInOrder.map(s => s.id);
    const canciones_json = buildSetlistOverridesJson(songsInOrder);
  
    const { error } = await supabase
      .from("setlists_guardados")
      .update({ canciones_ids, canciones_json })
      .eq("id_unico", code);
  
    if (error) throw error;
  }

  function buildSetlistJsonForSave(songsInSetlist) {
    // songsInSetlist: tu estructura interna actual
    return songsInSetlist.map((s, idx) => ({
      id: s.id,
      orden: idx,
      tono_override: s.tono_override ?? null,
      bpm_override: Number.isFinite(s.bpm_override) ? s.bpm_override : null,
    }));
  }

  async function loadSetlistByCode(code, supabase) {
    const { data: setlist, error } = await supabase
      .from("setlists_guardados")
      .select("id, nombre_lista, canciones_ids, canciones_json, updated_at")
      .eq("id_unico", code)
      .single();
  
    if (error) throw error;
    return setlist;
  }

  function normalizeOverrides(canciones_json) {
    const arr = Array.isArray(canciones_json) ? canciones_json : [];
    const map = new Map();
  
    for (const x of arr) {
      if (!x?.id) continue;
      map.set(x.id, {
        bpm_override: Number.isFinite(x.bpm_override) ? x.bpm_override
                    : (Number.isFinite(x.bpm) ? x.bpm : null),
        tono_override: (typeof x.tono_override === "string" && x.tono_override.trim())
          ? x.tono_override.trim()
          : null
      });
    }
    return map;
  }

  async function copyToClipboard(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch(e) {}
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
      document.execCommand("copy");
      document.body.removeChild(ta);
      return true;
    } catch (e) {
      document.body.removeChild(ta);
      return false;
    }
  }

  function safeJSONParse(txt, fallback){
    try { return JSON.parse(txt); } catch(e){ return fallback; }
  }

  function normKey(s){
    return String(s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().trim()
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/^-+|-+$/g,"");
  }
  
  function songKey(song){
    if (song && song.id) return String(song.id);
    const t = normKey(song?.titulo || "");
    const a = normKey(song?.artista || "");
    const p = normKey(song?.path_url || "");
    return (t || a || p) ? `${a}|${t}|${p}` : genSetlistId8("S");
  }

  function listKey(){
    return (state.listIdUnico && state.listIdUnico.trim()) ? state.listIdUnico.trim().toUpperCase() : "LOCAL";
  }

  function escapeQuotes(s){
    return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
  }

  function transposeBody(raw, steps, preferFlats=false){
    if (!steps) return raw || "";
  
    const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  
    // Para convertir salida con # a su equivalente en b
    const sharpToFlat = { "C#":"Db", "D#":"Eb", "F#":"Gb", "G#":"Ab", "A#":"Bb" };
  
    return String(raw||"").replace(/\[([^\]]+)\]/g, (m, chord) => {
      const out = chord.replace(/[A-G](?:#|b)?/g, (note) => {
        // normaliza bemol a su equivalente sharp (para transponer)
        const n = note.toUpperCase();
        const flatsToSharps = { "DB":"C#", "EB":"D#", "GB":"F#", "AB":"G#", "BB":"A#" };
        const nn = flatsToSharps[n] || n;
  
        const idx = scale.indexOf(nn);
        if (idx === -1) return note;
  
        let res = scale[(idx + steps + 1200) % 12];
  
        // si queremos bemoles, convertimos la salida (A# -> Bb, etc.)
        if (preferFlats && sharpToFlat[res]) res = sharpToFlat[res];
  
        return res;
      });
  
      return "[" + out + "]";
    });
  }

  
  function buildCloudSetlistPayload(){
    const ids = state.setlist.map(s => s.id).filter(Boolean);
    const overrides = state.setlist.map(s => ({
      id: s.id,
      // override por setlist:
      transpose_steps: Number.isFinite(s.transpose_steps) ? s.transpose_steps : 0,
      bpm_override: Number.isFinite(s.bpm_override) ? s.bpm_override : null
    }));
    return { canciones_ids: ids, canciones_json: overrides };
  }

  // ===== STATE =====
  const state = {
    setlist: [],
    currentIndex: -1,
    currentFontSize: 18,
    hasUnsavedChanges: false, // Nueva bandera de control
    userRole: "musico",
    listName: "",
    listIdUnico: "",
    metroInt: null,
    metroActive: false,
    currentBPM: 120,
    half: false,
    scrollInt: null,
    scrollSpeed: 1.0,

    // user
    userId: localStorage.getItem("adoranza_user_id") || "",
    username: localStorage.getItem("adoranza_username") || "",

    // undo
    lastRemoved: null,
    toastT: null
  };

  // ===== SUPABASE & USER =====
  function initSupabaseOrWarn() {
    if (!window.supabase || !supabase.createClient) {
      appAlert("No carg√≥ Supabase (CDN). Revisa internet o bloqueo de CDN.");
      return null;
    }
    try {
      return supabase.createClient(SB_URL, SB_KEY);
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  function ensureLocalUserOrBlock() {
    if (!state.userId) {
      state.userId = genSetlistId8("ID");
      localStorage.setItem("adoranza_user_id", state.userId);
    }
    while (!state.username || !state.username.trim()) {
      const u = prompt("Eleg√≠ tu nombre de usuario (obligatorio):", "");
      if (u == null) continue;
      if (!u.trim()) continue;
      state.username = u.trim();
      localStorage.setItem("adoranza_username", state.username);
    }
  }

  async function upsertUserToCloudNonBlocking() {
    if (!db) return;
    try {
      const payload = { user_id: state.userId, username: state.username };
      const { error } = await db.from("adoranza_users").upsert(payload, { onConflict: "user_id" });
    } catch (e) {}
  }

  // ===== UI CORE =====
  function setRole(role) {
    state.userRole = role;
    document.getElementById("roleSelector").style.display = "none";
    document.getElementById("tone-group").style.display = (role === "musico") ? "grid" : "none";
    document.getElementById("drums-group").style.display = (role === "drums") ? "grid" : "none";
    document.getElementById("volume-container").style.display = (role === "drums") ? "block" : "none";
    renderAll();
  }

  function openConfig() {
    document.getElementById("configPanel").style.display = "flex";
    const ud = document.getElementById("uid-display");
    const un = document.getElementById("uname-display");
    if (ud) ud.innerText = state.userId;
    if (un) un.innerText = state.username || "(sin username)";
    if (db) listarMisSetlists();
    renderFavoritesInConfig();
  }
  
  function closeConfig() { document.getElementById("configPanel").style.display = "none"; }
  
  function showHome() {
    document.getElementById("roleSelector").style.display = "flex";
    stopMetro();
    stopScroll();
  }

  function renderBadge() {
    const badge = document.getElementById("list-name-badge");
    if (!badge) return;
    if (!state.listName && !state.listIdUnico) { badge.innerText = ""; return; }
    let txt = `¬ª ${state.listName || state.listIdUnico}`;
    if(state.listName && state.listIdUnico) txt += ` (${state.listIdUnico})`;
    if(state.hasUnsavedChanges) txt += " ‚ö†Ô∏è"; // Indicador visual
    badge.innerText = txt;
    updateClearCloseBtn();
  }

  function hasLoadedNamedList(){
    return !!(state.listIdUnico || (state.listName && state.listName.trim()));
  }

  function updateClearCloseBtn(){
    const b = document.getElementById("btnClearOrClose");
    if (!b) return;
    if (hasLoadedNamedList()) {
      b.textContent = "Cerrar";
      b.title = "Cerrar setlist (limpia la vista)";
    } else {
      b.textContent = "Vaciar";
      b.title = "Vaciar lista temporal";
    }
  }

  function clearOrCloseSetlist(){
    // NUEVO: Protecci√≥n de cambios sin guardar
    if (state.listIdUnico && state.hasUnsavedChanges) {
      if (!confirm("‚ö†Ô∏è Tienes cambios de tono o letra sin guardar en la nube.\n\nSi cierras ahora, volver√°n a su estado original.\n¬øCerrar de todos modos?")) {
        return;
      }
    }

    if (hasLoadedNamedList()) {
      const ok = confirm("¬øCerrar este setlist? (No se borra en la nube)");
      if (!ok) return;
      clearSetlist();
    } else {
      const ok = confirm("¬øVaciar la lista temporal?");
      if (!ok) return;
      clearSetlist();
    }
  }

  // ===== FAVORITOS & CANTADAS =====
  function getFavorites(){
    const raw = localStorage.getItem(LS_FAV) || "{}";
    const obj = safeJSONParse(raw, {});
    return (obj && typeof obj === "object") ? obj : {};
  }
  function setFavorites(obj){ localStorage.setItem(LS_FAV, JSON.stringify(obj || {})); }

  function isFav(song){
    const favs = getFavorites();
    const k = songKey(song);
    return !!favs[k];
  }

  function toggleFavByIndex(idx, ev){
    if (ev) ev.stopPropagation();
    const song = state.setlist[idx];
    if (!song) return;
    const favs = getFavorites();
    const k = songKey(song);
    if (favs[k]) {
      delete favs[k];
    } else {
      favs[k] = {
        key: k,
        id: song.id || null,
        titulo: song.titulo || "",
        artista: song.artista || "",
        path_url: song.path_url || "",
        body: song.body || "",
        updatedAt: Date.now()
      };
    }
    setFavorites(favs);
    renderAll();
    renderFavoritesInConfig();
  }

  function renderFavoritesInConfig(){
    const box = document.getElementById("favList");
    if (!box) return;
    const favs = getFavorites();
    const arr = Object.values(favs || {}).sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
    const c = document.getElementById("favCount");
    if (c) c.textContent = `(${arr.length})`;
    box.innerHTML = "";
    if (!arr.length) {
      box.innerHTML = `<div style="color:var(--muted); font-size:12px;">No hay favoritos offline.</div>`;
      return;
    }
    arr.forEach(f => {
      const el = document.createElement("div");
      el.className = "item";
      el.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,.05); padding:8px; border-radius:8px;";
      el.innerHTML = `
        <div style="flex:1; cursor:pointer;" onclick="openFavorite('${escapeQuotes(f.key)}')">
          <div style="font-weight:700; font-size:13px;">${f.titulo || "(Sin t√≠tulo)"}</div>
          <div style="font-size:11px; color:var(--muted);">${f.artista || ""}</div>
        </div>
        <button class="btn danger-x" style="max-width:30px; height:30px; padding:0;" onclick="removeFavorite('${escapeQuotes(f.key)}', event)">‚úï</button>
      `;
      box.appendChild(el);
    });
  }

  function openFavorite(key, ev){
    if (ev) ev.stopPropagation();
    const favs = getFavorites();
    const f = favs[key];
    if (!f) return;
    const idx = state.setlist.findIndex(x => songKey(x) === key || String(x.id||"") === String(f.id||""));
    if (idx >= 0) {
      seleccionar(idx);
      closeConfig();
      return;
    }
    state.setlist.push({
      id: f.id || null,
      titulo: f.titulo || "",
      artista: f.artista || "",
      path_url: f.path_url || "",
      body: f.body || ""
    });
    saveLocal();
    renderAll();
    seleccionar(state.setlist.length - 1);
    closeConfig();
  }

  function removeFavorite(key, ev){
    if (ev) ev.stopPropagation();
    const favs = getFavorites();
    if (!favs[key]) return;
    if (!confirm("¬øQuitar este favorito offline?")) return;
    delete favs[key];
    setFavorites(favs);
    renderFavoritesInConfig();
    renderAll();
  }

  function getSungMap(){
    const raw = localStorage.getItem(LS_SUNG) || "{}";
    return safeJSONParse(raw, {});
  }
  function setSungMap(obj){ localStorage.setItem(LS_SUNG, JSON.stringify(obj || {})); }
  function isSung(song){
    const sm = getSungMap();
    const lk = listKey();
    const k = songKey(song);
    return !!(sm[lk] && sm[lk][k]);
  }
  function markSung(song, val){
    const sm = getSungMap();
    const lk = listKey();
    const k = songKey(song);
    if (!sm[lk]) sm[lk] = {};
    if (val) sm[lk][k] = true;
    else delete sm[lk][k];
    setSungMap(sm);
  }

  function getHiddenMap(){
    const raw = localStorage.getItem(LS_HIDDEN) || "{}";
    return safeJSONParse(raw, {});
  }
  function setHiddenMap(obj){ localStorage.setItem(LS_HIDDEN, JSON.stringify(obj || {})); }
  function isHidden(song){
    const hm = getHiddenMap();
    const lk = listKey();
    const k = songKey(song);
    return !!(hm[lk] && hm[lk][k]);
  }
  function setHidden(song, val){
    const hm = getHiddenMap();
    const lk = listKey();
    const k = songKey(song);
    if (!hm[lk]) hm[lk] = {};
    if (val) hm[lk][k] = true;
    else delete hm[lk][k];
    setHiddenMap(hm);
  }

  // ===== CORE LOGIC =====
  async function fetchSongBodyFromBucket(song) {
    // Si path_url ya viene como URL completa (http...), √∫sala tal cual.
    // Si viene como path relativo, construye con BUCKET_URL.
    let rawUrl = (song.path_url || "").trim();
    rawUrl = rawUrl.replace(/^\.\//, ""); // quita ./ al inicio si existe
    const fullUrl = /^https?:\/\//i.test(rawUrl) ? rawUrl : (BUCKET_URL + rawUrl);
  
    // Protege contra espacios y caracteres raros (evita 400)
    const safeUrl = encodeURI(fullUrl);
  
    const resp = await fetch(safeUrl, { cache: "no-store" });
    if (!resp.ok) throw new Error("Fetch " + resp.status + " " + fullUrl);
  
    const text = await resp.text();
    return text.replace(/\{(\w+):\s*([^}]+)\}/g, "").trim();
  }

  async function addToSetlist(song) {
    try {
      const favs = getFavorites();
      const k = songKey(song);
      const bodyBase = (favs[k] && favs[k].body)
        ? favs[k].body
        : await fetchSongBodyFromBucket(song);
  
      state.setlist.push({
        ...song,
        body_base: bodyBase,
        transpose_steps: 0,
        bpm_override: null
      });
  
      saveLocal();
      renderAll();
    } catch (e) {
      console.error(e);
      appAlert("No se pudo cargar el archivo:\n" + (song?.path_url || ""));
    }
  }
  
  function getNextVisibleIndex(fromIdx){
    if (!state.setlist.length) return -1;
    for (let i = fromIdx + 1; i < state.setlist.length; i++){
      const s = state.setlist[i];
      if (s && !isHidden(s)) return i;
    }
    return -1;
  }
  
  function updateNowNextInfo(){
    const info = document.getElementById("current-song-info");
    const next = document.getElementById("next-song-info");
    const curr = state.setlist[state.currentIndex];
  
    if (!next) return;
  
    if (!curr){
      if (info) info.innerHTML = "Adoranza Cloud";
      next.innerHTML = "";
      return;
    }
  
    const nextIdx = getNextVisibleIndex(state.currentIndex);
    const nextSong = nextIdx >= 0 ? state.setlist[nextIdx] : null;
  
    // Texto para ‚ÄúSiguiente‚Äù
    if (nextSong){
      next.innerHTML = `${nextSong.titulo || "(Sin t√≠tulo)"}<span class="sub2">Siguiente</span>`;
    } else {
      next.innerHTML = `(no hay m√°s)<span class="sub2">Siguiente</span>`;
    }
  }

  
  function renderAll() {
    const sl = document.getElementById("setList");
    if (!sl) return;
    sl.innerHTML = "";

    const visible = state.setlist
      .map((s, originalIndex) => ({ s, originalIndex }))
      .filter(x => !isHidden(x.s));

    visible.forEach(({ s, originalIndex }) => {
      const wrap = document.createElement("div");
      wrap.className = "set-item-wrap";
      const actions = document.createElement("div");
      actions.className = "swipe-actions";
      actions.innerHTML = `
        <div class="swipe-action left">üóëÔ∏è Quitar</div>
        <div class="swipe-action right">‚úÖ Cantada</div>
      `;
      const row = document.createElement("div");
      row.className = "set-item";
      row.dataset.idx = String(originalIndex);
      const favOn = isFav(s)
      if (originalIndex === state.currentIndex) row.classList.add("is-active");
      if (isSung(s)) row.classList.add("is-sung");
      if (favOn) row.classList.add("is-fav");

      row.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <div class="titlebox">
          <div class="songtitle">${s.titulo || "(Sin t√≠tulo)"}</div>
          <div class="songmeta">${s.artista || ""}${favOn ? " ¬∑ Offline" : ""}${isSung(s) ? " ¬∑ Cantada" : ""}</div>
        </div>
        <div class="pill heart ${favOn ? "on" : ""}" onclick="toggleFavByIndex(${originalIndex}, event)">${favOn ? "‚ô•" : "‚ô°"}</div>
      `;
      row.onclick = () => seleccionar(originalIndex);
      wrap.appendChild(actions);
      wrap.appendChild(row);
      sl.appendChild(wrap);
      attachSwipe(row);
    });

    renderBadge();

    const currHidden = (state.currentIndex >= 0 && state.setlist[state.currentIndex] && isHidden(state.setlist[state.currentIndex]));
    if (currHidden) state.currentIndex = -1;

    const curr = state.setlist[state.currentIndex];
    const view = document.getElementById("viewContent");
    const info = document.getElementById("current-song-info");
    const dots = document.getElementById("metro-dots");

    if (curr && view) {
      if (info) {
        if (state.userRole === "drums") {
          info.innerHTML = `${curr.titulo || ""}<span class="sub">BPM: ${state.half ? curr.bpm/2 : curr.bpm}</span>`;
        } else {
          info.innerHTML = `${curr.titulo || ""}<span class="sub">${curr.artista || ""}</span>`;
        }
      }

      updateNowNextInfo();
      
      if (dots) {
        if (state.userRole === "musico") dots.classList.add("is-hidden");
        else dots.classList.remove("is-hidden");
      }
      
        const currentKey = String(curr.key || "").trim();
        const keyNorm = currentKey.replace(/\s+/g, ""); // "D m" -> "Dm"
        
        // detecta si la tonalidad (texto) usa bemol real (Bb, Eb, etc.)
        const hasFlatKey = /^[A-G]b/.test(keyNorm);
        
        // menores t√≠picamente escritos con bemoles (relativas de keys con bemoles)
        const flatMinorKeys = ["Dm","Gm","Cm","Fm","Bbm","Ebm","Abm"];
        
        const preferFlats =
          hasFlatKey ||
          ["F","Bb","Eb","Ab","Db","Gb","Cb"].includes(keyNorm) ||
          flatMinorKeys.includes(keyNorm);
        
        let body = transposeBody(
          bodyBase,
          curr.transpose_steps || 0,
          preferFlats
        );

      
      if (state.userRole !== "musico") {
        body = body.replace(/\[([^\]]+)\]/g, "");
        const lines = body.split(/\r?\n/);
        const cleaned = [];
        for (let l of lines) {
          if (l.trim() !== "") cleaned.push(l);
          else if (cleaned.length > 0 && cleaned[cleaned.length - 1] !== "") cleaned.push("");
        }
        body = cleaned.join("\n");
      } else {
        body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
      }
      view.innerHTML = body;
      view.style.fontSize = state.currentFontSize + "px";
      state.currentBPM = state.half ? curr.bpm / 2 : curr.bpm;
      if (state.userRole === "drums" && state.metroActive) startMetro();
    } else {
      if (dots) {
         if (state.userRole === "musico") dots.classList.add("is-hidden");
         else dots.classList.remove("is-hidden");
      }
      if (info) info.innerHTML = `Adoranza Cloud`;
      if (view) view.textContent = "Selecciona una canci√≥n.";
      updateNowNextInfo();
    }
  }

  function seleccionar(idx) {
    state.currentIndex = idx;
    state.half = false;
    renderAll();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function softRemoveSong(idx) {
    const song = state.setlist[idx];
    if (!song) return;
    state.lastRemoved = { song, index: idx };
    state.setlist.splice(idx, 1);
    if (state.currentIndex === idx) state.currentIndex = -1;
    else if (state.currentIndex > idx) state.currentIndex--;
    saveLocal();
    renderAll();
    showUndoToast(`Quitada: ${song.titulo || "Canci√≥n"}`);
  }
  function removeSong(idx, e) { if (e) e.stopPropagation(); softRemoveSong(idx); }

  function saveLocal() { localStorage.setItem("adoranza_v4_setlist", JSON.stringify(state.setlist)); }

  function clearSetlist() {
    state.setlist = [];
    state.currentIndex = -1;
    state.listName = "";
    state.listIdUnico = "";
    state.hasUnsavedChanges = false;
    saveLocal();
    renderAll();
  }

  function showUndoToast(label){
    const t = document.getElementById("toastUndo");
    const m = document.getElementById("toastMsg");
    if (!t || !m) return;
    m.innerText = label || "Quitada";
    t.style.display = "flex";
    if (state.toastT) clearTimeout(state.toastT);
    state.toastT = setTimeout(() => {
      t.style.display = "none";
      state.toastT = null;
      state.lastRemoved = null;
    }, 4500);
  }
  function undoLastRemove(){
    if (!state.lastRemoved) return;
    const { song, index } = state.lastRemoved;
    const idx = Math.max(0, Math.min(index, state.setlist.length));
    state.setlist.splice(idx, 0, song);
    saveLocal();
    state.lastRemoved = null;
    const t = document.getElementById("toastUndo");
    if(t) t.style.display = "none";
    renderAll();
  }

  // ===== NEW CLOUD LOGIC =====
  async function guardarListaCloud() {
    if (!db) { appAlert("EL Data base no est√° listo."); return; }
    if (!state.setlist.length) { appAlert("El setlist est√° vac√≠o."); return; }
  
    const { canciones_ids, canciones_json } = buildCloudSetlistPayload();
  
    if (state.listIdUnico) {
      const target = state.listIdUnico.trim().toUpperCase();
      const payload = {
        canciones_ids,
        canciones_json,            // ‚úÖ SOLO overrides
        owner_id: state.userId,
        owner_name: state.username,
        updated_at: new Date().toISOString()
      };
  
      const { error } = await db.from("setlists_guardados").update(payload).eq("id_unico", target);
      if (error) { appAlert("Error al actualizar: " + error.message); return; }
  
      state.hasUnsavedChanges = false;
      appAlert("Cambios guardados correctamente ‚úÖ");
      if (document.getElementById("configPanel").style.display === "flex") listarMisSetlists();
      renderAll();
      return;
    }
  
    const n = prompt("Nombre del setlist:");
    if (!n) return;
  
    let idUnico = "";
    let lastErr = null;
  
    for (let i = 0; i < 6; i++) {
      idUnico = genSetlistId8("");
      const { error } = await db.from("setlists_guardados").insert({
        nombre_lista: n,
        canciones_ids,
        canciones_json,          // ‚úÖ SOLO overrides
        id_unico: idUnico,
        owner_id: state.userId,
        owner_name: state.username
      });
  
      if (!error) { lastErr = null; break; }
      lastErr = error;
    }
  
    if (lastErr) { appAlert("Error al crear setlist: " + lastErr.message); return; }
  
    state.listName = n;
    state.listIdUnico = idUnico;
    state.hasUnsavedChanges = false;
    appAlert("Guardado con √©xito ‚úÖ\nC√≥digo: " + idUnico);
  
    if (document.getElementById("configPanel").style.display === "flex") listarMisSetlists();
    renderAll();
  }

  async function cargarListaCloud() {
    if (!db) { appAlert("Supabase no est√° listo."); return; }
    if (state.hasUnsavedChanges) {
      if (!confirm("Tienes cambios sin guardar en la lista actual. Si cargas otra, se perder√°n. ¬øDeseas continuar?")) return;
    }
  
    const uid = prompt("Ingresa el ID del Setlist (ej: ENSAYO01):");
    if (!uid) return;
    const want = uid.trim().toUpperCase();
  
    const setlist = await loadSetlistByCode(want, db).catch(e => null);
    if (!setlist) { appAlert("No se encontr√≥: " + want); return; }
  
    state.listName = setlist.nombre_lista || "";
    state.listIdUnico = String(setlist.id_unico || want).trim().toUpperCase();
  
    // ‚úÖ resuelve siempre por IDs, baja el txt actual, aplica overrides
    const resolved = await resolveSetlistSongs(setlist, db);
  
    // adaptar al formato interno de tu app
    state.setlist = resolved.map(s => ({
      ...s,
      body_base: s.body,                 // base viene del fetch
      transpose_steps: s.transpose_steps || 0,
      bpm_override: s.bpm_override ?? null,
    }));
  
    state.hasUnsavedChanges = false;
    localStorage.removeItem(LS_HIDDEN);
    renderAll();
  }


  async function listarMisSetlists() {
    if (!db) return;
    const box = document.getElementById("mySetlists");
    if (box) box.innerHTML = `<div style="color:var(--muted); font-size:12px;">Cargando‚Ä¶</div>`;
    const { data, error } = await db.from("setlists_guardados").select("*").eq("owner_id", state.userId).order("created_at", { ascending: false }).limit(50);
    if (!box) return;
    box.innerHTML = "";
    if (error || !data || data.length === 0) { box.innerHTML = `<div style="color:var(--muted); font-size:12px;">Sin setlists.</div>`; return; }
    (data || []).forEach(row => {
      const id = String(row.id_unico || "").trim().toUpperCase();
      const name = row.nombre_lista || "(Sin nombre)";
      const el = document.createElement("div");
      el.className = "set-item";
      el.style.cursor = "pointer";
      el.innerHTML = `
        <div class="titlebox" style="padding-left:6px;">
          <div class="songtitle">${name}</div>
          <div class="songmeta">ID: <span style="font-family:var(--mono); color:var(--accent);">${id}</span></div>
        </div>
        <button class="btn btn-add" style="max-width:56px;" onclick="copiarSetlistId('${id}', event)">COP</button>
      `;
      el.onclick = () => { copiarSetlistId(id); };
      box.appendChild(el);
    });
  }

  async function copiarSetlistId(id, ev) {
    if (ev) ev.stopPropagation();
    const ok = await copyToClipboard(id);
    appAlert(ok ? `Copiado ‚úÖ\n${id}` : `No copiado\n${id}`);
  }
  async function copiarMiSetlistActual() {
    if (!state.listIdUnico) { appAlert("No hay setlist cargado."); return; }
    await copiarSetlistId(state.listIdUnico.trim().toUpperCase());
  }

  // ===== CONTROLS =====
  function changeFontSize(d) {
    state.currentFontSize += d;
    state.hasUnsavedChanges = true;
    renderAll();
  }
  
  function transpose(delta) {
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;
  
    curr.transpose_steps = (Number.isFinite(curr.transpose_steps) ? curr.transpose_steps : 0) + delta;
  
    // esto s√≠ es ‚Äúcambio sin guardar‚Äù (override de setlist)
    state.hasUnsavedChanges = true;
    renderAll();
  }

  function scrollToReader(){
    // Queremos que el panel fijo quede visible, y la lectura empiece debajo.
    const panel = document.getElementById("fixedControlPanel");
    const view = document.getElementById("viewContent");
    if (!panel || !view) return;
  
    const y = view.getBoundingClientRect().top + window.scrollY - (panel.offsetHeight + 10);
    window.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
  }
  
  function seleccionar(idx) {
    state.currentIndex = idx;
    state.half = false;
    renderAll();
    scrollToReader();
  }
  
  function prevSong() {
    if (state.setlist.length === 0) return;
    if (state.currentIndex <= 0) state.currentIndex = 0;
    else state.currentIndex--;
    state.half = false;
    renderAll();
    scrollToReader();
  }
  
  function nextSong() {
    if (state.setlist.length === 0) return;
    if (state.currentIndex < 0) state.currentIndex = 0;
    else if (state.currentIndex < state.setlist.length - 1) state.currentIndex++;
    state.half = false;
    renderAll();
    scrollToReader();
  }

  function stopScroll() {
    if (state.scrollInt) clearInterval(state.scrollInt);
    state.scrollInt = null;
    const sb = document.getElementById("scrollBtn");
    if (sb) sb.innerText = "AUTO";
  }

  function toggleScroll() {
    if (state.scrollInt) {
      clearInterval(state.scrollInt); state.scrollInt = null;
      document.getElementById("scrollBtn").innerText = "AUTO";
    } else {
      state.scrollInt = setInterval(() => window.scrollBy(0, 1), 50 / state.scrollSpeed);
      document.getElementById("scrollBtn").innerText = "PAUSA";
    }
  }
  function adjScroll(d) {
    state.scrollSpeed = Math.max(0.1, state.scrollSpeed + d);
    if (state.scrollInt) {
      clearInterval(state.scrollInt);
      state.scrollInt = setInterval(() => window.scrollBy(0, 1), 50 / state.scrollSpeed);
    }
  }

  function toggleMetroManual() {
    state.metroActive = !state.metroActive;
    const b = document.getElementById("btnMetroState");
    if (b) b.innerText = state.metroActive ? "‚èπ" : "‚ñ∂";
    state.metroActive ? startMetro() : stopMetro();
  }
  function halfTime() { state.half = !state.half; renderAll(); }
  function startMetro() {
    stopMetro();
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;
    const dots = document.getElementById("metro-dots");
    if (!dots) return;
    dots.innerHTML = "";
    const beats = parseInt(curr.time_signature) || 4;
    for (let i = 0; i < beats; i++) dots.innerHTML += `<div class="beat-dot" id="dot-${i}"></div>`;
    let step = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    state.metroInt = setInterval(() => {
      const vr = document.getElementById("volRange");
      const vol = vr ? parseFloat(vr.value) : 0.5;
      document.querySelectorAll(".beat-dot").forEach(d => d.className = "beat-dot");
      const dot = document.getElementById(`dot-${step}`);
      if (dot) dot.classList.add(step === 0 ? "beat-active-red" : "beat-active-green");
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(step === 0 ? 880 : 440, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol * 0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
      step = (step + 1) % beats;
    }, (60 / state.currentBPM) * 1000);
  }
  function stopMetro() {
    if (state.metroInt) clearInterval(state.metroInt);
    state.metroInt = null;
    const md = document.getElementById("metro-dots");
    if (md) md.innerHTML = "";
  }

  function compartirWhatsApp() {
    if (!state.listIdUnico) { appAlert("Guarda el setlist primero."); return; }
    if (state.hasUnsavedChanges) { appAlert("‚ö†Ô∏è Tienes cambios pendientes. Guarda antes de compartir."); return; }
    const sid = state.listIdUnico.trim().toUpperCase();
    const n = state.listName || "Setlist";
    const url = `${window.location.origin}${window.location.pathname}?sid=${encodeURIComponent(sid)}`;
    const msg = `üé∂ *Setlist:* ${n}\nüîë *C√≥digo:* ${sid}\nüîó Abrir: ${url}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
  }

  async function Estadisticas() {
    if (!db) return;
    const { data } = await db.from("canciones").select("titulo, veces_tocada").gt("veces_tocada", 0).order("veces_tocada", { ascending:false }).limit(5);
    appAlert("TOP 5:\n" + (data || []).map(s => `- ${s.titulo} (${s.veces_tocada})`).join("\n"));
  }

  function attachSwipe(el){
    el.style.touchAction = "pan-y";
    let startX = 0, startY = 0, dx = 0, dy = 0;
    let dragging = false;
    let pointerId = null;
    const wrap = el.closest(".set-item-wrap");
    const reset = () => {
      el.style.transition = "transform .16s ease";
      el.style.transform = "translateX(0px)";
      if (wrap) wrap.classList.remove("is-swiping");
      setTimeout(()=>{ el.style.transition = ""; }, 180);
      dragging = false; dx = dy = 0; pointerId = null;
    };
    const onDown = (ev) => {
      const t = ev.target;
      if (t && (t.closest(".pill") || t.closest(".drag-handle"))) return;
      pointerId = ev.pointerId; startX = ev.clientX; startY = ev.clientY; dx = dy = 0; dragging = false;
    };
    const onMove = (ev) => {
      if (pointerId == null || ev.pointerId !== pointerId) return;
      dx = ev.clientX - startX; dy = ev.clientY - startY;
      if (!dragging) {
        if (Math.abs(dy) > 12 && Math.abs(dy) > Math.abs(dx)) { pointerId = null; return; }
        if (Math.abs(dx) > 10) { dragging = true; try { el.setPointerCapture(ev.pointerId); } catch(e) {} if (wrap) wrap.classList.add("is-swiping"); }
      }
      if (!dragging) return;
      el.style.transform = `translateX(${dx}px)`;
    };
    const onUp = (ev) => {
      const idx = parseInt(el.dataset.idx || "-1", 10);
      if (!dragging) {
        if (Math.abs(dx) <= 8 && Math.abs(dy) <= 8) { if (idx >= 0) seleccionar(idx); }
        reset(); return;
      }
      const width = el.getBoundingClientRect().width || 1;
      const thr = width * 0.28;
      if (dx <= -thr) { reset(); if (idx >= 0) softRemoveSong(idx); return; }
      if (dx >= thr) { reset(); const song = state.setlist[idx]; if (song) { markSung(song, true); setHidden(song, true); saveLocal(); renderAll(); } return; }
      reset();
    };
    el.addEventListener("pointerdown", onDown, { passive:true });
    el.addEventListener("pointermove", onMove, { passive:true });
    el.addEventListener("pointerup", onUp, { passive:true });
    el.addEventListener("pointercancel", reset, { passive:true });
  }

  function initSortable() {
    const el = document.getElementById("setList");
    if (el && window.Sortable) {
      Sortable.create(el, {
        animation: 150,
        handle: ".drag-handle",
        onEnd: (evt) => {
          try {
            // √çndices reales de state.setlist que est√°n visibles (no hidden)
            const visibleIdxs = state.setlist
              .map((s, i) => (!isHidden(s) ? i : null))
              .filter(v => v !== null);
  
            const fromVisible = evt.oldIndex;
            const toVisible = evt.newIndex;
  
            // Guardas
            if (fromVisible == null || toVisible == null) return;
            if (fromVisible === toVisible) return;
            if (fromVisible < 0 || fromVisible >= visibleIdxs.length) return;
            if (toVisible < 0) return;
  
            const fromActual = visibleIdxs[fromVisible];
            if (fromActual == null) return;
  
            // Sacar el item real
            const item = state.setlist.splice(fromActual, 1)[0];
            if (!item) return;
  
            // Recalcular visibles despu√©s de remover
            const visibleIdxs2 = state.setlist
              .map((s, i) => (!isHidden(s) ? i : null))
              .filter(v => v !== null);
  
            // Determinar √≠ndice real de inserci√≥n
            let insertAt;
            if (toVisible >= visibleIdxs2.length) {
              insertAt = state.setlist.length; // al final
            } else {
              insertAt = visibleIdxs2[toVisible];
            }
  
            state.setlist.splice(insertAt, 0, item);
  
            saveLocal();
            renderAll();
          } catch (e) {
            console.error("Sortable onEnd error:", e);
            appAlert("Error al reordenar. Reintent√°.");
            renderAll();
          }
        }
      });
    }
  }


  // ===== STARTUP =====
  async function revisarLinkSetlistId() {
    const p = new URLSearchParams(window.location.search);
    const sid = p.get("sid");
    if (!sid || !db) return false;
    const want = sid.trim().toUpperCase();
    const { data } = await db.from("setlists_guardados").select("*").eq("id_unico", want).single();
    if (!data) return true;
    state.listName = data.nombre_lista || "";
    state.listIdUnico = String(data.id_unico || "").trim().toUpperCase();
    let raw = data.canciones_ids;
    if (typeof raw === 'string') { try { raw = JSON.parse(raw); } catch(e) { raw = []; } }
    if (!Array.isArray(raw)) raw = [];
    
    state.setlist = [];
    // Logica simplificada para startup link: tratamos de cargar lo que venga
    const idsLegacy = [];
    for(let item of raw){
      if(typeof item === 'object' && item.body){
         state.setlist.push(item);
      } else {
         const id = (typeof item === 'object') ? item.id : item;
         idsLegacy.push(String(id));
         state.setlist.push({ isPlaceholder:true, id:String(id) });
      }
    }
    if(idsLegacy.length > 0){
      const { data: cans } = await db.from("canciones").select("*").in("id", idsLegacy);
      if(cans){
        for(let i=0; i<state.setlist.length; i++){
          if(state.setlist[i].isPlaceholder){
             const f = cans.find(c=>String(c.id) === state.setlist[i].id);
             if(f) {
                try {
                  const b = await fetchSongBodyFromBucket(f);
                  state.setlist[i] = { ...f, body: b };
                } catch(e) { state.setlist[i] = f; }
             }
          }
        }
      }
    }
    state.setlist = state.setlist.filter(s => !s.isPlaceholder);
    localStorage.removeItem(LS_HIDDEN);
    renderAll();
    window.history.replaceState({}, "", window.location.pathname);
    return true;
  }

  window.onload = async () => {
    ensureLocalUserOrBlock();
    const ud = document.getElementById("uid-display");
    const un = document.getElementById("uname-display");
    if (ud) ud.innerText = state.userId;
    if (un) un.innerText = state.username;

    db = initSupabaseOrWarn();
    await upsertUserToCloudNonBlocking();

    const sb = document.getElementById("searchBox");
    if (sb) {
      sb.oninput = async (e) => {
        const val = (e.target.value || "").trim();
        const resDiv = document.getElementById("results");
        if (!resDiv) return;
    
        if (!db) { resDiv.innerHTML = ""; return; }
        if (val.length < 2) { resDiv.innerHTML = ""; return; }
    
        const { data, error } = await db
          .from("canciones")
          .select("*")
          .or(`titulo.ilike.%${val}%,artista.ilike.%${val}%`)
          .limit(6);
    
        if (error) { console.error(error); resDiv.innerHTML = ""; return; }
    
        resDiv.innerHTML = "";
        (data || []).forEach((s) => {
          const d = document.createElement("div");
          d.className = "set-item";
          d.innerHTML = `
            <div style="flex:1">
              <div style="font-weight:600; font-size:13px;">${s.titulo || ""}</div>
              <div style="font-size:11px; color:var(--muted); margin-top:2px;">${s.artista || ""}</div>
            </div>
            <button class="btn btn-add">ADD</button>
          `;
    
          const btn = d.querySelector(".btn-add");
          if (btn) {
            btn.onclick = (ev) => {
              ev.stopPropagation();
              addToSetlist(s);
            };
          }
    
          resDiv.appendChild(d);
        });
      };
    }


    initSortable();
    let handled = false;
    if (db) handled = await revisarLinkSetlistId();
    renderAll();
  };
  
  function appAlert(message) {
  const box = document.getElementById("appAlert");
  const msg = document.getElementById("appAlertMsg");
  const ok = document.getElementById("appAlertOk");
  if (!box || !msg || !ok) return alert(message); // fallback

  msg.textContent = message;
  box.style.display = "block";
  ok.onclick = () => (box.style.display = "none");
}

  window.onerror = function (msg, src, line, col, err) {
  appAlert("JS ERROR: " + msg + "\nL√≠nea: " + (line || 0));
  return false;
};


  window.addEventListener("error", (e) => {
  const msg = e?.message || "Unknown error";
  const src = e?.filename || "";
  const line = e?.lineno || 0;
  const col = e?.colno || 0;
  appAlert(`JS ERROR: ${msg}\n${src ? "Src: " + src + "\n" : ""}L√≠nea: ${line}:${col}`);
});

window.addEventListener("unhandledrejection", (e) => {
  const reason = e?.reason;
  const msg = (reason && (reason.message || String(reason))) || "Unhandled promise rejection";
  appAlert(`PROMISE ERROR: ${msg}`);
});

  
  // Expose globals
  window.toggleFavByIndex = toggleFavByIndex;
  window.renderFavoritesInConfig = renderFavoritesInConfig;
  window.openFavorite = openFavorite;
  window.removeFavorite = removeFavorite;
  window.setRole = setRole;
  window.openConfig = openConfig;
  window.closeConfig = closeConfig;
  window.showHome = showHome;
  window.listarMisSetlists = listarMisSetlists;
  window.copiarSetlistId = copiarSetlistId;
  window.copiarMiSetlistActual = copiarMiSetlistActual;
  window.Estadisticas = Estadisticas;
  window.guardarListaCloud = guardarListaCloud;
  window.cargarListaCloud = cargarListaCloud;
  window.clearOrCloseSetlist = clearOrCloseSetlist;
  window.compartirWhatsApp = compartirWhatsApp;
  window.prevSong = prevSong;
  window.nextSong = nextSong;
  window.transpose = transpose;
  window.changeFontSize = changeFontSize;
  window.toggleScroll = toggleScroll;
  window.adjScroll = adjScroll;
  window.toggleMetroManual = toggleMetroManual;
  window.halfTime = halfTime;
  window.addToSetlist = addToSetlist;
  window.seleccionar = seleccionar;
  window.removeSong = removeSong;
  window.undoLastRemove = undoLastRemove;
  window.checkUnsavedChanges = () => state.hasUnsavedChanges;

  // ===== PWA: Service Worker =====
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("./sw.js")
      .then(() => console.log("SW registrado"))
      .catch(err => console.warn("SW error", err));
  });
}
</script>
  
  <div id="appAlert" style="display:none; position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,.55);">
  <div style="max-width:520px; margin:14vh auto; background:#111; color:#fff; border-radius:16px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.55);">
    <div style="font-weight:700; font-size:18px; margin-bottom:10px;">Adoranza</div>
    <div id="appAlertMsg" style="white-space:pre-wrap; line-height:1.35; opacity:.95;"></div>
    <div style="text-align:right; margin-top:14px;">
      <button id="appAlertOk" style="padding:10px 14px; border-radius:12px; border:none; background:#2b6cff; color:white; font-weight:700;">OK</button>
    </div>
  </div>
</div>

</body>
</html>
