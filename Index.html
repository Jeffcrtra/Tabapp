<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4.11 TabApp â€“ Drive Edition</title>
  <style>
    :root{
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --ok:#33d17a; --danger:#ff5c77;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:radial-gradient(1200px 700px at 20% 0%, #1b2240 0%, var(--bg) 55%); color:var(--text);}
    header{position:sticky; top:0; backdrop-filter: blur(10px); background:rgba(11,13,18,.65); border-bottom:1px solid var(--line); z-index:10;}
    .wrap{max-width:1180px; margin:0 auto; padding:16px;}
    .row{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    h1{font-size:18px; margin:0; letter-spacing:.3px;}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; padding:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }
    
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:14px;}
    .card .hd{padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
    .card .bd{padding:14px;}
    
    .btn{appearance:none; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); padding:10px 12px; border-radius:14px; cursor:pointer; font-weight:650; display:inline-flex; align-items:center; justify-content:center; transition: 0.2s;}
    .btn:active{transform: scale(0.95);}
    .btn.accent{background:rgba(255,213,74,.15); border-color:rgba(255,213,74,.45);}
    .btn.small{padding: 6px 10px; font-size: 13px;}
    
    .input, textarea{width:100%; padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--text); outline:none;}
    textarea{min-height:300px; font-family:var(--mono); font-size:14px;}
    
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(255,255,255,.02); display:flex; justify-content:space-between; align-items:center;}
    
    /* --- MEJORAS DEL VISOR --- */
    .viewer {
      min-height: 80vh; 
      display: flex;
      flex-direction: column;
    }
    .viewer-tools {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .font-controls {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255,255,255,0.05);
      padding: 5px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
    }
    #viewContent {
      flex-grow: 1;
      background: rgba(0,0,0,0.25);
      padding: 20px;
      border-radius: 14px;
      border: 1px solid var(--line);
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: var(--mono);
      font-size: 18px; 
      line-height: 1.55;
    }
    .chord{color:var(--accent); font-weight:bold;}
    
    .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index:99;}
    .modal{width:90%; max-width:800px; background:var(--bg); border-radius:var(--radius); padding:20px;}
    .sub{color:var(--muted); font-size:12px;}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;">
      <h1>ðŸŽ¸ TabApp + Drive</h1>
      <div class="row">
        <button class="btn accent" id="btnAuth" style="display:none;">Conectar Google Drive</button>
        <button class="btn" id="btnSignOut" style="display:none;">Salir</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd"><b>Buscador en tu Drive</b></div>
      <div class="bd">
        <input class="input" id="searchDrive" placeholder="Escribe para buscar en carpeta..." />
        <div id="driveStatus" style="font-size:12px; color:var(--muted); margin-top:8px;"></div>
        <div class="list" id="driveResults" style="margin-top:14px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <b>Setlist del DÃ­a</b>
        <button class="btn small" onclick="clearSetlist()">Vaciar Set</button>
      </div>
      <div class="bd">
        <div class="list" id="setList"></div>
        <hr style="border:0; border-top:1px solid var(--line); margin:20px 0;">
        <div class="viewer">
          <h2 id="viewTitle">Selecciona una canciÃ³n</h2>
  
            <div class="viewer-tools">
              <button class="btn" id="btnPrev">âŸµ</button>
              <button class="btn" id="btnNext">âŸ¶</button>
              
              <div class="font-controls">
                <span style="font-size: 12px; color: var(--muted);">Zoom:</span>
                <button class="btn small" onclick="changeFontSize(-2)">A-</button>
                <button class="btn small" onclick="changeFontSize(2)">A+</button>
              </div>
              
              <button class="btn" id="btnEdit">Editar</button>
            </div>
          
            <pre id="viewContent"></pre>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="modal-back" id="modalBack">
  <div class="modal">
    <h3>Editar temporalmente</h3>
    <input class="input" id="editTitle" style="margin-bottom:10px;">
    <textarea id="editBody"></textarea>
    <div class="row" style="margin-top:10px; justify-content:flex-end;">
      <button class="btn" onclick="closeEditor()">Cerrar</button>
      <button class="btn accent" onclick="saveSong()">Guardar</button>
    </div>
  </div>
</div>

<script>
  // CONFIGURACIÃ“N
  const CLIENT_ID = '95122523294-nqd6v1n18o4mba2dus66vorql322gckp.apps.googleusercontent.com';
  const FOLDER_ID = '1x6zy_Bor6i9qBhUIl27ZIG0E1qdf5Ye6'; 
  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

  let tokenClient;
  let gapiInited = false;
  let gsiInited = false;
  
  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_setlist') || '[]'),
    currentIndex: -1
  };

  // --- INICIALIZACIÃ“N DE GOOGLE ---
  function gapiLoaded() { gapi.load('client', () => { gapi.client.init({discoveryDocs: DISCOVERY_DOCS}).then(() => { gapiInited = true; checkAuth(); })}); }
  function gsiLoaded() { 
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID, scope: SCOPES, callback: (resp) => { 
        if (resp.error) return; 
        buscarEnDrive(); 
        document.getElementById('btnAuth').style.display='none'; 
        document.getElementById('btnSignOut').style.display='block'; 
      }
    });
    gsiInited = true;
    checkAuth();
  }

  function checkAuth() { if(gapiInited && gsiInited) document.getElementById('btnAuth').style.display = 'block'; }
  document.getElementById('btnAuth').onclick = () => tokenClient.requestAccessToken({prompt: 'consent'});
  document.getElementById('btnSignOut').onclick = () => { gapi.client.setToken(''); location.reload(); };

  // --- BUSCADOR DRIVE ---
  let searchTimeout;
  document.getElementById('searchDrive').oninput = (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value;
      searchTimeout = setTimeout(() => { buscarEnDrive(query); }, 400);
  };

  async function buscarEnDrive(nameQ = "") {
    const resDiv = document.getElementById('driveResults');
    resDiv.innerHTML = "<div class='sub'>Buscando...</div>";
    try {
        let q = `'${FOLDER_ID}' in parents and mimeType = 'text/plain' and trashed = false`;
        if (nameQ.trim() !== "") q += ` and name contains '${nameQ}'`;
        
        const response = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)', orderBy: 'name' });
        const files = response.result.files;
        resDiv.innerHTML = "";

        if (!files || files.length === 0) {
            resDiv.innerHTML = "<div class='sub'>No se encontraron canciones.</div>";
            return;
        }

        files.forEach(f => {
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
                <div style="min-width:0; flex:1;">
                    <span style="font-weight:bold;">${f.name.replace('.txt','')}</span>
                </div>
                <button class="btn accent small" onclick="importar('${f.id}', '${f.name}')">AÃ±adir</button>`;
            resDiv.appendChild(item);
        });
    } catch (err) { resDiv.innerHTML = "<div class='sub' style='color:var(--danger)'>Error de conexiÃ³n</div>"; }
  }

  async function importar(id, name) {
    const resp = await gapi.client.drive.files.get({ fileId: id, alt: 'media' });
    const newSong = { id: Date.now(), title: name.replace('.txt',''), body: resp.body };
    state.setlist.push(newSong);
    state.currentIndex = state.setlist.length - 1;
    saveLocal();
    renderAll();
  }

  // --- LOGICA DE TAMAÃ‘O DE LETRA ---
  let currentFontSize = 18; 
  function changeFontSize(delta) {
      currentFontSize += delta;
      if (currentFontSize < 10) currentFontSize = 10;
      if (currentFontSize > 45) currentFontSize = 45;
      const content = document.getElementById('viewContent');
      if (content) {
          content.style.fontSize = currentFontSize + 'px';
          localStorage.setItem('pref_font_size', currentFontSize);
      }
  }

  // --- NAVEGACIÃ“N Y RENDER ---
  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const item = document.createElement('div');
      item.className = 'item';
      if(idx === state.currentIndex) item.style.borderColor = 'var(--accent)';
      item.innerHTML = `<span>${idx + 1}. ${s.title}</span><button class="btn small" onclick="seleccionar(${idx})">Ver</button>`;
      sl.appendChild(item);
    });

    const curr = state.setlist[state.currentIndex];
    if (curr) {
      document.getElementById('viewTitle').innerText = curr.title;
      document.getElementById('viewContent').innerHTML = curr.body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
    }
  }

  function seleccionar(idx) { state.currentIndex = idx; renderAll(); }
  function saveLocal() { localStorage.setItem('tabs_setlist', JSON.stringify(state.setlist)); }
  function clearSetlist() { if(confirm("Â¿Vaciar lista del dÃ­a?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }

  document.getElementById('btnNext').onclick = () => { if(state.currentIndex < state.setlist.length-1) {state.currentIndex++; renderAll();} };
  document.getElementById('btnPrev').onclick = () => { if(state.currentIndex > 0) {state.currentIndex--; renderAll();} };

  // Modales
  document.getElementById('btnEdit').onclick = () => {
    const s = state.setlist[state.currentIndex];
    if(!s) return;
    document.getElementById('editTitle').value = s.title;
    document.getElementById('editBody').value = s.body;
    document.getElementById('modalBack').style.display = 'flex';
  };
  function closeEditor() { document.getElementById('modalBack').style.display = 'none'; }
  function saveSong() {
    const s = state.setlist[state.currentIndex];
    s.title = document.getElementById('editTitle').value;
    s.body = document.getElementById('editBody').value;
    saveLocal(); renderAll(); closeEditor();
  }

  // Al cargar
  window.addEventListener('load', () => {
      const savedSize = localStorage.getItem('pref_font_size');
      if (savedSize) {
          currentFontSize = parseInt(savedSize);
          document.getElementById('viewContent').style.fontSize = currentFontSize + 'px';
      }
      if(state.setlist.length > 0) {
          state.currentIndex = 0;
          renderAll();
      }
  });
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gsiLoaded()"></script>
</body>
</html>
