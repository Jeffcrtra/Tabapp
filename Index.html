<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>00.20 Adoranza Pro v4.11</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --success:#4aff80; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--sans); background: var(--bg); color: var(--text); overflow-x: hidden; padding-top: 240px; }
    
    /* PANTALLA INICIAL */
    #roleSelector {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: var(--bg); z-index: 10000; display: flex; 
      flex-direction: column; align-items: center; justify-content: center; gap: 20px;
    }
    .role-grid { display: grid; gap: 14px; grid-template-columns: repeat(3, 1fr); width: min(95vw, 500px); }
    .role-btn {
      background: var(--card); border: 2px solid var(--line); padding: 15px 10px;
      border-radius: 20px; text-align: center; font-size: 28px; cursor: pointer; color: white;
      display: flex; flex-direction: column; align-items: center; transition: 0.3s;
    }
    .role-btn:hover { border-color: var(--accent); transform: translateY(-5px); }
    .role-btn small { font-size: 10px; margin-top: 8px; color: var(--muted); font-weight: bold; }
    
    .footer-credits { position: absolute; bottom: 20px; font-size: 12px; color: var(--muted); text-align: center; }
    .footer-credits a { color: var(--accent); text-decoration: none; font-weight: bold; }

    /* CONTROLES SUPERIORES */
    #fixedControlPanel { 
      position: fixed; top: 0; left: 0; right: 0; z-index: 999;
      background: rgba(11, 13, 18, 0.98); backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--line); padding: 12px 10px;
    }
    .viewer-tools { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
    .tool-group { display: flex; gap: 4px; justify-content: center; align-items: center; padding: 4px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.02); }

    .btn { border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 8px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-nav { background-color: #004173 !important; }
    .btn-tone { background-color: #630b57 !important; }
    .btn-font { background-color: #2E6F40 !important; }
    .btn-scroll { background-color: #d09306 !important; }
    .btn-drums { background-color: #444 !important; border-color: var(--success); color: var(--success); }
    .btn-save { background-color: #1a1a1a; border-color: var(--success); color: var(--success); }
    .btn.danger-x { border-color: var(--danger); color: var(--danger); background: rgba(255, 92, 119, 0.1); }

    /* METR√ìNOMO DRAM√ÅTICO */
    #metro-dots { margin-top: 10px; display: flex; justify-content: center; gap: 15px; height: 45px; align-items: center; }
    .beat-dot { width: 35px; height: 35px; border-radius: 50%; background: #222; border: 2px solid #333; transition: 0.1s; }
    .beat-active-red { background: var(--danger); box-shadow: 0 0 25px var(--danger); transform: scale(1.15); border-color: #fff; }
    .beat-active-green { background: var(--success); box-shadow: 0 0 25px var(--success); transform: scale(1.15); border-color: #fff; }

    /* CONFIG PAGE COMPLETA */
    #configPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10001; display: none; flex-direction: column; align-items: center; padding: 40px 20px; }

    .wrap { padding: 10px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .grid { grid-template-columns: 280px 1fr; } }
    
    #setlist-container { width: 92%; margin: 0 auto; }
    .card { background: rgba(255,255,255,.02); border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 10px; }
    .card .hd { padding: 10px; border-bottom: 1px solid var(--line); font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; align-items: center; }
    .card .bd { padding: 10px; }
    
    .input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--line); background: rgba(0,0,0,.4); color: white; outline: none; font-size: 16px; }
    .item { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; cursor: pointer; touch-action: none; }
    #viewContent { background: rgba(0,0,0,.4); padding: 25px; border-radius: 15px; white-space: pre-wrap; font-family: var(--mono); line-height: 1.8; border: 1px solid var(--line); }
    .chord { color: var(--accent); font-weight: bold; }
    #current-song-info { font-weight: bold; color: var(--accent); font-size: 14px; text-align: center; margin-top: 8px; }
  </style>
</head>
<body>

<div id="roleSelector">
    <h1 style="color:var(--accent); margin:0; font-size: 24px;">ADORANZA PRO v4.11</h1>
    <div class="role-grid">
        <div class="role-btn" onclick="setRole('vocal')">üé§<small>VOCAL</small></div>
        <div class="role-btn" onclick="setRole('musico')">üé∏<small>M√öSICO</small></div>
        <div class="role-btn" onclick="setRole('drums')">ü•Å<small>BATER√çA</small></div>
        <div class="role-btn" onclick="verEstadisticas()" style="grid-column: span 1.5">üìä<small>STATS</small></div>
        <div class="role-btn" onclick="openConfig()" style="grid-column: span 1.5">‚öôÔ∏è<small>CONFIG</small></div>
    </div>
    <div class="footer-credits">
        App creada por <a href="https://www.linkedin.com/in/jeffrey-trigueros-371191123/" target="_blank">Jeffrey Trigueros</a>
    </div>
</div>

<div id="configPanel">
    <button class="btn btn-nav" style="margin-bottom: 30px; width: 120px;" onclick="closeConfig()">üè† Home</button>
    <div class="card" style="width: 100%; max-width: 400px;">
        <div class="hd">Perfil de Usuario</div>
        <div class="bd" style="text-align: center;">
            <p style="color:var(--muted)">Tu ID de usuario:</p>
            <h2 id="uid-display" style="color:var(--accent); font-family:var(--mono); letter-spacing: 2px;"></h2>
            <button class="btn" style="background:#333; margin-top: 15px;" onclick="resetUID()">Generar Nuevo ID</button>
        </div>
    </div>
</div>

<div id="fixedControlPanel">
    <div class="viewer-tools">
      <div class="tool-group"><button class="btn btn-nav" onclick="prevSong()">‚üµ</button><button class="btn btn-nav" onclick="nextSong()">‚ü∂</button></div>
      
      <div class="tool-group" id="tone-group"><button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button><button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button></div>
      
      <div class="tool-group" id="drums-group" style="display:none;">
          <button class="btn btn-drums" onclick="toggleMetroManual()" id="btnMetroState" style="min-width: 45px;">‚ñ∂</button>
          <button class="btn btn-drums" onclick="halfTime()" style="font-size:10px;">1/2 BPM</button>
      </div>

      <div class="tool-group"><button class="btn btn-nav" onclick="showHome()" style="width:100%;">üè† Inicio</button></div>
      <div class="tool-group"><button class="btn btn-font" onclick="changeFontSize(-2)">A-</button><button class="btn btn-font" onclick="changeFontSize(2)">A+</button></div>
      
      <div class="tool-group" style="grid-column: span 2;">
          <button class="btn btn-scroll" onclick="adjScroll(-0.1)">-</button>
          <button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()" style="flex:1; font-size: 11px;">AUTO ‚ñ∂</button>
          <button class="btn btn-scroll" onclick="adjScroll(0.1)">+</button>
      </div>
    </div>
    
    <div id="volume-container" style="display:none; text-align:center; margin-top:10px;">
        <small style="font-size: 11px; color: var(--muted);">VOL CLICK:</small> 
        <input type="range" id="volRange" min="0" max="1" step="0.1" value="0.5" style="vertical-align:middle; width: 100px;">
    </div>

    <div id="info-display">
      <div id="current-song-info">Adoranza Cloud</div>
      <div id="metro-dots"></div>
    </div>
</div>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd">Buscador</div>
      <div class="bd">
        <input class="input" id="searchBox" placeholder="Escribe para buscar..." autocomplete="off" />
        <div id="results" style="margin-top:12px; display:none; flex-direction:column; gap:8px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        Mi Setlist 
        <div style="display:flex; gap:5px;">
            <button class="btn btn-save" style="padding:4px 8px; font-size:10px" onclick="guardarListaCloud()">Guardar</button>
            <button class="btn" style="padding:4px 8px; font-size:10px; background:#333;" onclick="cargarListaCloud()">Cargar</button>
            <button class="btn danger-x" style="padding:4px 8px; font-size:10px" onclick="clearSetlist()">Vaciar</button>
        </div>
      </div>
      <div class="bd" id="setlist-container"><div id="setList"></div></div>
    </section>

    <section class="card" style="grid-column: 1 / -1; border:none; background:none;">
      <pre id="viewContent">Selecciona una canci√≥n del setlist.</pre>
    </section>
  </div>
</main>

<script>
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdGxianZqb3FwcW9rbHZqZHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NzY4NDUsImV4cCI6MjA4MzU1Mjg0NX0.AQg9BuuGlbUtuyccvrBJwRGzx4Bgzx58aqGbfMPzKfg";
  const db = supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  const state = {
    setlist: JSON.parse(localStorage.getItem('adoranza_v4_setlist') || '[]'),
    currentIndex: -1, currentFontSize: 18,
    scrollInt: null, scrollSpeed: 0.5, userRole: 'musico', metroInt: null,
    metroActive: false, currentBPM: 120, half: false,
    userId: localStorage.getItem('adoranza_uid') || generateUID()
  };

  function generateUID() {
    const id = "AD-" + Math.random().toString(36).substr(2, 4).toUpperCase();
    localStorage.setItem('adoranza_uid', id);
    return id;
  }

  window.onload = () => {
    document.getElementById('uid-display').innerText = state.userId;
    renderAll();
    initSortable();
  };

  function setRole(role) {
    state.userRole = role;
    document.getElementById('roleSelector').style.display = 'none';
    document.getElementById('tone-group').style.display = (role === 'musico') ? 'flex' : 'none';
    document.getElementById('drums-group').style.display = (role === 'drums') ? 'flex' : 'none';
    document.getElementById('volume-container').style.display = (role === 'drums') ? 'block' : 'none';
    renderAll();
  }

  function openConfig() { document.getElementById('configPanel').style.display = 'flex'; }
  function closeConfig() { document.getElementById('configPanel').style.display = 'none'; }
  function resetUID() { if(confirm("¬øGenerar nuevo ID de usuario?")) { state.userId = generateUID(); document.getElementById('uid-display').innerText = state.userId; } }
  function showHome() { document.getElementById('roleSelector').style.display = 'flex'; stopMetro(); }

  document.getElementById('searchBox').oninput = async (e) => {
    const val = e.target.value;
    const resDiv = document.getElementById('results');
    if (val.length < 2) { resDiv.style.display = "none"; return; }
    const { data } = await db.from('canciones').select('*').or(`titulo.ilike.%${val}%,artista.ilike.%${val}%`).limit(6);
    if (data) {
      resDiv.style.display = "flex"; resDiv.innerHTML = "";
      data.forEach(song => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><b>${song.titulo}</b></div><button class="btn" style="color:var(--accent)" onclick='addToSetlist(${JSON.stringify(song)})'>+</button>`;
        resDiv.appendChild(div);
      });
    }
  };

  async function addToSetlist(song) {
    const resp = await fetch(BUCKET_URL + song.path_url);
    const text = await resp.text();
    state.setlist.push({ ...song, body: text.replace(/\{(\w+):\s*([^}]+)\}/g, '').trim() });
    saveLocal(); renderAll();
  }

  function renderAll() {
    const sl = document.getElementById('setList'); 
    if(!sl) return;
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      if(idx === state.currentIndex) div.style.borderColor = 'var(--accent)';
      // Click en el nombre selecciona la canci√≥n
      div.onclick = () => seleccionar(idx);
      div.innerHTML = `<div style="flex:1">‚ò∞ ${s.titulo}</div>
                       <button class="btn danger-x" onclick="removeSong(${idx}, event)">‚úï</button>`;
      sl.appendChild(div);
    });

    const curr = state.setlist[state.currentIndex];
    const view = document.getElementById('viewContent');
    const info = document.getElementById('current-song-info');

    if(curr && view) {
      info.innerText = `${curr.titulo} | BPM: ${state.half ? curr.bpm/2 : curr.bpm}`;
      let body = curr.body;
      if (state.userRole !== 'musico') body = body.replace(/\[([^\]]+)\]/g, ''); 
      else body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
      view.innerHTML = body;
      view.style.fontSize = state.currentFontSize + 'px';
      state.currentBPM = state.half ? curr.bpm/2 : curr.bpm;
      
      if (state.userRole === 'drums' && state.metroActive) startMetro();
    } else if (view) {
      view.innerHTML = "Selecciona una canci√≥n del setlist.";
      info.innerText = "Adoranza Cloud";
      stopMetro();
    }
  }

  function seleccionar(idx) { 
    state.currentIndex = idx; 
    state.half = false; 
    renderAll(); 
    window.scrollTo({top:0, behavior:'smooth'}); 
  }

  function removeSong(idx, e) { 
    e.stopPropagation(); 
    state.setlist.splice(idx, 1); 
    if (state.currentIndex === idx) state.currentIndex = -1;
    saveLocal(); renderAll(); 
  }

  function toggleMetroManual() {
    state.metroActive = !state.metroActive;
    document.getElementById('btnMetroState').innerText = state.metroActive ? "‚èπ" : "‚ñ∂";
    state.metroActive ? startMetro() : stopMetro();
  }

  function halfTime() {
    state.half = !state.half;
    renderAll();
  }

  function startMetro() {
    stopMetro();
    const curr = state.setlist[state.currentIndex];
    if(!curr) return;
    const dots = document.getElementById('metro-dots'); dots.innerHTML = "";
    const beats = parseInt(curr.time_signature) || 4;
    for(let i=0; i<beats; i++) dots.innerHTML += `<div class="beat-dot" id="dot-${i}"></div>`;
    
    let step = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const vol = parseFloat(document.getElementById('volRange').value);

    state.metroInt = setInterval(() => {
      document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('beat-active-red', 'beat-active-green'));
      const dot = document.getElementById(`dot-${step}`);
      if(dot) dot.classList.add(step === 0 ? 'beat-active-red' : 'beat-active-green');
      
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(step === 0 ? 880 : 440, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol * 0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
      step = (step + 1) % beats;
    }, (60 / state.currentBPM) * 1000);
  }

  function stopMetro() { clearInterval(state.metroInt); document.getElementById('metro-dots').innerHTML = ""; }
  function saveLocal() { localStorage.setItem('adoranza_v4_setlist', JSON.stringify(state.setlist)); }
  function clearSetlist() { if(confirm("¬øVaciar Setlist?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }
  function nextSong() { if(state.currentIndex < state.setlist.length-1) seleccionar(state.currentIndex+1); }
  function prevSong() { if(state.currentIndex > 0) seleccionar(state.currentIndex-1); }
  
  function toggleScroll() { 
    if(state.scrollInt) { clearInterval(state.scrollInt); state.scrollInt = null; document.getElementById('scrollBtn').innerText = "AUTO ‚ñ∂"; }
    else { state.scrollInt = setInterval(() => window.scrollBy(0,1), 50/state.scrollSpeed); document.getElementById('scrollBtn').innerText = "PAUSA ‚è∏"; }
  }
  function adjScroll(d) { state.scrollSpeed = Math.max(0.1, state.scrollSpeed + d); }

  function transpose(delta) {
    const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;
    curr.body = curr.body.replace(/\[([^\]]+)\]/g, (m, chord) => {
      return "[" + chord.replace(/[A-G]#?/g, (note) => {
        let idx = scale.indexOf(note);
        return idx === -1 ? note : scale[(idx + delta + 12) % 12];
      }) + "]";
    });
    renderAll();
  }

  function initSortable() {
    const el = document.getElementById('setList');
    if(el) Sortable.create(el, { animation: 150, handle: 'div', onEnd: (evt) => {
        const item = state.setlist.splice(evt.oldIndex, 1)[0];
        state.setlist.splice(evt.newIndex, 0, item);
        state.currentIndex = evt.newIndex;
        saveLocal();
    }});
  }

  async function guardarListaCloud() { alert("Funci√≥n de nube habilitada."); }
  async function cargarListaCloud() { alert("Conectando con base de datos..."); }
  async function verEstadisticas() { alert("Estad√≠sticas de uso cargando..."); }
</script>
</body>
</html>
