<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>2.05 Adoranza Pro v4.15</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --success:#4aff80; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, sans-serif;
    }
    * { box-sizing: border-box; touch-action: pan-y; } /* Permite scroll y swipe */
    body { margin: 0; font-family: var(--sans); background: var(--bg); color: var(--text); overflow-x: hidden; padding-top: 240px; }
    
    #roleSelector { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
    .role-grid { display: grid; gap: 14px; grid-template-columns: repeat(3, 1fr); width: min(95vw, 500px); }
    .role-btn { background: var(--card); border: 2px solid var(--line); padding: 15px 10px; border-radius: 20px; text-align: center; font-size: 28px; cursor: pointer; color: white; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
    .role-btn:hover { border-color: var(--accent); transform: translateY(-5px); }
    .role-btn small { font-size: 10px; margin-top: 8px; color: var(--muted); font-weight: bold; line-height: 1.2; text-transform: uppercase; }

    #fixedControlPanel { position: fixed; top: 0; left: 0; right: 0; z-index: 999; background: rgba(11, 13, 18, 0.98); backdrop-filter: blur(10px); border-bottom: 2px solid var(--line); padding: 12px 10px; }
    .viewer-tools { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 500px; margin: 0 auto; }
    .tool-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; justify-content: center; align-items: center; padding: 4px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.02); }
    .tool-group.triple { grid-template-columns: repeat(3, 1fr); grid-column: span 2; }
    .btn { border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px 5px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; width: 100%; height: 40px; }
    .btn-nav { background-color: #004173 !important; }
    .btn-tone { background-color: #630b57 !important; }
    .btn-font { background-color: #2E6F40 !important; }
    .btn-scroll { background-color: #d09306 !important; }
    .btn-drums { background-color: #444 !important; border-color: var(--success); color: var(--success); }
    
    /* Swipe Styles */
    .item-container { position: relative; overflow: hidden; border-radius: 12px; margin-bottom: 8px; }
    .item { 
      position: relative; z-index: 2; border: 1px solid var(--line); border-radius: 12px; padding: 12px; 
      background: #1a1f2e; display: flex; justify-content: space-between; align-items: center; 
      transition: transform 0.3s ease; 
    }
    .item.played { opacity: 0.3; transform: translateX(20px); filter: grayscale(1); }
    .swipe-action { 
      position: absolute; top: 0; bottom: 0; width: 100%; display: flex; align-items: center; 
      color: white; font-weight: bold; font-size: 12px; z-index: 1; 
    }
    .action-delete { background: var(--danger); justify-content: flex-start; padding-left: 20px; }
    .action-played { background: var(--success); justify-content: flex-end; padding-right: 20px; }

    #metro-dots { margin-top: 10px; display: flex; justify-content: center; gap: 15px; height: 45px; align-items: center; }
    .beat-dot { width: 35px; height: 35px; border-radius: 50%; background: #222; border: 2px solid #333; }
    .beat-active-red { background: var(--danger); box-shadow: 0 0 25px var(--danger); border-color: #fff; }
    .beat-active-green { background: var(--success); box-shadow: 0 0 25px var(--success); border-color: #fff; }

    .wrap { padding: 10px; max-width: 1200px; margin: 0 auto; }
    #viewContent { background: rgba(0,0,0,.4); padding: 25px; border-radius: 15px; white-space: pre-wrap; font-family: var(--mono); line-height: 1.6; border: 1px solid var(--line); }
    .chord { color: var(--accent); font-weight: bold; }
  </style>
</head>
<body>

<div id="roleSelector">
    <h1 style="color:var(--accent); margin:0; font-size: 24px;">ADORANZA PRO v4.15</h1>
    <div class="role-grid">
        <div class="role-btn" onclick="setRole('vocal')">üé§<small>VOCAL</small></div>
        <div class="role-btn" onclick="setRole('musico')">üé∏<small>PIANO<br>GUITARRA</small></div>
        <div class="role-btn" onclick="setRole('drums')">ü•Å<small>BATER√çA<br>VOZ</small></div> <div class="role-btn" onclick="verEstadisticas()" style="grid-column: span 1.5">üìä<small>STATS</small></div>
        <div class="role-btn" onclick="openConfig()" style="grid-column: span 1.5">‚öôÔ∏è<small>CONFIG</small></div>
    </div>
</div>

<div id="fixedControlPanel">
    <div class="viewer-tools">
      <div class="tool-group"><button class="btn btn-nav" onclick="prevSong()">‚üµ</button><button class="btn btn-nav" onclick="nextSong()">‚ü∂</button></div>
      <div class="tool-group" id="tone-group"><button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button><button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button></div>
      <div class="tool-group" id="drums-group" style="display:none;"><button class="btn btn-drums" onclick="toggleMetroManual()" id="btnMetroState">‚ñ∂</button><button class="btn btn-drums" onclick="halfTime()">1/2</button></div>
      <div class="tool-group" style="grid-template-columns: 1fr;"><button class="btn btn-nav" onclick="showHome()">üè† Inicio</button></div>
      <div class="tool-group"><button class="btn btn-font" onclick="changeFontSize(-2)">A-</button><button class="btn btn-font" onclick="changeFontSize(2)">A+</button></div>
      <div class="tool-group triple"><button class="btn btn-scroll" onclick="adjScroll(-0.1)">S-</button><button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()">AUTO</button><button class="btn btn-scroll" onclick="adjScroll(0.1)">S+</button></div>
    </div>
    <div id="info-display">
      <div id="current-song-info" style="font-weight: bold; color: var(--accent); font-size: 14px; text-align: center; margin-top: 8px;">Adoranza Cloud</div>
      <div id="metro-dots"></div>
    </div>
</div>

<main class="wrap">
  <div class="grid">
    <section class="card">
        <div class="hd">Setlist <span id="list-name-badge"></span></div>
        <div class="bd">
            <div style="display:flex; gap:4px; margin-bottom:10px;">
                <button class="btn btn-nav" style="background:#success; font-size:10px;" onclick="guardarListaCloud()">Guardar</button>
                <button class="btn btn-nav" style="background:#333; font-size:10px;" onclick="cargarListaCloud()">Cargar ID</button>
                <button class="btn btn-nav" style="background:#075e54; font-size:10px;" onclick="compartirWhatsApp()">WhatsApp</button>
            </div>
            <div id="setList"></div>
        </div>
    </section>
    <section class="card" style="grid-column: 1 / -1; border:none; background:none;"><pre id="viewContent">Selecciona una canci√≥n.</pre></section>
  </div>
</main>

<script>
  
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdGxianZqb3FwcW9rbHZqZHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NzY4NDUsImV4cCI6MjA4MzU1Mjg0NX0.AQg9BuuGlbUtuyccvrBJwRGzx4Bgzx58aqGbfMPzKfg";
  const db = supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  const state = {
    setlist: [], currentIndex: -1, currentFontSize: 18, userRole: 'musico',
    listName: "", currentListID: "", metroInt: null, metroActive: false, currentBPM: 120
  };

  // Mejora 2: Generar ID de 8 caracteres
  function generateListID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Mejora 3: L√≥gica de Swipe
  let touchStartX = 0;
  function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
  function handleTouchEnd(e, index) {
    const touchEndX = e.changedTouches[0].screenX;
    const diff = touchEndX - touchStartX;
    if (diff > 100) markAsPlayed(index); // Swipe derecha -> Tocada
    if (diff < -100) removeSong(index, e); // Swipe izquierda -> Borrar
  }

  function markAsPlayed(index) {
    state.setlist[index].played = !state.setlist[index].played;
    renderAll();
  }

  function renderAll() {
    const sl = document.getElementById('setList'); sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const container = document.createElement('div');
      container.className = 'item-container';
      container.innerHTML = `
        <div class="swipe-action action-delete">ELIMINAR</div>
        <div class="swipe-action action-played">TOCADA</div>
        <div class="item ${s.played ? 'played' : ''}" 
             ontouchstart="handleTouchStart(event)" 
             ontouchend="handleTouchEnd(event, ${idx})">
          <div style="flex:1" onclick="seleccionar(${idx})">${s.titulo}</div>
          <span class="drag-handle">‚ò∞</span>
        </div>
      `;
      sl.appendChild(container);
    });

    const curr = state.setlist[state.currentIndex];
    const view = document.getElementById('viewContent');
    if(curr && view) {
      document.getElementById('current-song-info').innerText = curr.titulo + " | BPM: " + (state.half ? curr.bpm/2 : curr.bpm);
      let body = curr.body;
      if (state.userRole !== 'musico') {
        body = body.replace(/\[([^\]]+)\]/g, ''); 
        const lines = body.split(/\r?\n/);
        const cleaned = [];
        for (let l of lines) { if (l.trim() !== "") cleaned.push(l); else if (cleaned.length > 0 && cleaned[cleaned.length-1] !== "") cleaned.push(""); }
        body = cleaned.join('\n');
      } else { body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>'); }
      view.innerHTML = body; view.style.fontSize = state.currentFontSize + 'px';
      state.currentBPM = state.half ? curr.bpm/2 : curr.bpm;
      if(state.userRole === 'drums' && state.metroActive) startMetro();
    }
  }

  function seleccionar(idx) { state.currentIndex = idx; state.half = false; renderAll(); window.scrollTo({top:0, behavior:'smooth'}); }
  function removeSong(idx, e) { e.stopPropagation(); state.setlist.splice(idx, 1); if (state.currentIndex === idx) state.currentIndex = -1; saveLocal(); renderAll(); }
  function saveLocal() { localStorage.setItem('adoranza_v4_setlist', JSON.stringify(state.setlist)); }
  function clearSetlist() { state.setlist = []; state.currentIndex = -1; state.listName = ""; document.getElementById('list-name-badge').innerText = ""; saveLocal(); renderAll(); }
  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }

  function toggleMetroManual() {
    state.metroActive = !state.metroActive;
    document.getElementById('btnMetroState').innerText = state.metroActive ? "‚èπ" : "‚ñ∂";
    state.metroActive ? startMetro() : stopMetro();
  }
  function halfTime() { state.half = !state.half; renderAll(); }

  function startMetro() {
    stopMetro();
    const curr = state.setlist[state.currentIndex];
    if(!curr) return;
    const dots = document.getElementById('metro-dots'); dots.innerHTML = "";
    const beats = parseInt(curr.time_signature) || 4;
    for(let i=0; i<beats; i++) dots.innerHTML += `<div class="beat-dot" id="dot-${i}"></div>`;
    let step = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    state.metroInt = setInterval(() => {
      const vol = parseFloat(document.getElementById('volRange').value);
      document.querySelectorAll('.beat-dot').forEach(d => d.className = 'beat-dot');
      const dot = document.getElementById(`dot-${step}`);
      if(dot) dot.classList.add(step === 0 ? 'beat-active-red' : 'beat-active-green');
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.setValueAtTime(step === 0 ? 880 : 440, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol * 0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
      step = (step + 1) % beats;
    }, (60 / state.currentBPM) * 1000);
  }
  function stopMetro() { clearInterval(state.metroInt); if(document.getElementById('metro-dots')) document.getElementById('metro-dots').innerHTML = ""; }
  function toggleScroll() { 
    if(state.scrollInt) { clearInterval(state.scrollInt); state.scrollInt = null; document.getElementById('scrollBtn').innerText = "AUTO"; }
    else { state.scrollInt = setInterval(() => window.scrollBy(0,1), 50/state.scrollSpeed); document.getElementById('scrollBtn').innerText = "PAUSA"; }
  }
  function adjScroll(d) { state.scrollSpeed = Math.max(0.1, state.scrollSpeed + d); }

  function transpose(delta) {
    const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;
    curr.body = curr.body.replace(/\[([^\]]+)\]/g, (m, chord) => {
      return "[" + chord.replace(/[A-G]#?/g, (note) => {
        let idx = scale.indexOf(note);
        return idx === -1 ? note : scale[(idx + delta + 12) % 12];
      }) + "]";
    });
    renderAll();
  }

  async function guardarListaCloud() {
    const name = prompt("Nombre del Setlist:");
    if(!name) return;
    const id = generateListID();
    const songIds = state.setlist.map(s => s.id);
    
    const { error } = await db.from('setlists_guardados').insert({
        id_unico: id, // Aseg√∫rate de tener esta columna en Supabase
        nombre_lista: name,
        canciones_ids: songIds
    });

    if(!error) {
        state.currentListID = id;
        state.listName = name;
        document.getElementById('list-name-badge').innerText = `ID: ${id}`;
        alert(`Guardado con √©xito. ID: ${id}`);
    }
  }

  async function cargarListaCloud() {
    const id = prompt("Ingresa el ID de 8 caracteres:");
    if(!id) return;
    
    const { data, error } = await db.from('setlists_guardados').select('*').eq('id_unico', id.toUpperCase()).single();
    
    if(data) {
        state.listName = data.nombre_lista;
        state.currentListID = id;
        document.getElementById('list-name-badge').innerText = `ID: ${id}`;
        // L√≥gica para cargar canciones desde data.canciones_ids...
        alert("Cargando setlist...");
    } else {
        alert("ID no encontrado.");
    }
  }

function compartirWhatsApp() {
    if(!state.currentListID) {
        alert("Primero guarda la lista para generar un ID.");
        return;
    }
    const songList = state.setlist.map((s, i) => `${i+1}. ${s.titulo}`).join('\n');
    const msg = `üé∏ *SETLIST ADORANZA: ${state.listName}*\n\n` +
                `Para cargar esta lista usa el ID: *${state.currentListID}*\n\n` +
                `*Canciones:*\n${songList}\n\n` +
                `_Generado por Adoranza Pro_`;
    
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
  }

  async function revisarLinkCompartido() {
    const p = new URLSearchParams(window.location.search);
    const ids = p.get('list');
    if (ids) {
        const arr = ids.split(',').map(Number);
        const { data } = await db.from('canciones').select('*').in('id', arr);
        if (data) {
            state.listName = p.get('n') || "Compartida";
            document.getElementById('list-name-badge').innerText = "¬ª " + state.listName;
            state.setlist = [];
            for (let id of arr) { const s = data.find(x => x.id === id); if (s) await addToSetlist(s); }
            window.history.replaceState({}, "", window.location.pathname);
        }
    }
  }

  function initSortable() { 
    const el = document.getElementById('setList');
    if(el) Sortable.create(el, { 
      animation: 150, 
      handle: '.drag-handle', // Solo arrastra desde el icono
      onEnd: (evt) => {
        const item = state.setlist.splice(evt.oldIndex, 1)[0];
        state.setlist.splice(evt.newIndex, 0, item);
        saveLocal();
        renderAll();
      }
    }); 
  }

  async function verEstadisticas() { 
    const { data } = await db.from('canciones').select('titulo, veces_tocada').gt('veces_tocada', 0).order('veces_tocada', { ascending: false }).limit(5);
    alert("TOP 5:\n" + data.map(s => `- ${s.titulo} (${s.veces_tocada})`).join('\n'));
  }

  async function guardarListaCloud() {
    const n = prompt("Nombre:"); if(!n) return;
    const ids = state.setlist.map(s => s.id);
    await db.from('setlists_guardados').insert({ nombre_lista: n, canciones_ids: ids });
    state.listName = n; document.getElementById('list-name-badge').innerText = "¬ª " + n;
    alert("Guardada");
  }

  async function cargarListaCloud() {
    const { data } = await db.from('setlists_guardados').select('*').order('created_at', { ascending: false });
    if (!data?.length) return;
    const sel = prompt("Elige:\n" + data.map((l,i) => (i+1)+". "+l.nombre_lista).join('\n'));
    if (sel && data[sel-1]) {
        const l = data[sel-1]; state.listName = l.nombre_lista;
        document.getElementById('list-name-badge').innerText = "¬ª " + l.nombre_lista;
        const { data: cans } = await db.from('canciones').select('*').in('id', l.canciones_ids);
        state.setlist = [];
        for(let id of l.canciones_ids) { const s = cans.find(x => x.id === id); if(s) await addToSetlist(s); }
        renderAll();
    }
  }
</script>
</body>
</html>
