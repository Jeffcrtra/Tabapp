<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3.58 Adoranza Pro v5.0</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#0b0d12;
      --card:#121622;
      --card2:#0f1320;
      --muted:#98a2b3;
      --text:#e6e9ef;
      --line:#23283a;
      --accent:#ffd54a;
      --danger:#ff5c77;
      --success:#4aff80;
      --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 6px 16px rgba(0,0,0,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 10% -10%, rgba(255,213,74,.09), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(74,255,128,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
      padding-top:188px; /* antes 210px: compactamos un toque */
    }

    /* ===== Pantalla inicial ===== */
    #roleSelector{
      position:fixed; inset:0;
      background: radial-gradient(900px 600px at 10% 10%, rgba(255,213,74,.12), transparent 55%),
                  radial-gradient(900px 600px at 100% 10%, rgba(90,140,255,.10), transparent 55%),
                  var(--bg);
      z-index:10000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
      padding:20px;
    }
    .role-grid{
      display:grid;
      gap:14px;
      grid-template-columns:repeat(3,1fr);
      width:min(95vw,520px);
    }
    .role-btn{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      padding:16px 10px;
      border-radius:22px;
      text-align:center;
      font-size:28px;
      cursor:pointer;
      color:white;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:transform .15s ease, border-color .15s ease, filter .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .role-btn:hover{ border-color:rgba(255,213,74,.6); transform:translateY(-2px); }
    .role-btn:active{ transform:translateY(0px) scale(.99); filter:brightness(1.08); }
    .role-btn small{
      font-size:10px;
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      line-height:1.2;
      text-transform:uppercase;
    }
    .footer-credits{
      position:absolute; bottom:18px;
      font-size:12px; color:var(--muted);
      text-align:center;
      opacity:.95;
    }
    .footer-credits a{ color:var(--accent); text-decoration:none; font-weight:800; }

    /* ===== Panel fijo ===== */
    #fixedControlPanel{
      position:fixed; top:0; left:0; right:0; z-index:999;
      background: rgba(11,13,18,.72);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 12px 8px 12px;
    }
    .viewer-tools{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      max-width:540px;
      margin:0 auto;
    }
    .tool-group{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:6px;
      justify-content:center;
      align-items:center;
      padding:6px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
    }
    .tool-group.triple{ grid-template-columns:repeat(3,1fr); grid-column:span 2; }
    .tool-group.single{ grid-template-columns:1fr; }

    .btn{
      border:1px solid rgba(255,255,255,.18);
      color:white;
      padding:10px 6px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease, background .12s ease;
      width:100%;
      max-width:110px;
      margin:0 auto;
      height:36px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter:brightness(1.08); }
    .btn-nav{ background: linear-gradient(180deg, rgba(0,65,115,.95), rgba(0,65,115,.78)); }
    .btn-tone{ background: linear-gradient(180deg, rgba(99,11,87,.95), rgba(99,11,87,.72)); }
    .btn-font{ background: linear-gradient(180deg, rgba(46,111,64,.95), rgba(46,111,64,.72)); }
    .btn-scroll{ background: linear-gradient(180deg, rgba(208,147,6,.95), rgba(208,147,6,.72)); color:#0b0d12; border-color: rgba(255,213,74,.55); }
    .btn-drums{ background: rgba(255,255,255,.02); border-color: rgba(74,255,128,.65); color: var(--success); }
    .btn-save{ background: rgba(255,255,255,.02); border-color: rgba(74,255,128,.65); color: var(--success); }
    .btn-wa{ background: linear-gradient(180deg, rgba(7,94,84,.95), rgba(7,94,84,.74)); border-color: rgba(37,211,102,.65); }

    .btn-add{
      background: var(--accent);
      color:#0b0d12;
      border-color: rgba(255,213,74,.9);
      font-weight:900;
      font-size:10px;
      height:28px;
      padding:0 10px;
      border-radius:12px;
      max-width:56px;
      box-shadow: 0 10px 18px rgba(255,213,74,.10);
    }
    .btn-add:hover{ filter:brightness(1.05); }

    #volume-container{ display:none; text-align:center; margin-top:8px; }

    #info-display{ padding-bottom:0; }
    #current-song-info{
      font-weight:900;
      color: rgba(255,255,255,.92);
      font-size:14px;
      text-align:center;
      margin-top:8px;
      line-height:1.15;
      letter-spacing:.01em;
    }
    #current-song-info .sub{
      display:block;
      margin-top:2px;
      font-weight:700;
      font-size:11px;
      color: rgba(255,213,74,.85);
    }

    #metro-dots{
      margin-top:8px;
      display:flex;
      justify-content:center;
      gap:14px;
      height:42px;
      align-items:center;
    }
    #metro-dots.is-hidden{ display:none; height:0; margin-top:0; }

    .beat-dot{ width:32px; height:32px; border-radius:50%; background:#141824; border:2px solid rgba(255,255,255,.10); transition:.12s; }
    .beat-active-red{ background:var(--danger); box-shadow:0 0 22px rgba(255,92,119,.55); transform:scale(1.12); border-color:#fff; }
    .beat-active-green{ background:var(--success); box-shadow:0 0 22px rgba(74,255,128,.45); transform:scale(1.12); border-color:#fff; }

    /* ===== Config panel ===== */
    #configPanel{
      position:fixed; inset:0;
      background: radial-gradient(900px 600px at 10% 10%, rgba(255,213,74,.10), transparent 55%),
                  var(--bg);
      z-index:10001;
      display:none;
      flex-direction:column;
      align-items:center;
      padding:40px 20px;
      overflow:auto;
    }

    /* ===== Layout ===== */
    .wrap{ padding:12px; max-width:1200px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width:768px){ .grid{ grid-template-columns:320px 1fr; } }

    #setlist-container{ width:92%; margin:0 auto; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      margin-bottom:10px;
      box-shadow: var(--shadow2);
    }
    .card .hd{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      color: rgba(255,255,255,.88);
      text-transform:uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .bd{ padding:12px; }

    .input{
      width:100%;
      background: rgba(0,0,0,.35);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      padding:12px;
      border-radius:14px;
      outline:none;
      transition: border-color .12s ease, filter .12s ease;
    }
    .input:focus{
      border-color: rgba(255,213,74,.55);
      filter: brightness(1.05);
    }

    /* ===== Setlist item: swipe ===== */
    .set-item-wrap{
      position:relative;
      margin-bottom:10px;
      border-radius:16px;
      overflow:hidden;
    }

    .swipe-actions{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      background: rgba(0,0,0,.15);
    }
    .swipe-action{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      letter-spacing:.02em;
      font-size:12px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
    }
    .swipe-action.left{
      background: rgba(255,92,119,.14);
      color: rgba(255,255,255,.92);
      border-color: rgba(255,92,119,.35);
    }
    .swipe-action.right{
      background: rgba(74,255,128,.12);
      color: rgba(255,255,255,.92);
      border-color: rgba(74,255,128,.35);
    }

    .set-item{
      position:relative;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
      transform: translateX(0);
      transition: transform .16s ease, border-color .16s ease, filter .16s ease;
      touch-action: pan-y; /* importante: permite swipe horizontal sin matar scroll vertical */
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    .set-item.is-active{ border-color: rgba(255,213,74,.6); }
    .set-item.is-sung{
      border-color: rgba(74,255,128,.55);
      background: linear-gradient(180deg, rgba(74,255,128,.10), rgba(255,255,255,.02));
    }

    .drag-handle{ cursor:grab; padding:0 10px; color:var(--muted); font-size:18px; }
    .titlebox{ flex:1; min-width:0; }
    .songtitle{
      font-weight:900;
      font-size:14px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .songmeta{
      margin-top:2px;
      font-size:11px;
      color: rgba(152,162,179,.95);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .pill:active{ transform: translateY(1px) scale(.99); filter:brightness(1.06); }

    .pill.heart{ min-width:44px; justify-content:center; }
    .pill.heart.on{
      border-color: rgba(255,92,119,.55);
      background: rgba(255,92,119,.10);
    }

    #viewContent{
      background: rgba(0,0,0,.35);
      padding:22px;
      border-radius:18px;
      white-space:pre-wrap;
      font-family:var(--mono);
      line-height:1.6;
      border:1px solid rgba(255,255,255,.10);
      min-height:200px;
      box-shadow: var(--shadow2);
    }
    .chord{ color:var(--accent); font-weight:900; }

    #list-name-badge{ font-size:10px; color: rgba(255,213,74,.85); margin-top:4px; display:block; font-weight:700; }

    /* ===== Toast (Undo) ===== */
    #toastUndo{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      z-index:20000;
      min-width:min(92vw, 520px);
      background: rgba(15,19,32,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(12px);
    }
    #toastUndo .msg{
      font-size:12px;
      color: rgba(255,255,255,.92);
      font-weight:800;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    #toastUndo .undoBtn{
      background: rgba(255,213,74,.14);
      border:1px solid rgba(255,213,74,.35);
      color: rgba(255,255,255,.95);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    #toastUndo .undoBtn:active{ transform:translateY(1px) scale(.99); filter:brightness(1.06); }
  </style>
</head>

<body>

<div id="roleSelector">
  <h1 style="color:var(--accent); margin:0; font-size:24px; letter-spacing:.02em;">ADORANZA PRO v5.0</h1>
  <div style="color:rgba(255,255,255,.70); font-size:12px; text-align:center; max-width:520px; line-height:1.4;">
    Setlists, tabs y letras. Swipe para marcar <b>cantada</b> o quitar de la vista. ‚ù§Ô∏è para guardar offline.
  </div>
  <div class="role-grid">
    <div class="role-btn" onclick="setRole('musico')">üé∏<small>PIANO<br>GUITARRA</small></div>
    <div class="role-btn" onclick="setRole('drums')">ü•Å<small>VOZ +<br>BATER√çA</small></div>
    <div class="role-btn" onclick="Estadisticas()" style="grid-column: span 1.5">üìä<small>STATS</small></div>
    <div class="role-btn" onclick="openConfig()" style="grid-column: span 1.5">‚öôÔ∏è<small>CONFIG</small></div>
  </div>
  <div class="footer-credits">App creada por <a href="https://www.linkedin.com/in/jeffrey-trigueros-371191123/" target="_blank">Jeffrey Trigueros</a></div>
</div>

<div id="configPanel">
  <button class="btn btn-nav" style="margin-bottom:24px; width:140px; max-width:none;" onclick="closeConfig()">üè† Home</button>

  <div class="card" style="width:100%; max-width:520px;">
    <div class="hd">Perfil de Usuario</div>
    <div class="bd" style="text-align:center;">
      <p style="color:var(--muted); margin:0;">Usuario:</p>
      <h2 id="uname-display" style="color:var(--accent); margin:8px 0 0 0;"></h2>

      <p style="color:var(--muted); margin:12px 0 0 0;">ID √∫nico:</p>
      <div id="uid-display" style="color:var(--accent); font-family:var(--mono); letter-spacing:2px; font-size:16px; margin-top:6px;"></div>
    </div>
  </div>

  <div class="card" style="width:100%; max-width:520px; margin-top:14px;">
    <div class="hd">Mis Setlists</div>
    <div class="bd">
      <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
        <button class="btn btn-nav" style="max-width:180px; height:34px;" onclick="listarMisSetlists()">üîÑ Actualizar</button>
        <button class="btn" style="max-width:220px; height:34px; background:rgba(44,82,130,.9); color:white; border-color:rgba(255,255,255,.12);" onclick="copiarMiSetlistActual()">üìã Copiar ID actual</button>
      </div>
      <div id="mySetlists" style="display:grid; gap:10px;"></div>
      <div style="margin-top:10px; font-size:11px; color:var(--muted);">
        Tip: toc√° un setlist para copiar su ID (sirve para Cargar o para compartir).
      </div>
    </div>
  </div>
</div>

<div id="fixedControlPanel">
  <div class="viewer-tools">
    <div class="tool-group">
      <button class="btn btn-nav" onclick="prevSong()">‚üµ</button>
      <button class="btn btn-nav" onclick="nextSong()">‚ü∂</button>
    </div>

    <div class="tool-group" id="tone-group">
      <button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button>
      <button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button>
    </div>

    <div class="tool-group" id="drums-group" style="display:none;">
      <button class="btn btn-drums" onclick="toggleMetroManual()" id="btnMetroState">‚ñ∂</button>
      <button class="btn btn-drums" onclick="halfTime()">1/2</button>
    </div>

    <div class="tool-group single">
      <button class="btn btn-nav" onclick="showHome()">üè† Inicio</button>
    </div>

    <div class="tool-group">
      <button class="btn btn-font" onclick="changeFontSize(-2)">A-</button>
      <button class="btn btn-font" onclick="changeFontSize(2)">A+</button>
    </div>

    <div class="tool-group triple">
      <button class="btn btn-scroll" onclick="adjScroll(-0.1)">S-</button>
      <button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()">AUTO</button>
      <button class="btn btn-scroll" onclick="adjScroll(0.1)">S+</button>
    </div>
  </div>

  <div id="volume-container">
    <small style="color:var(--muted); font-size:10px; font-weight:800; letter-spacing:.08em;">VOL CLICK:</small>
    <input type="range" id="volRange" min="0" max="1" step="0.05" value="0.5" style="width:140px; vertical-align:middle;">
  </div>

  <div id="info-display">
    <div id="current-song-info">Adoranza Cloud</div>
    <div id="metro-dots"></div>
  </div>
</div>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd">Buscador</div>
      <div class="bd">
        <input class="input" id="searchBox" placeholder="Buscar..." autocomplete="off" />
        <div id="results" style="margin-top:10px;"></div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%; gap:10px;">
          <div style="min-width:0;">
            Setlist <span id="list-name-badge"></span>
          </div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn btn-save" style="width:auto; padding:0 10px; height:30px; font-size:11px; max-width:none;" onclick="guardarListaCloud()">Guardar</button>
            <button class="btn" style="width:auto; padding:0 10px; height:30px; font-size:11px; background:rgba(44,82,130,.9); color:white; border-color:rgba(255,255,255,.12); max-width:none;" onclick="cargarListaCloud()">Cargar</button>
            <button class="btn" style="width:auto; padding:0 10px; height:30px; font-size:11px; background:rgba(85,17,17,.85); border-color:rgba(255,92,119,.35); max-width:none;" onclick="clearSetlist()">Vaciar</button>
            <button class="btn btn-wa" style="width:auto; padding:0 10px; height:30px; font-size:11px; max-width:none;" onclick="compartirWhatsApp()">Env√≠a</button>
          </div>
        </div>
      </div>
      <div class="bd" id="setlist-container">
        <div id="setList"></div>
        <div style="margin-top:8px; color:rgba(152,162,179,.9); font-size:11px;">
          Swipe ‚ûú <span style="color:rgba(74,255,128,.9); font-weight:900;">cantada</span> ¬∑ Swipe ‚á¶ <span style="color:rgba(255,92,119,.9); font-weight:900;">quitar</span> ¬∑ ‚ù§Ô∏è guarda offline
        </div>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1; border:none; background:none; box-shadow:none;">
      <pre id="viewContent">Selecciona una canci√≥n.</pre>
    </section>
  </div>
</main>

<!-- Toast undo -->
<div id="toastUndo">
  <div class="msg" id="toastMsg">Eliminada</div>
  <div class="undoBtn" onclick="undoLastRemove()">DESHACER</div>
</div>

<script>
  const SB_URL = "https://ystlbjvjoqpqoklvjdrj.supabase.co";
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdGxianZqb3FwcW9rbHZqZHJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NzY4NDUsImV4cCI6MjA4MzU1Mjg0NX0.AQg9BuuGlbUtuyccvrBJwRGzx4Bgzx58aqGbfMPzKfg";
  const BUCKET_URL = `${SB_URL}/storage/v1/object/public/Cancionero_Adoranza/`;

  // Debug (si ya no lo ocup√°s, lo quit√°s)
  window.onerror = function (msg, src, line, col, err) {
    alert("JS ERROR: " + msg + "\nL√≠nea: " + line);
    console.error(err);
  };

  let db = null;

  // ===== Local Storage Keys (nuevos) =====
  const LS_FAV = "adoranza_favorites_v1";
  const LS_SUNG = "adoranza_sung_v1";

  function genSetlistId8(prefix="") {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let out = "";
    try {
      if (window.crypto && crypto.getRandomValues) {
        const arr = new Uint8Array(8);
        crypto.getRandomValues(arr);
        for (let i = 0; i < 8; i++) out += chars[arr[i] % chars.length];
        return prefix + out;
      }
    } catch(e) {}
    for (let i = 0; i < 8; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return prefix + out;
  }

  // UUID-friendly
  function normalizeSongIds(v) {
    if (v == null) return [];
    if (Array.isArray(v)) return v.map(x => String(x).trim()).filter(Boolean);

    if (typeof v === "string") {
      const s = v.trim();
      if (!s) return [];

      try {
        const j = JSON.parse(s);
        if (Array.isArray(j)) return j.map(x => String(x).trim()).filter(Boolean);
      } catch (e) {}

      const uuids = s.match(/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/g);
      if (uuids && uuids.length) return uuids.map(x => x.trim());

      const cleaned = s.replace(/[\{\}\[\]\s"]/g, "");
      if (!cleaned) return [];
      return cleaned.split(",").map(x => x.trim()).filter(Boolean);
    }

    return [String(v).trim()].filter(Boolean);
  }

  async function copyToClipboard(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch(e) {}
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
      document.execCommand("copy");
      document.body.removeChild(ta);
      return true;
    } catch (e) {
      document.body.removeChild(ta);
      return false;
    }
  }

  function safeJSONParse(s, fallback){
    try { return JSON.parse(s); } catch(e){ return fallback; }
  }

  function getFavorites(){
    const raw = localStorage.getItem(LS_FAV) || "{}";
    const j = safeJSONParse(raw, {});
    return (j && typeof j === "object") ? j : {};
  }
  function setFavorites(obj){
    localStorage.setItem(LS_FAV, JSON.stringify(obj || {}));
  }
  function getSungMap(){
    const raw = localStorage.getItem(LS_SUNG) || "{}";
    const j = safeJSONParse(raw, {});
    return (j && typeof j === "object") ? j : {};
  }
  function setSungMap(obj){
    localStorage.setItem(LS_SUNG, JSON.stringify(obj || {}));
  }

  function normKey(s){
    return String(s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().trim()
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/^-+|-+$/g,"");
  }
  function songKey(song){
    if (song && song.id) return String(song.id);
    const t = normKey(song?.titulo || "");
    const a = normKey(song?.artista || "");
    const p = normKey(song?.path_url || "");
    return (t || a || p) ? `${a}|${t}|${p}` : genSetlistId8("S");
  }
  function listKey(){
    return (state.listIdUnico && state.listIdUnico.trim()) ? state.listIdUnico.trim().toUpperCase() : "LOCAL";
  }

  const state = {
    setlist: [],
    currentIndex: -1,
    currentFontSize: 18,
    userRole: "musico",
    listName: "",
    listIdUnico: "",
    metroInt: null,
    metroActive: false,
    currentBPM: 120,
    half: false,
    scrollInt: null,
    scrollSpeed: 1.0,

    // user
    userId: localStorage.getItem("adoranza_user_id") || "",
    username: localStorage.getItem("adoranza_username") || "",

    // undo
    lastRemoved: null,
    toastT: null
  };

  function initSupabaseOrWarn() {
    if (!window.supabase || !supabase.createClient) {
      alert("No carg√≥ Supabase (CDN). Revisa internet o bloqueo de CDN.");
      console.error("Supabase no disponible:", window.supabase);
      return null;
    }
    try {
      return supabase.createClient(SB_URL, SB_KEY);
    } catch (e) {
      alert("Error inicializando Supabase. Revisa consola.");
      console.error(e);
      return null;
    }
  }

  // ============ PUNTO 3: Username obligatorio ============
  function ensureLocalUserOrBlock() {
    // userId
    if (!state.userId) {
      state.userId = genSetlistId8("ID");
      localStorage.setItem("adoranza_user_id", state.userId);
    }

    // username obligatorio: si cancela o vac√≠o -> loop (bloquea avance)
    while (!state.username || !state.username.trim()) {
      const u = prompt("Eleg√≠ tu nombre de usuario (obligatorio):", "");
      if (u == null) continue; // cancel -> sigue pidiendo
      if (!u.trim()) continue;
      state.username = u.trim();
      localStorage.setItem("adoranza_username", state.username);
    }
  }

  async function upsertUserToCloudNonBlocking() {
    if (!db) return;
    try {
      const payload = {
        user_id: state.userId,
        username: state.username
      };
      const { error } = await db.from("adoranza_users").upsert(payload, { onConflict: "user_id" });
      if (error) console.warn("No pude registrar usuario en nube (no bloqueo):", error);
    } catch (e) {
      console.warn("No pude registrar usuario en nube (no bloqueo):", e);
    }
  }

  // ============ UI ============
  function setRole(role) {
    state.userRole = role;
    document.getElementById("roleSelector").style.display = "none";
    document.getElementById("tone-group").style.display = (role === "musico") ? "grid" : "none";
    document.getElementById("drums-group").style.display = (role === "drums") ? "grid" : "none";
    document.getElementById("volume-container").style.display = (role === "drums") ? "block" : "none";
    renderAll();
  }

  function openConfig() {
    document.getElementById("configPanel").style.display = "flex";
    const ud = document.getElementById("uid-display");
    const un = document.getElementById("uname-display");
    if (ud) ud.innerText = state.userId;
    if (un) un.innerText = state.username || "(sin username)";
    if (db) listarMisSetlists();
  }
  function closeConfig() { document.getElementById("configPanel").style.display = "none"; }
  function showHome() {
    document.getElementById("roleSelector").style.display = "flex";
    stopMetro();
    stopScroll();
  }

  function stopScroll() {
    if (state.scrollInt) clearInterval(state.scrollInt);
    state.scrollInt = null;
    const sb = document.getElementById("scrollBtn");
    if (sb) sb.innerText = "AUTO";
  }

  function renderBadge() {
    const badge = document.getElementById("list-name-badge");
    if (!badge) return;
    if (!state.listName && !state.listIdUnico) { badge.innerText = ""; return; }
    if (state.listName && state.listIdUnico) badge.innerText = `¬ª ${state.listName} (${state.listIdUnico})`;
    else if (state.listName) badge.innerText = `¬ª ${state.listName}`;
    else badge.innerText = `¬ª ${state.listIdUnico}`;
  }

  // ===== Toast Undo =====
  function showUndoToast(label){
    const t = document.getElementById("toastUndo");
    const m = document.getElementById("toastMsg");
    if (!t || !m) return;
    m.innerText = label || "Quitada";
    t.style.display = "flex";

    if (state.toastT) clearTimeout(state.toastT);
    state.toastT = setTimeout(() => {
      t.style.display = "none";
      state.toastT = null;
      state.lastRemoved = null;
    }, 4500);
  }

  function hideUndoToast(){
    const t = document.getElementById("toastUndo");
    if (t) t.style.display = "none";
    if (state.toastT) clearTimeout(state.toastT);
    state.toastT = null;
  }

  function undoLastRemove(){
    if (!state.lastRemoved) return;
    const { song, index } = state.lastRemoved;
    const idx = Math.max(0, Math.min(index, state.setlist.length));
    state.setlist.splice(idx, 0, song);
    saveLocal();
    state.lastRemoved = null;
    hideUndoToast();
    renderAll();
  }

  // ============ Favoritos ============
  function isFav(song){
    const favs = getFavorites();
    const k = songKey(song);
    return !!favs[k];
  }
  function toggleFavByIndex(idx, ev){
    if (ev) ev.stopPropagation();
    const song = state.setlist[idx];
    if (!song) return;
    const favs = getFavorites();
    const k = songKey(song);

    if (favs[k]) {
      delete favs[k];
      setFavorites(favs);
    } else {
      // guardar offline con body actual
      favs[k] = {
        key: k,
        id: song.id || null,
        titulo: song.titulo || "",
        artista: song.artista || "",
        path_url: song.path_url || "",
        body: song.body || "",
        updatedAt: Date.now()
      };
      setFavorites(favs);
    }
    renderAll();
  }

  // ============ Cantadas ============
  function isSung(song){
    const sm = getSungMap();
    const lk = listKey();
    const k = songKey(song);
    return !!(sm[lk] && sm[lk][k]);
  }
  function markSung(song, val){
    const sm = getSungMap();
    const lk = listKey();
    const k = songKey(song);
    if (!sm[lk]) sm[lk] = {};
    if (val) sm[lk][k] = true;
    else delete sm[lk][k];
    setSungMap(sm);
  }

  // ============ CONFIG / SETLISTS ============
  async function listarMisSetlists() {
    if (!db) { alert("Supabase no est√° listo."); return; }
    const box = document.getElementById("mySetlists");
    if (box) box.innerHTML = `<div style="color:var(--muted); font-size:12px;">Cargando‚Ä¶</div>`;

    const { data, error } = await db
      .from("setlists_guardados")
      .select("id_unico,nombre_lista,created_at,owner_id,owner_name,shared_from_id,shared_from_name")
      .eq("owner_id", state.userId)
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      console.error(error);
      alert("No pude listar setlists: " + (error.message || error));
      if (box) box.innerHTML = "";
      return;
    }

    if (!box) return;
    box.innerHTML = "";

    if (!data || data.length === 0) {
      box.innerHTML = `<div style="color:var(--muted); font-size:12px;">A√∫n no ten√©s setlists guardados.</div>`;
      return;
    }

    (data || []).forEach(row => {
      const id = String(row.id_unico || "").trim().toUpperCase();
      const name = row.nombre_lista || "(Sin nombre)";
      const isShared = !!(row.shared_from_id || row.shared_from_name);
      const who = (row.shared_from_name || row.shared_from_id || "").toString().trim();

      const el = document.createElement("div");
      el.className = "set-item";
      el.style.cursor = "pointer";
      el.innerHTML = `
        <div class="titlebox" style="padding-left:6px;">
          <div class="songtitle">${name}</div>
          <div class="songmeta">
            ID: <span style="font-family:var(--mono); color:var(--accent); font-weight:900;">${id}</span>
            <span style="margin-left:8px; padding:2px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18);">
              ${isShared ? ("Compartido por " + (who || "alguien")) : "Propio"}
            </span>
          </div>
        </div>
        <button class="btn btn-add" style="max-width:56px;" onclick="copiarSetlistId('${id}', event)">COP</button>
      `;
      el.onclick = () => copiarSetlistId(id);
      box.appendChild(el);
    });
  }

  async function copiarSetlistId(id, ev) {
    if (ev) ev.stopPropagation();
    const ok = await copyToClipboard(id);
    alert(ok ? `Copiado ‚úÖ\n${id}` : `No pude copiar üòÖ\n${id}`);
  }

  async function copiarMiSetlistActual() {
    if (!state.listIdUnico) { alert("No hay un setlist cargado actualmente."); return; }
    await copiarSetlistId(state.listIdUnico.trim().toUpperCase());
  }

  // ============ STARTUP ============
  window.onload = async () => {
    ensureLocalUserOrBlock(); // bloquea SOLO si no hay username

    const ud = document.getElementById("uid-display");
    const un = document.getElementById("uname-display");
    if (ud) ud.innerText = state.userId;
    if (un) un.innerText = state.username;

    db = initSupabaseOrWarn();
    await upsertUserToCloudNonBlocking(); // no bloquea

    // Buscador
    const sb = document.getElementById("searchBox");
    if (sb) {
      sb.oninput = async (e) => {
        const val = (e.target.value || "").trim();
        const resDiv = document.getElementById("results");
        if (!resDiv) return;

        if (!db) { resDiv.innerHTML = ""; return; }
        if (val.length < 2) { resDiv.innerHTML = ""; return; }

        const { data, error } = await db
          .from("canciones")
          .select("*")
          .or(`titulo.ilike.%${val}%,artista.ilike.%${val}%`)
          .limit(6);

        if (error) { console.error(error); resDiv.innerHTML = ""; return; }

        resDiv.innerHTML = "";
        (data || []).forEach(s => {
          const d = document.createElement("div");
          d.className = "set-item";
          d.innerHTML = `
            <div class="titlebox" style="padding-left:6px;">
              <div class="songtitle">${s.titulo || ""}</div>
              <div class="songmeta">${s.artista || ""}</div>
            </div>
            <button class="btn btn-add" onclick='addToSetlist(${JSON.stringify(s)})'>ADD</button>
          `;
          resDiv.appendChild(d);
        });
      };
    }

    initSortable();

    // Links
    let handled = false;
    if (db) handled = await revisarLinkSetlistId();   // primero sid
    if (db && !handled) await revisarLinkCompartido(); // fallback list

    renderAll();
  };

  // ============ CORE ============
  async function fetchSongBodyFromBucket(song){
    const resp = await fetch(BUCKET_URL + song.path_url);
    if (!resp.ok) throw new Error("Fetch " + resp.status + " " + song.path_url);
    const text = await resp.text();
    return text.replace(/\{(\w+):\s*([^}]+)\}/g, "").trim();
  }

  async function addToSetlist(song) {
    try {
      // 1) buscar en favoritos
      const favs = getFavorites();
      const k = songKey(song);
      if (favs[k] && favs[k].body) {
        state.setlist.push({ ...song, body: favs[k].body });
        saveLocal();
        renderAll();
        return;
      }

      // 2) si no, bucket online
      const body = await fetchSongBodyFromBucket(song);
      state.setlist.push({ ...song, body });
      saveLocal();
      renderAll();
    } catch (e) {
      console.error(e);
      alert("No se pudo cargar el archivo:\n" + (song?.path_url || "") + "\n\nTip: si lo guard√°s como favorito, queda offline.");
    }
  }

  function renderAll() {
    const sl = document.getElementById("setList");
    if (!sl) return;
    sl.innerHTML = "";

    state.setlist.forEach((s, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "set-item-wrap";

      const actions = document.createElement("div");
      actions.className = "swipe-actions";
      actions.innerHTML = `
        <div class="swipe-action left">üóëÔ∏è Quitar</div>
        <div class="swipe-action right">‚úÖ Cantada</div>
      `;

      const row = document.createElement("div");
      row.className = "set-item";
      row.dataset.idx = String(idx);

      if (idx === state.currentIndex) row.classList.add("is-active");
      if (isSung(s)) row.classList.add("is-sung");

      const favOn = isFav(s);

      row.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <div class="titlebox" onclick="seleccionar(${idx})">
          <div class="songtitle">${s.titulo || "(Sin t√≠tulo)"}</div>
          <div class="songmeta">${s.artista || ""}${favOn ? " ¬∑ Offline" : ""}${isSung(s) ? " ¬∑ Cantada" : ""}</div>
        </div>
        <div class="pill heart ${favOn ? "on" : ""}" onclick="toggleFavByIndex(${idx}, event)" title="Favorito (offline)">
          ${favOn ? "‚ô•" : "‚ô°"}
        </div>
      `;

      wrap.appendChild(actions);
      wrap.appendChild(row);
      sl.appendChild(wrap);

      // Swipe behavior
      attachSwipe(row);
    });

    renderBadge();

    const curr = state.setlist[state.currentIndex];
    const view = document.getElementById("viewContent");
    const info = document.getElementById("current-song-info");
    const dots = document.getElementById("metro-dots");

    if (curr && view) {
      if (info) {
        if (state.userRole === "drums") {
          info.innerHTML = `${curr.titulo || ""}<span class="sub">BPM: ${state.half ? curr.bpm/2 : curr.bpm}</span>`;
        } else {
          info.innerHTML = `${curr.titulo || ""}<span class="sub">${curr.artista || ""}</span>`;
        }
      }

      // colapsar hueco en musico (esconder dots)
      if (dots) {
        if (state.userRole === "musico") dots.classList.add("is-hidden");
        else dots.classList.remove("is-hidden");
      }

      let body = curr.body || "";
      if (state.userRole !== "musico") {
        body = body.replace(/\[([^\]]+)\]/g, "");
        const lines = body.split(/\r?\n/);
        const cleaned = [];
        for (let l of lines) {
          if (l.trim() !== "") cleaned.push(l);
          else if (cleaned.length > 0 && cleaned[cleaned.length - 1] !== "") cleaned.push("");
        }
        body = cleaned.join("\n");
      } else {
        body = body.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
      }

      view.innerHTML = body;
      view.style.fontSize = state.currentFontSize + "px";
      state.currentBPM = state.half ? curr.bpm / 2 : curr.bpm;

      if (state.userRole === "drums" && state.metroActive) startMetro();
    } else {
      if (dots) {
        if (state.userRole === "musico") dots.classList.add("is-hidden");
        else dots.classList.remove("is-hidden");
      }
    }
  }

  function seleccionar(idx) {
    state.currentIndex = idx;
    state.half = false;
    renderAll();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function softRemoveSong(idx) {
    const song = state.setlist[idx];
    if (!song) return;

    // guardar undo
    state.lastRemoved = { song, index: idx };

    // remover
    state.setlist.splice(idx, 1);
    if (state.currentIndex === idx) state.currentIndex = -1;
    else if (state.currentIndex > idx) state.currentIndex--;

    saveLocal();
    renderAll();
    showUndoToast(`Quitada: ${song.titulo || "Canci√≥n"}`);
  }

  // Mantengo removeSong por compatibilidad (ya no hay X, pero por si lo llam√°s desde otro lado)
  function removeSong(idx, e) {
    if (e) e.stopPropagation();
    softRemoveSong(idx);
  }

  function saveLocal() { localStorage.setItem("adoranza_v4_setlist", JSON.stringify(state.setlist)); }

  function clearSetlist() {
    state.setlist = [];
    state.currentIndex = -1;
    state.listName = "";
    state.listIdUnico = "";
    saveLocal();
    renderAll();
  }

  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }

  // ============ Swipe Implementation ============
  function attachSwipe(el){
    let startX = 0, startY = 0, dx = 0, dy = 0;
    let dragging = false;
    let pointerId = null;
    const thresholdRatio = 0.28; // 28% del ancho

    const reset = () => {
      el.style.transition = "transform .16s ease";
      el.style.transform = "translateX(0px)";
      setTimeout(()=>{ el.style.transition = ""; }, 180);
      dragging = false;
      dx = dy = 0;
      pointerId = null;
    };

    const onDown = (ev) => {
      // no iniciar swipe si toc√≥ el coraz√≥n o el drag handle
      const t = ev.target;
      if (t && (t.closest(".pill") || t.closest(".drag-handle"))) return;

      pointerId = ev.pointerId;
      el.setPointerCapture(pointerId);
      startX = ev.clientX;
      startY = ev.clientY;
      dx = dy = 0;
      dragging = false;
    };

    const onMove = (ev) => {
      if (pointerId == null || ev.pointerId !== pointerId) return;
      dx = ev.clientX - startX;
      dy = ev.clientY - startY;

      // si el user est√° scrolleando vertical, no secuestrar
      if (!dragging) {
        if (Math.abs(dy) > 12 && Math.abs(dy) > Math.abs(dx)) {
          reset();
          return;
        }
        if (Math.abs(dx) > 10) dragging = true;
      }
      if (!dragging) return;

      el.style.transform = `translateX(${dx}px)`;
    };

    const onUp = (ev) => {
      if (pointerId == null || ev.pointerId !== pointerId) return;

      const width = el.getBoundingClientRect().width || 1;
      const thr = width * thresholdRatio;

      const idx = parseInt(el.dataset.idx || "-1", 10);
      const song = state.setlist[idx];

      // acci√≥n swipe
      if (dx <= -thr) {
        // swipe izquierda: quitar
        reset();
        if (idx >= 0) softRemoveSong(idx);
        return;
      }
      if (dx >= thr) {
        // swipe derecha: cantada toggle ON
        reset();
        if (song) {
          markSung(song, true);
          renderAll();
        }
        return;
      }

      // si no pas√≥ el umbral, volver
      reset();
    };

    el.addEventListener("pointerdown", onDown, { passive:true });
    el.addEventListener("pointermove", onMove, { passive:true });
    el.addEventListener("pointerup", onUp, { passive:true });
    el.addEventListener("pointercancel", reset, { passive:true });
  }

  // ============ METRO ============
  function toggleMetroManual() {
    state.metroActive = !state.metroActive;
    const b = document.getElementById("btnMetroState");
    if (b) b.innerText = state.metroActive ? "‚èπ" : "‚ñ∂";
    state.metroActive ? startMetro() : stopMetro();
  }

  function halfTime() { state.half = !state.half; renderAll(); }

  function startMetro() {
    stopMetro();
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;

    const dots = document.getElementById("metro-dots");
    if (!dots) return;
    dots.innerHTML = "";

    const beats = parseInt(curr.time_signature) || 4;
    for (let i = 0; i < beats; i++) dots.innerHTML += `<div class="beat-dot" id="dot-${i}"></div>`;

    let step = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    state.metroInt = setInterval(() => {
      const vr = document.getElementById("volRange");
      const vol = vr ? parseFloat(vr.value) : 0.5;

      document.querySelectorAll(".beat-dot").forEach(d => d.className = "beat-dot");
      const dot = document.getElementById(`dot-${step}`);
      if (dot) dot.classList.add(step === 0 ? "beat-active-red" : "beat-active-green");

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(step === 0 ? 880 : 440, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol * 0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);

      step = (step + 1) % beats;
    }, (60 / state.currentBPM) * 1000);
  }

  function stopMetro() {
    if (state.metroInt) clearInterval(state.metroInt);
    state.metroInt = null;
    const md = document.getElementById("metro-dots");
    if (md) md.innerHTML = "";
  }

  // ============ SCROLL ============
  function toggleScroll() {
    if (state.scrollInt) {
      clearInterval(state.scrollInt);
      state.scrollInt = null;
      document.getElementById("scrollBtn").innerText = "AUTO";
    } else {
      state.scrollInt = setInterval(() => window.scrollBy(0, 1), 50 / state.scrollSpeed);
      document.getElementById("scrollBtn").innerText = "PAUSA";
    }
  }

  function adjScroll(d) {
    state.scrollSpeed = Math.max(0.1, state.scrollSpeed + d);
    if (state.scrollInt) {
      clearInterval(state.scrollInt);
      state.scrollInt = setInterval(() => window.scrollBy(0, 1), 50 / state.scrollSpeed);
    }
  }

  // ============ TRANSPOSE ============
  function transpose(delta) {
    const scale = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const curr = state.setlist[state.currentIndex];
    if (!curr) return;

    curr.body = (curr.body || "").replace(/\[([^\]]+)\]/g, (m, chord) => {
      return "[" + chord.replace(/[A-G]#?/g, (note) => {
        let idx = scale.indexOf(note);
        return idx === -1 ? note : scale[(idx + delta + 12) % 12];
      }) + "]";
    });
    renderAll();
  }

  // ============ SHARE ============
  function compartirWhatsApp() {
    if (!state.listIdUnico) {
      alert("Primero guard√° el setlist para generar un c√≥digo y poder compartirlo.");
      return;
    }

    const sid = state.listIdUnico.trim().toUpperCase();
    const n = state.listName || "Setlist";
    const url = `${window.location.origin}${window.location.pathname}?sid=${encodeURIComponent(sid)}`;

    const msg =
      `üé∂ *Setlist:* ${n}\n` +
      `üîë *C√≥digo:* ${sid}\n` +
      `üîó Abrir: ${url}`;

    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
  }

  // ============ LINKS ============
  async function revisarLinkSetlistId() {
    const p = new URLSearchParams(window.location.search);
    const sid = p.get("sid");
    if (!sid || !db) return false;

    const want = sid.trim().toUpperCase();

    const { data, error } = await db
      .from("setlists_guardados")
      .select("*")
      .eq("id_unico", want)
      .single();

    if (error || !data) {
      alert("No se encontr√≥ el setlist con c√≥digo: " + want);
      console.error(error);
      return true;
    }

    state.listName = data.nombre_lista || "";
    state.listIdUnico = String(data.id_unico || "").trim().toUpperCase();

    const ids = normalizeSongIds(data.canciones_ids);
    if (!ids.length) { alert("Ese setlist no tiene canciones v√°lidas."); return true; }

    const { data: cans, error: err2 } = await db
      .from("canciones")
      .select("*")
      .in("id", ids);

    if (err2) { alert("Error cargando canciones."); console.error(err2); return true; }

    state.setlist = [];
    for (let id of ids) {
      const s = (cans || []).find(x => String(x.id) === String(id));
      if (s) await addToSetlist(s);
    }

    renderAll();
    window.history.replaceState({}, "", window.location.pathname);
    return true;
  }

  async function revisarLinkCompartido() {
    const p = new URLSearchParams(window.location.search);
    const ids = p.get("list");
    if (!ids || !db) return;

    const arr = ids.split(",").map(s => s.trim()).filter(Boolean);
    const { data, error } = await db.from("canciones").select("*").in("id", arr);
    if (error) { console.error(error); return; }

    state.listName = p.get("n") || "Compartida";
    state.listIdUnico = "";
    state.setlist = [];

    for (let id of arr) {
      const s = (data || []).find(x => String(x.id) === String(id));
      if (s) await addToSetlist(s);
    }
    window.history.replaceState({}, "", window.location.pathname);
  }

  // ============ SORT ============
  function initSortable() {
    const el = document.getElementById("setList");
    if (el && window.Sortable) {
      Sortable.create(el, {
        animation:150,
        handle:".drag-handle",
        onEnd:(evt)=>{
          const item = state.setlist.splice(evt.oldIndex, 1)[0];
          state.setlist.splice(evt.newIndex, 0, item);
          saveLocal();
          renderAll();
        }
      });
    }
  }

  // ============ STATS ============
  async function Estadisticas() {
    if (!db) { alert("Supabase no est√° listo."); return; }
    const { data, error } = await db
      .from("canciones")
      .select("titulo, veces_tocada")
      .gt("veces_tocada", 0)
      .order("veces_tocada", { ascending:false })
      .limit(5);

    if (error) { alert("Error: " + (error.message || error)); return; }
    alert("TOP 5:\n" + (data || []).map(s => `- ${s.titulo} (${s.veces_tocada})`).join("\n"));
  }

  // ============ SAVE / LOAD ============
  async function guardarListaCloud() {
    if (!db) { alert("Supabase no est√° listo."); return; }

    const ids = state.setlist.map(s => String(s.id)).filter(Boolean);
    if (!ids.length) { alert("Setlist vac√≠o."); return; }

    // UPDATE (sin prompt, solo actualiza y listo)
    if (state.listIdUnico) {
      const target = state.listIdUnico.trim().toUpperCase();
      const payload = {
        canciones_ids: ids,
        owner_id: state.userId,
        owner_name: state.username
      };

      const { error } = await db
        .from("setlists_guardados")
        .update(payload)
        .eq("id_unico", target);

      if (error) {
        alert("NO se pudo actualizar:\n" + (error.message || error));
        console.error("UPDATE error:", error);
        return;
      }

      alert("Setlist actualizado ‚úÖ\nID: " + target);
      if (document.getElementById("configPanel").style.display === "flex") listarMisSetlists();
      renderAll();
      return;
    }

    // INSERT nuevo (pide nombre)
    const n = prompt("Nombre del setlist:");
    if (!n) return;

    let idUnico = "";
    let lastErr = null;

    for (let i = 0; i < 6; i++) {
      idUnico = genSetlistId8(""); // setlist: 8 chars
      const { error } = await db.from("setlists_guardados").insert({
        nombre_lista: n,
        canciones_ids: ids,
        id_unico: idUnico,
        owner_id: state.userId,
        owner_name: state.username
      });
      if (!error) { lastErr = null; break; }
      lastErr = error;
    }

    if (lastErr) { alert("Error al guardar: " + (lastErr.message || lastErr)); return; }

    state.listName = n;
    state.listIdUnico = idUnico;
    renderAll();
    alert("Guardada ‚úÖ\nID: " + idUnico);
    if (document.getElementById("configPanel").style.display === "flex") listarMisSetlists();
  }

  async function cargarListaCloud() {
    if (!db) { alert("Supabase no est√° listo."); return; }

    const uid = prompt("Ingresa el ID del Setlist (ej: ENSAYO01):");
    if (!uid) return;

    const want = uid.trim().toUpperCase();

    const { data, error } = await db
      .from("setlists_guardados")
      .select("*")
      .eq("id_unico", want)
      .single();

    if (error || !data) {
      alert("No se encontr√≥ ning√∫n setlist con el ID: " + want);
      console.error(error);
      return;
    }

    state.listName = data.nombre_lista || "";
    state.listIdUnico = String(data.id_unico || "").trim().toUpperCase();

    const ids = normalizeSongIds(data.canciones_ids);

    if (!ids.length) {
      alert("Ese setlist no tiene canciones_ids v√°lidos.");
      console.warn("canciones_ids crudo:", data.canciones_ids);
      return;
    }

    const { data: cans, error: err2 } = await db
      .from("canciones")
      .select("*")
      .in("id", ids);

    if (err2) {
      alert("Error cargando canciones: " + (err2.message || err2));
      console.error(err2);
      return;
    }

    state.setlist = [];
    for (let id of ids) {
      const s = (cans || []).find(x => String(x.id) === String(id));
      if (s) await addToSetlist(s);
    }

    renderAll();
  }

  // ============ NAV ============
  function prevSong() {
    if (state.setlist.length === 0) return;
    if (state.currentIndex <= 0) state.currentIndex = 0;
    else state.currentIndex--;
    state.half = false;
    renderAll();
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  function nextSong() {
    if (state.setlist.length === 0) return;
    if (state.currentIndex < 0) state.currentIndex = 0;
    else if (state.currentIndex < state.setlist.length - 1) state.currentIndex++;
    state.half = false;
    renderAll();
    window.scrollTo({ top:0, behavior:"smooth" });
  }

  // Exponer globales para onclick=""
  window.setRole = setRole;
  window.openConfig = openConfig;
  window.closeConfig = closeConfig;
  window.showHome = showHome;

  window.listarMisSetlists = listarMisSetlists;
  window.copiarSetlistId = copiarSetlistId;
  window.copiarMiSetlistActual = copiarMiSetlistActual;

  window.Estadisticas = Estadisticas;

  window.guardarListaCloud = guardarListaCloud;
  window.cargarListaCloud = cargarListaCloud;
  window.clearSetlist = clearSetlist;
  window.compartirWhatsApp = compartirWhatsApp;

  window.prevSong = prevSong;
  window.nextSong = nextSong;
  window.transpose = transpose;
  window.changeFontSize = changeFontSize;
  window.toggleScroll = toggleScroll;
  window.adjScroll = adjScroll;
  window.toggleMetroManual = toggleMetroManual;
  window.halfTime = halfTime;

  window.addToSetlist = addToSetlist;
  window.seleccionar = seleccionar;
  window.removeSong = removeSong;

  // nuevos globales
  window.toggleFavByIndex = toggleFavByIndex;
  window.undoLastRemove = undoLastRemove;
</script>
</body>
</html>
