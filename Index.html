<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adoranza Pro v4.1 - Multimodal</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root {
      --bg:#0b0d12; --card:#121622; --muted:#98a2b3; --text:#e6e9ef;
      --line:#23283a; --accent:#ffd54a; --danger:#ff5c77; --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--sans); background: var(--bg); color: var(--text); overflow-x: hidden; padding-top: 160px; }
    
    /* SELECTOR DE ROL (OVERLAY) */
    #roleSelector {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: var(--bg); z-index: 10000; display: flex; 
      flex-direction: column; align-items: center; justify-content: center; gap: 30px;
    }
    .role-grid { display: flex; gap: 15px; }
    .role-btn {
      background: var(--card); border: 2px solid var(--line); padding: 20px;
      border-radius: 20px; text-align: center; font-size: 32px; cursor: pointer;
      transition: 0.3s; width: 110px; color: white;
    }
    .role-btn:hover { border-color: var(--accent); transform: translateY(-5px); }
    .role-btn small { display: block; font-size: 12px; margin-top: 8px; color: var(--muted); font-weight: bold; }

    /* PANEL FIJO */
    #fixedControlPanel { 
      position: fixed; top: 0; left: 0; right: 0; z-index: 999;
      background: rgba(11, 13, 18, 0.98); backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--line); padding: 8px 10px;
    }
    .viewer-tools { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; max-width: 500px; margin: 0 auto; }
    .tool-group { 
      display: flex; gap: 6px; justify-content: center; align-items: center; padding: 6px; 
      border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.02); 
    }

    /* BOTONES */
    .btn {
      appearance:none; border: 1px solid rgba(255, 255, 255, 0.3); 
      color: white; padding: 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; 
      font-size: 14px; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; min-width: 42px;
    }
    .btn:active { transform: scale(0.92); }
    .btn-nav { background-color: #004173 !important; }
    .btn-tone { background-color: #630b57 !important; }
    .btn-font { background-color: #2E6F40 !important; }
    .btn-scroll { background-color: #d09306 !important; }
    .btn.danger { border-color: var(--danger); color: var(--danger); min-width: 32px; padding: 5px; background: none; }

    /* METRONOMO VISUAL */
    #metro-dots { margin-top: 5px; display: flex; justify-content: center; gap: 8px; }
    .beat-dot { width: 12px; height: 12px; border-radius: 50%; background: #333; transition: 0.1s; }
    .beat-active-red { background: var(--danger); box-shadow: 0 0 10px var(--danger); }
    .beat-active-green { background: #4aff80; box-shadow: 0 0 10px #4aff80; }

    /* CONTENIDO */
    .wrap { padding: 10px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card { background: rgba(255,255,255,.02); border: 1px solid var(--line); border-radius: var(--radius); margin-bottom: 10px; }
    .card .hd { padding: 10px; border-bottom: 1px solid var(--line); font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; }
    .card .bd { padding: 10px; }

    .input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--line); background: rgba(0,0,0,.3); color: white; outline: none; }
    .item { border: 1px solid var(--line); border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; cursor: pointer; }
    
    #viewContent { 
      background: rgba(0,0,0,.4); padding: 20px; border-radius: 12px; 
      white-space: pre-wrap; font-family: var(--mono); line-height: 1.7; border: 1px solid var(--line); 
    }
    .chord { color: var(--accent); font-weight: bold; }
    #info-display { text-align: center; margin-top: 5px; }
    #current-song-info { font-weight: bold; color: var(--accent); font-size: 13px; }
  </style>
</head>
<body>

<div id="roleSelector">
    <h1 style="color:var(--accent); margin:0;">ADORANZA PRO v4.1</h1>
    <p style="color:var(--muted)">Selecciona tu funci√≥n hoy:</p>
    <div class="role-grid">
        <div class="role-btn" onclick="setRole('vocal')">üé§<small>VOCAL</small></div>
        <div class="role-btn" onclick="setRole('musico')">üé∏üéπ<small>M√öSICO</small></div>
        <div class="role-btn" onclick="setRole('drums')">ü•Å<small>BATER√çA</small></div>
    </div>
</div>

<div id="fixedControlPanel">
    <div class="viewer-tools">
      <div class="tool-group"><button class="btn btn-nav" onclick="prevSong()">‚üµ</button><button class="btn btn-nav" onclick="nextSong()">‚ü∂</button></div>
      <div class="tool-group"><button class="btn btn-tone" onclick="transpose(-1)">‚ô≠</button><button class="btn btn-tone" onclick="transpose(1)">‚ôØ</button></div>
      <div class="tool-group"><button class="btn btn-font" onclick="changeFontSize(-2)">A-</button><button class="btn btn-font" onclick="changeFontSize(2)">A+</button></div>
      <div class="tool-group"><button class="btn btn-scroll" onclick="adjScroll(-0.1)">S-</button><button class="btn btn-scroll" id="scrollBtn" onclick="toggleScroll()">‚ñ∂</button><button class="btn btn-scroll" onclick="adjScroll(0.1)">S+</button></div>
    </div>
    <div id="info-display">
      <span id="current-song-info">Selecciona una canci√≥n</span>
      <div id="metro-dots"></div>
    </div>
</div>

<main class="wrap">
  <div class="grid">
    <section class="card" id="searchCard">
      <div class="hd">Biblioteca Cloud</div>
      <div class="bd">
        <input class="input" id="searchDrive" placeholder="Buscar canci√≥n..." autocomplete="off" />
        <div id="driveResults" style="margin-top:10px; display:none; flex-direction:column; gap:8px;"></div>
      </div>
    </section>

    <section class="card" id="setlistCard">
      <div class="hd">Setlist del D√≠a <button class="btn danger" style="font-size: 10px;" onclick="clearSetlist()">Vaciar</button></div>
      <div class="bd" id="setList"></div>
    </section>

    <section class="card" style="grid-column: 1 / -1; border:none; background:none;">
      <div class="bd" id="viewerContainer">
        <pre id="viewContent">El contenido aparecer√° aqu√≠...</pre>
      </div>
    </section>
  </div>
</main>

<script>
  const API_KEY = 'AIzaSyC74SgLN0OFD8zytCktOTCyVdRZZmdL-S0';
  const FOLDER_ID = '1x6zy_Bor6i9qBhUIl27ZIG0E1qdf5Ye6';

  const state = {
    setlist: JSON.parse(localStorage.getItem('tabs_v4_setlist') || '[]'),
    allSongs: [], currentIndex: -1, currentFontSize: 18,
    scrollInt: null, scrollSpeed: 0.5, userRole: 'musico', metroInt: null
  };

  function startApp() {
    gapi.load('client', async () => {
      try {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
        const res = await gapi.client.drive.files.list({ q: `'${FOLDER_ID}' in parents and trashed = false`, fields: 'files(id, name)', orderBy: 'name' });
        state.allSongs = res.result.files || [];
        renderAll();
        initSortable();
      } catch (e) { console.error("Error cargando Drive"); }
    });
  }

  function setRole(role) {
    state.userRole = role;
    document.getElementById('roleSelector').style.display = 'none';
    renderAll();
  }

  async function importar(id, name) {
    const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`);
    const rawText = await resp.text();
    
    const meta = {};
    const cleanBody = rawText.replace(/\{(\w+):\s*([^}]+)\}/g, (m, key, val) => {
        meta[key.toLowerCase()] = val.trim();
        return "";
    }).trim();

    state.setlist.push({ 
        id: Date.now(), 
        title: meta.title || name.replace('.txt',''), 
        artist: meta.artist || "Desconocido",
        bpm: meta.bpm || "120",
        time: meta.time || "4",
        body: cleanBody 
    });
    saveLocal(); renderAll();
    document.getElementById('searchDrive').value = "";
    document.getElementById('driveResults').style.display = "none";
  }

  function renderAll() {
    const sl = document.getElementById('setList');
    sl.innerHTML = "";
    state.setlist.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'item';
      if(idx === state.currentIndex) div.style.borderColor = 'var(--accent)';
      div.innerHTML = `<div style="flex:1" onclick="seleccionar(${idx})">‚ò∞ ${s.title} <small style="color:var(--muted)">${s.artist}</small></div>
                       <button class="btn danger" onclick="removeSong(${idx}, event)">‚úï</button>`;
      sl.appendChild(div);
    });

    const curr = state.setlist[state.currentIndex];
    if(curr) {
        document.getElementById('current-song-info').innerText = `${curr.title} | ${curr.bpm} BPM | ${curr.time}/4`;
        
        let displayBody = curr.body;
        if (state.userRole === 'vocal' || state.userRole === 'drums') {
            displayBody = displayBody.replace(/\[([^\]]+)\]/g, ''); 
        } else {
            displayBody = displayBody.replace(/\[([^\]]+)\]/g, '<span class="chord">[$1]</span>');
        }

        document.getElementById('viewContent').innerHTML = displayBody;
        document.getElementById('viewContent').style.fontSize = state.currentFontSize + 'px';
        
        if (state.userRole === 'drums') iniciarMetronomo(curr.bpm, curr.time);
        else clearInterval(state.metroInt);
    }
  }

  function iniciarMetronomo(bpm, time) {
    clearInterval(state.metroInt);
    const metroContainer = document.getElementById('metro-dots');
    metroContainer.innerHTML = "";
    for(let i=0; i<time; i++) metroContainer.innerHTML += `<div class="beat-dot" id="dot-${i}"></div>`;
    
    let step = 0;
    const interval = (60 / bpm) * 1000;
    state.metroInt = setInterval(() => {
        document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('beat-active-red', 'beat-active-green'));
        const dot = document.getElementById(`dot-${step}`);
        if(dot) dot.classList.add(step === 0 ? 'beat-active-red' : 'beat-active-green');
        step = (step + 1) % time;
    }, interval);
  }

  // Funciones de utilidad se mantienen igual
  function seleccionar(idx) { state.currentIndex = idx; renderAll(); window.scrollTo({top: 0, behavior: 'smooth'}); }
  function removeSong(idx, e) { e.stopPropagation(); state.setlist.splice(idx, 1); state.currentIndex = -1; saveLocal(); renderAll(); }
  function clearSetlist() { if(confirm("¬øVaciar?")) { state.setlist = []; state.currentIndex = -1; saveLocal(); renderAll(); } }
  function saveLocal() { localStorage.setItem('tabs_v4_setlist', JSON.stringify(state.setlist)); }
  function changeFontSize(d) { state.currentFontSize += d; renderAll(); }
  function nextSong() { if(state.currentIndex < state.setlist.length-1) seleccionar(state.currentIndex+1); }
  function prevSong() { if(state.currentIndex > 0) seleccionar(state.currentIndex-1); }
  function toggleScroll() { 
    if(state.scrollInt) { clearInterval(state.scrollInt); state.scrollInt = null; document.getElementById('scrollBtn').innerText = "‚ñ∂"; }
    else { state.scrollInt = setInterval(() => window.scrollBy(0,1), 50/state.scrollSpeed); document.getElementById('scrollBtn').innerText = "‚è∏"; }
  }
  function adjScroll(d) { state.scrollSpeed = Math.max(0.1, state.scrollSpeed + d); }

  document.getElementById('searchDrive').oninput = (e) => {
    const val = e.target.value.toLowerCase();
    const resDiv = document.getElementById('driveResults');
    if (!val) { resDiv.style.display = "none"; return; }
    const filtrados = state.allSongs.filter(f => f.name.toLowerCase().includes(val));
    resDiv.style.display = "flex"; resDiv.innerHTML = "";
    filtrados.forEach(f => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<span>${f.name.replace('.txt','')}</span><button class="btn" style="color:var(--accent)" onclick="importar('${f.id}', '${f.name}')">Add</button>`;
      resDiv.appendChild(div);
    });
  };

  function initSortable() { Sortable.create(document.getElementById('setList'), { animation: 150, onEnd: () => { /* L√≥gica reordenar */ } }); }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="startApp()"></script>
</body>
</html>
